<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<html>
<main>
        <h1>Определение страны по IP-адресу</h1>
        <p>При сборе статистики посещения web-страниц часто собирается 
информация о количестве посетителей из разных стран. Как правило, страну
 определяют по домену первого уровня. Но такая информация не всегда 
соответствует действительности, особенное учитывая нынешнюю тендецию 
использовать национальные домены co, tv не по назначению. Кроме того, 
как быть с доменами общего пользования net, org, com и др.? С 
IP-адресами, для которых нет записей в реверсной зоне? Ну и, наконец, 
определение доменного имени отнимает заметное количество времени.</p>
<p>Приведенный в статье код распространяется под лицензией в стиле 
Python, то есть может быть использован для любых (в том числе 
коммерческих целей) при условии сохранения замечания об авторском праве 
Copyright © 2002, Denis S. Otkidach &lt;ods@ods.pp.ru&gt;.</p>
<p>Данные о регистрации диаппазонов IP-адресов хранятся в базах данных 
whois. Чтобы предоставить возможность общественности анализировать 
трафик, RIPE NCC, ARIN и APNIC не реже, чем раз в месяц, делают 
сокращенные "снимки" своих баз данных. Именно из этих данных мы и 
составим локальную базу.</p>
<p>Но сначала нужно эффективно оргазовать хранение данных для 
диаппазонов IP-адресов, чтобы обеспечить к ним быстрый доступ. За основу
 возмем BTree базу BerkleyDB, доступ к которой обеспечивает функция 
btopen() из стандартного модуля bsddb. В качестве ключей будем 
использовать начало диаппазона IP-адресов, а в качестве значений — его 
конец и дополнительную информацию. Ключи и значения в bsddb должны быть 
строками. Кроме того, необходимо обеспечить упорядоченность ключей. Для 
этого очень хорошо подходит функции inet_aton и inet_ntoa из модуля 
socket.</p>
<div class="prettyprint-wrap"><p style=" font-family:'Courier New,Courier,sans-serif'; background-color:#eff0f1; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><ol class="linenums"><li class="L0"><span class="kwd">from</span><span class="pln"> bsddb </span><span class="kwd">import</span><span class="pln"> btopen</span></li><li class="L1"><span class="kwd">from</span><span class="pln"> socket </span><span class="kwd">import</span><span class="pln"> inet_aton</span><span class="pun">,</span><span class="pln"> inet_ntoa</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="kwd">class</span><span class="pln"> </span><span class="typ">IPRangeDB</span><span class="pun">:</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> __init__</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> filename</span><span class="pun">,</span><span class="pln"> mode</span><span class="pun">=</span><span class="str">'r'</span><span class="pun">):</span></li><li class="L7"><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">__db </span><span class="pun">=</span><span class="pln"> btopen</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">,</span><span class="pln"> mode</span><span class="pun">)</span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> close</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></li><li class="L0"><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">__db</span><span class="pun">.</span><span class="pln">close</span><span class="pun">()</span></li><li class="L1"><span class="pln"> </span></li><li class="L2"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> _locate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> ip</span><span class="pun">):</span></li><li class="L3"><span class="pln"> db </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">__db</span></li><li class="L4"><span class="pln"> </span><span class="kwd">try</span><span class="pun">:</span></li><li class="L5"><span class="pln"> first</span><span class="pun">,</span><span class="pln"> record </span><span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">set_location</span><span class="pun">(</span><span class="pln">ip</span><span class="pun">)</span></li><li class="L6"><span class="pln"> </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">KeyError</span><span class="pun">:</span></li><li class="L7"><span class="pln"> </span><span class="kwd">try</span><span class="pun">:</span></li><li class="L8"><span class="pln"> first</span><span class="pun">,</span><span class="pln"> record </span><span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="kwd">last</span><span class="pun">()</span></li><li class="L9"><span class="pln"> </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">KeyError</span><span class="pun">:</span></li><li class="L0"><span class="pln"> </span><span class="kwd">raise</span><span class="pln"> </span><span class="typ">KeyError</span><span class="pun">(</span><span class="pln">inet_ntoa</span><span class="pun">(</span><span class="pln">ip</span><span class="pun">))</span></li><li class="L1"><span class="pln"> </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L2"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> first</span><span class="pun">!=</span><span class="pln">ip</span><span class="pun">:</span></li><li class="L3"><span class="pln"> first</span><span class="pun">,</span><span class="pln"> record </span><span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">previous</span><span class="pun">()</span></li><li class="L4"><span class="pln"> </span><span class="kwd">assert</span><span class="pln"> first</span><span class="pun">&lt;=</span><span class="pln">ip</span></li><li class="L5"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> first</span><span class="pun">,</span><span class="pln"> record</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> __getitem__</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> ip_str</span><span class="pun">):</span></li><li class="L8"><span class="pln"> ip </span><span class="pun">=</span><span class="pln"> inet_aton</span><span class="pun">(</span><span class="pln">ip_str</span><span class="pun">)</span></li><li class="L9"><span class="pln"> first</span><span class="pun">,</span><span class="pln"> record </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">_locate</span><span class="pun">(</span><span class="pln">ip</span><span class="pun">)</span></li><li class="L0"><span class="pln"> </span><span class="kwd">last</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[:</span><span class="lit">4</span><span class="pun">]</span></li><li class="L1"><span class="pln"> </span><span class="kwd">assert</span><span class="pln"> </span><span class="kwd">last</span><span class="pun">&gt;=</span><span class="pln">first</span></li><li class="L2"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> ip</span><span class="pun">&lt;=</span><span class="kwd">last</span><span class="pun">:</span></li><li class="L3"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">unpack</span><span class="pun">(</span><span class="pln">record</span><span class="pun">[</span><span class="lit">4</span><span class="pun">:])</span></li><li class="L4"><span class="pln"> </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L5"><span class="pln"> </span><span class="kwd">raise</span><span class="pln"> </span><span class="typ">KeyError</span><span class="pun">(</span><span class="pln">ip_str</span><span class="pun">)</span></li><li class="L6"><span class="pln"> </span></li><li class="L7"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">add</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> first_str</span><span class="pun">,</span><span class="pln"> last_str</span><span class="pun">,</span><span class="pln"> info</span><span class="pun">):</span></li><li class="L8"><span class="pln"> first </span><span class="pun">=</span><span class="pln"> inet_aton</span><span class="pun">(</span><span class="pln">first_str</span><span class="pun">)</span></li><li class="L9"><span class="pln"> </span><span class="kwd">last</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> inet_aton</span><span class="pun">(</span><span class="pln">last_str</span><span class="pun">)</span></li><li class="L0"><span class="pln"> </span><span class="kwd">try</span><span class="pun">:</span></li><li class="L1"><span class="pln"> db_first</span><span class="pun">,</span><span class="pln"> record </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">_locate</span><span class="pun">(</span><span class="kwd">last</span><span class="pun">)</span></li><li class="L2"><span class="pln"> </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">KeyError</span><span class="pun">:</span></li><li class="L3"><span class="pln"> </span><span class="kwd">pass</span></li><li class="L4"><span class="pln"> </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L5"><span class="pln"> db_last </span><span class="pun">=</span><span class="pln"> record</span><span class="pun">[:</span><span class="lit">4</span><span class="pun">]</span></li><li class="L6"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> first</span><span class="pun">&lt;=</span><span class="pln">db_last</span><span class="pun">:</span></li><li class="L7"><span class="pln"> </span><span class="kwd">raise</span><span class="pln"> </span><span class="typ">ValueError</span><span class="pun">(</span></li><li class="L8"><span class="pln"> </span><span class="str">'Range %s-%s intersects '</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">first_str</span><span class="pun">,</span><span class="pln"> last_str</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span></li><li class="L9"><span class="pln"> </span><span class="str">'with existing entry %s-%s'</span><span class="pln"> </span><span class="pun">%</span></li><li class="L0"><span class="pln"> </span><span class="pun">(</span><span class="pln">inet_ntoa</span><span class="pun">(</span><span class="pln">db_first</span><span class="pun">),</span><span class="pln"> inet_ntoa</span><span class="pun">(</span><span class="pln">db_last</span><span class="pun">)))</span></li><li class="L1"><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">__db</span><span class="pun">[</span><span class="pln">first</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">last</span><span class="pun">+</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pack</span><span class="pun">(</span><span class="pln">info</span><span class="pun">)</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> pack</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> info</span><span class="pun">):</span></li><li class="L4"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> info</span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> unpack</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> info</span><span class="pun">):</span></li><li class="L7"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> info</span></li></ol></p><p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; font-size:10px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></div>
<p>Метод _locate() ищет запись с максимальной нижней границей, меньшей 
или равной IP-адресу, переданному в качестве аргумента. Метод 
__getitem__() позволяет использовать экземпляры класса IPRangeDB 
аналогично словарям: db[ip] вернет информацию о диаппазоне, в который 
входит адрес ip. Использовать интерфейс словаря для записи врядли будет 
хорошей идеей, так как запись создается одна для всего диаппазона. Чтобы
 избежать путаницы, добавление записей реализовано через метод add(). И,
 наконец, пара методов pack() и unpack() определены, чтобы производный 
класс можно было легко адоптировать для хранения произвольной 
информации, метод pack() должен преобразовывать объект в строку.</p>
<div class="a69fc18d" data-region="main-content" data-finished="true"><div class="group group-A"><div class="block block-174 type-custom "><div class="field field-528">
<ins class="adsbygoogle" style="display: block; text-align: center; height: 185px;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7264282846152864" data-ad-slot="1901069998" data-adsbygoogle-status="done"><ins id="aswift_0_expand" style="display:inline-table;border:none;height:185px;margin:0;padding:0;position:relative;visibility:visible;width:740px;background-color:transparent;"><ins id="aswift_0_anchor" style="display:block;border:none;height:185px;margin:0;padding:0;position:relative;visibility:visible;width:740px;background-color:transparent;"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;width:740px;height:185px;" width="740" height="185" frameborder="0"></iframe></ins></ins></ins>
</div>
</div></div></div><div class="prettyprint-wrap"><p style=" font-family:'Courier New,Courier,sans-serif'; background-color:#eff0f1; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><ol class="linenums"><li class="L0"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> db </span><span class="pun">=</span><span class="pln"> </span><span class="typ">IPRangeDB</span><span class="pun">(</span><span class="str">'test.db'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'c'</span><span class="pun">)</span></li><li class="L1"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> db</span><span class="pun">.</span><span class="kwd">add</span><span class="pun">(</span><span class="str">'10.0.0.0'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'10.255.255.255'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Наша локальная сеть'</span><span class="pun">)</span></li><li class="L2"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="kwd">print</span><span class="pln"> db</span><span class="pun">[</span><span class="str">'10.1.2.3'</span><span class="pun">]</span></li><li class="L3"><span class="pun">Наша</span><span class="pln"> </span><span class="pun">локальная</span><span class="pln"> </span><span class="pun">сеть</span></li><li class="L4"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="kwd">print</span><span class="pln"> db</span><span class="pun">[</span><span class="str">'123.45.67.89'</span><span class="pun">]</span></li><li class="L5"><span class="typ">Traceback</span><span class="pln"> </span><span class="pun">(</span><span class="pln">most recent call </span><span class="kwd">last</span><span class="pun">):</span></li><li class="L6"><span class="pln"> </span><span class="typ">File</span><span class="pln"> </span><span class="str">"&lt;stdin&gt;"</span><span class="pun">,</span><span class="pln"> line </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> </span><span class="pun">?</span></li><li class="L7"><span class="pln"> </span><span class="typ">File</span><span class="pln"> </span><span class="str">"ip2cc.py"</span><span class="pun">,</span><span class="pln"> line </span><span class="lit">38</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> __getitem__</span></li><li class="L8"><span class="pln"> </span><span class="kwd">raise</span><span class="pln"> </span><span class="typ">KeyError</span><span class="pun">(</span><span class="pln">ip_str</span><span class="pun">)</span></li><li class="L9"><span class="typ">KeyError</span><span class="pun">:</span><span class="pln"> </span><span class="lit">123.45</span><span class="pun">.</span><span class="lit">67.89</span></li></ol></p><p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; font-size:10px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></div>
<p>Осталось дело за малым: определить методы для наполнения базы данных.</p>
<div class="prettyprint-wrap"><p style=" font-family:'Courier New,Courier,sans-serif'; background-color:#eff0f1; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><ol class="linenums"><li class="L0"><span class="kwd">from</span><span class="pln"> urllib </span><span class="kwd">import</span><span class="pln"> urlopen</span></li><li class="L1"><span class="kwd">from</span><span class="pln"> xreadlines </span><span class="kwd">import</span><span class="pln"> xreadlines</span></li><li class="L2"><span class="kwd">from</span><span class="pln"> time </span><span class="kwd">import</span><span class="pln"> strptime</span></li><li class="L3"><span class="kwd">import</span><span class="pln"> </span><span class="kwd">struct</span></li><li class="L4"><span class="pln"> </span></li><li class="L5"><span class="pln"> </span></li><li class="L6"><span class="kwd">class</span><span class="pln"> </span><span class="typ">CountryByIP</span><span class="pun">(</span><span class="typ">IPRangeDB</span><span class="pun">):</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln"> sources </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln"> </span><span class="str">'arin'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="str">'ftp://ftp.arin.net/pub/stats/arin/'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'arin.%Y%m%d'</span><span class="pun">),</span></li><li class="L0"><span class="pln"> </span><span class="str">'ripencc'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="str">'ftp://ftp.ripe.net/ripe/stats/'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'ripencc.%Y%m%d'</span><span class="pun">),</span></li><li class="L1"><span class="pln"> </span><span class="str">'apnic'</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="str">'ftp://ftp.apnic.net/pub/stats/apnic/'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'apnic-%Y-%m-%d'</span><span class="pun">)</span></li><li class="L2"><span class="pln"> </span><span class="pun">}</span></li><li class="L3"><span class="pln"> </span></li><li class="L4"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> fetch</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></li><li class="L5"><span class="pln"> </span><span class="kwd">for</span><span class="pln"> name </span><span class="kwd">in</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">sources</span><span class="pun">:</span></li><li class="L6"><span class="pln"> fp </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">__openRecent</span><span class="pun">(</span><span class="pln">name</span><span class="pun">)</span></li><li class="L7"><span class="pln"> </span></li><li class="L8"><span class="pln"> </span></li><li class="L9"><span class="pln"> </span><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> xreadlines</span><span class="pun">(</span><span class="pln">fp</span><span class="pun">):</span></li><li class="L0"><span class="pln"> parts </span><span class="pun">=</span><span class="pln"> line</span><span class="pun">.</span><span class="pln">strip</span><span class="pun">().</span><span class="pln">split</span><span class="pun">(</span><span class="str">'|'</span><span class="pun">)</span></li><li class="L1"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">parts</span><span class="pun">)==</span><span class="lit">7</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> parts</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]==</span><span class="str">'ipv4'</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> </span></li><li class="L2"><span class="pln"> parts</span><span class="pun">[</span><span class="lit">6</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> </span><span class="pun">(</span><span class="str">'allocated'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'assigned'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> </span></li><li class="L3"><span class="pln"> name</span><span class="pun">==</span><span class="pln">parts</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]:</span></li><li class="L4"><span class="pln"> first </span><span class="pun">=</span><span class="pln"> parts</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span></li><li class="L5"><span class="pln"> first_int </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">struct</span><span class="pun">.</span><span class="pln">unpack</span><span class="pun">(</span><span class="str">'!i'</span><span class="pun">,</span><span class="pln"> inet_aton</span><span class="pun">(</span><span class="pln">first</span><span class="pun">))[</span><span class="lit">0</span><span class="pun">]</span></li><li class="L6"><span class="pln"> last_int </span><span class="pun">=</span><span class="pln"> first_int</span><span class="pun">+</span><span class="kwd">int</span><span class="pun">(</span><span class="pln">parts</span><span class="pun">[</span><span class="lit">4</span><span class="pun">])-</span><span class="lit">1</span></li><li class="L7"><span class="pln"> </span><span class="kwd">last</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> inet_ntoa</span><span class="pun">(</span><span class="kwd">struct</span><span class="pun">.</span><span class="pln">pack</span><span class="pun">(</span><span class="str">'!i'</span><span class="pun">,</span><span class="pln"> last_int</span><span class="pun">))</span></li><li class="L8"><span class="pln"> </span><span class="kwd">try</span><span class="pun">:</span></li><li class="L9"><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">add</span><span class="pun">(</span><span class="pln">first</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">last</span><span class="pun">,</span><span class="pln"> parts</span><span class="pun">[</span><span class="lit">1</span><span class="pun">].</span><span class="pln">upper</span><span class="pun">())</span></li><li class="L0"><span class="pln"> </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">ValueError</span><span class="pun">:</span></li><li class="L1"><span class="pln"> </span><span class="kwd">pass</span></li><li class="L2"><span class="pln"> </span></li><li class="L3"><span class="pln"> </span><span class="kwd">def</span><span class="pln"> __openRecent</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">):</span></li><li class="L4"><span class="pln"> uri</span><span class="pun">,</span><span class="pln"> format </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">sources</span><span class="pun">[</span><span class="pln">name</span><span class="pun">]</span></li><li class="L5"><span class="pln"> files </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[]</span></li><li class="L6"><span class="pln"> </span><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> xreadlines</span><span class="pun">(</span><span class="pln">urlopen</span><span class="pun">(</span><span class="pln">uri</span><span class="pun">)):</span></li><li class="L7"><span class="pln"> file </span><span class="pun">=</span><span class="pln"> line</span><span class="pun">.</span><span class="pln">split</span><span class="pun">()[-</span><span class="lit">1</span><span class="pun">]</span></li><li class="L8"><span class="pln"> </span><span class="kwd">try</span><span class="pun">:</span></li><li class="L9"><span class="pln"> dt </span><span class="pun">=</span><span class="pln"> strptime</span><span class="pun">(</span><span class="pln">file</span><span class="pun">,</span><span class="pln"> format</span><span class="pun">)</span></li><li class="L0"><span class="pln"> </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">ValueError</span><span class="pun">:</span></li><li class="L1"><span class="pln"> </span><span class="kwd">pass</span></li><li class="L2"><span class="pln"> </span><span class="kwd">else</span><span class="pun">:</span></li><li class="L3"><span class="pln"> files</span><span class="pun">.</span><span class="pln">append</span><span class="pun">((</span><span class="pln">dt</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">))</span></li><li class="L4"><span class="pln"> files</span><span class="pun">.</span><span class="pln">sort</span><span class="pun">()</span></li><li class="L5"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> urlopen</span><span class="pun">(</span><span class="pln">uri</span><span class="pun">+</span><span class="pln">files</span><span class="pun">[-</span><span class="lit">1</span><span class="pun">][</span><span class="lit">1</span><span class="pun">])</span></li></ol></p><p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; font-size:10px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></div>
<p>Метод __openRecent находит самый свежий "снимок" и возвращает 
файловый объект. Дата "снимка" определяется по имени файла по шаблону из
 словаря источников sources. Метод fetch анализирует данные, выбирает 
необходимое и добавляет в базу. Использование модуля xreadlines 
позволяет анализировать данные по мере поступления.</p>
<p>Теперь можно наполнить базу</p>
<div class="prettyprint-wrap"><p style=" font-family:'Courier New,Courier,sans-serif'; background-color:#eff0f1; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><ol class="linenums"><li class="L0"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> db </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CountryByIP</span><span class="pun">(</span><span class="str">'test.db'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'n'</span><span class="pun">)</span></li><li class="L1"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">fetch</span><span class="pun">()</span></li></ol></p><p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; font-size:10px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></div>
<p>и использовать</p>
<div class="prettyprint-wrap"><p style=" font-family:'Courier New,Courier,sans-serif'; background-color:#eff0f1; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><ol class="linenums"><li class="L0"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> </span><span class="kwd">from</span><span class="pln"> socket </span><span class="kwd">import</span><span class="pln"> gethostbyname</span></li><li class="L1"><span class="pun">&gt;&gt;&gt;</span><span class="pln"> db</span><span class="pun">[</span><span class="pln">gethostbyname</span><span class="pun">(</span><span class="str">'python.org'</span><span class="pun">)]</span></li><li class="L2"><span class="str">'NL'</span></li></ol></p><p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; font-size:10px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></div>
<p>Преобразование кода A2 в название страны по таблице ISO3166 пусть останется вам в качестве упражнения.</p>
    </main>
</body>
</html></p></body></html>