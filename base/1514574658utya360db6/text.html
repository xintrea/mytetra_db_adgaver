<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Причиной разобраться в том, как же работает UTF-8 и что такое Юникод заставил тот факт, что VBScript не имеет встроенных функций работы с UTF-8. А так как ничего рабочего не нашел, то пришлось писать/дописывать самому. Опыт на мой взгляд полезный в любом случае. Для лучшего понимания начну с теории.<br /><br /><span style=" font-size:15px; font-weight:600;">О Юникоде</span><br /><br />До появления Юникода широко использовались 8-битные кодировки, главные минусы которых очевидны:<br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Всего 255 символов, да и то часть из них не графические;</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Возможность открыть документ не с той кодировкой, в которой он был создан;</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Шрифты необходимо создавать для каждой кодировки.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Так и было решено создать единый стандарт «широкой» кодировки, которая включала бы все символы (при чем сначала хотели в нее включить только обычные символы, но потом передумали и начали добавлять и экзотические). Юникод использует 1 112 064 кодовых позиций (больше чем 16 бит). Начало дублирует ASCII, а дальше остаток латиницы, кирилица, другие европейские и азиатские символы. Для обозначений символов используют шестнадцатеричную запись вида «U+xxxx» для первых 65k и с большим количеством цифр для остальных.<br /><br /><span style=" font-size:15px; font-weight:600;">О UTF-8</span><br /><br />Когда-то я думал что есть Юникод, а есть UTF-8. Позже я узнал, что ошибался.<br />UTF-8 является лишь представлением Юникода в 8-битном виде. Символы с кодами меньше 128 представляются одним байтом, а так как в Юникоде они повторяют ASCII, то текст написанный только этими символами будет являться текстом в ASCII. Символы же с кодами от 128 кодируются 2-мя байтами, с кодами от 2048 — 3-мя, от 65536 — 4-мя. Так можно было бы и до 6-ти байт дойти, но кодировать ими уже ничего.<br /><br />0x00000000 — 0x0000007F: 0xxxxxxx<br />0x00000080 — 0x000007FF: 110xxxxx 10xxxxxx<br />0x00000800 — 0x0000FFFF: 1110xxxx 10xxxxxx 10xxxxxx<br />0x00010000 — 0x001FFFFF: 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx<br /><br /><br /><br /><span style=" font-size:15px; font-weight:600;">Кодируем в UTF-8</span><br /><br />Порядок действий примерно такой:<br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Каждый символ превращаем в Юникод.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проверяем из какого символ диапазона.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если код символа меньше 128, то к результату добавляем его в неизменном виде.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если код символа меньше 2048, то берем последние 6 бит и первые 5 бит кода символа. К первым 5 битам добавляем 0xC0 и получаем первый байт последовательности, а к последним 6 битам добавляем 0x80 и получаем второй байт. Конкатенируем и добавляем к результату.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Похожим образом можем продолжить и для больших кодов, но если символ за пределами U+FFFF придется иметь дело с UTF-16 суррогатами. </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Код (vb.net): </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#0000ff;">Function</span> EncodeUTF8<span style=" color:#000000;">(</span>s<span style=" color:#000000;">)</span><br />    <span style=" font-weight:600; color:#0000ff;">Dim</span> i, c, utfc, b1, b2, b3<br /><br />    <span style=" font-weight:600; color:#0000ff;">For</span> i<span style=" color:#000000;">=</span><span style=" color:#a52a2a;">1</span> <span style=" font-weight:600; color:#0000ff;">to</span> Len<span style=" color:#000000;">(</span>s<span style=" color:#000000;">)</span><br />        c <span style=" color:#000000;">=</span> ToLong<span style=" color:#000000;">(</span><a href="http://www.google.com/search?q=ASCW+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">AscW</span></a><span style=" color:#000000;">(</span>Mid<span style=" color:#000000;">(</span>s,i,<span style=" color:#a52a2a;">1</span><span style=" color:#000000;">)))</span><br /> <br />        <span style=" font-weight:600; color:#0000ff;">If</span> c <span style=" color:#000000;">&lt;</span> <span style=" color:#a52a2a;">128</span> <span style=" font-weight:600; color:#0000ff;">Then</span><br />            utfc <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">chr</span></a><span style=" color:#000000;">(</span> c<span style=" color:#000000;">)</span><br />        <span style=" font-weight:600; color:#0000ff;">ElseIf</span> c <span style=" color:#000000;">&lt;</span> <span style=" color:#a52a2a;">2048</span> <span style=" font-weight:600; color:#0000ff;">Then</span><br />            b1 <span style=" color:#000000;">=</span> c <span style=" font-weight:600; color:#0000ff;">Mod</span> <span style=" color:#000000;">&amp;</span>h40<br />            b2 <span style=" color:#000000;">=</span> <span style=" color:#000000;">(</span>c <span style=" color:#000000;">-</span> b1<span style=" color:#000000;">)</span> <span style=" color:#000000;">/</span> <span style=" color:#000000;">&amp;</span>h40<br />            utfc <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">chr</span></a><span style=" color:#000000;">(&amp;</span>hC0 <span style=" color:#000000;">+</span> b2<span style=" color:#000000;">)</span> <span style=" color:#000000;">&amp;</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">chr</span></a><span style=" color:#000000;">(&amp;</span>h80 <span style=" color:#000000;">+</span> b1<span style=" color:#000000;">)</span><br />        <span style=" font-weight:600; color:#0000ff;">ElseIf</span> c <span style=" color:#000000;">&lt;</span> <span style=" color:#a52a2a;">65536</span> <span style=" font-weight:600; color:#0000ff;">And</span> <span style=" color:#000000;">(</span>c <span style=" color:#000000;">&lt;</span> <span style=" color:#a52a2a;">55296</span> <span style=" font-weight:600; color:#0000ff;">Or</span> c <span style=" color:#000000;">&gt;</span> <span style=" color:#a52a2a;">57343</span><span style=" color:#000000;">)</span> <span style=" font-weight:600; color:#0000ff;">Then</span><br />            b1 <span style=" color:#000000;">=</span> c <span style=" font-weight:600; color:#0000ff;">Mod</span> <span style=" color:#000000;">&amp;</span>h40<br />            b2 <span style=" color:#000000;">=</span> <span style=" color:#000000;">((</span>c <span style=" color:#000000;">-</span> b1<span style=" color:#000000;">)</span> <span style=" color:#000000;">/</span> <span style=" color:#000000;">&amp;</span>h40<span style=" color:#000000;">)</span> <span style=" font-weight:600; color:#0000ff;">Mod</span> <span style=" color:#000000;">&amp;</span>h40<br />            b3 <span style=" color:#000000;">=</span> <span style=" color:#000000;">(</span>c <span style=" color:#000000;">-</span> b1 <span style=" color:#000000;">-</span> <span style=" color:#000000;">(&amp;</span>h40 <span style=" color:#000000;">*</span> b2<span style=" color:#000000;">))</span> <span style=" color:#000000;">/</span> <span style=" color:#000000;">&amp;</span>h1000<br />            utfc <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">chr</span></a><span style=" color:#000000;">(&amp;</span>hE0 <span style=" color:#000000;">+</span> b3<span style=" color:#000000;">)</span> <span style=" color:#000000;">&amp;</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">chr</span></a><span style=" color:#000000;">(&amp;</span>h80 <span style=" color:#000000;">+</span> b2<span style=" color:#000000;">)</span> <span style=" color:#000000;">&amp;</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">chr</span></a><span style=" color:#000000;">(&amp;</span>h80 <span style=" color:#000000;">+</span> b1<span style=" color:#000000;">)</span><br />        <span style=" font-weight:600; color:#0000ff;">Else</span><br />            <span style=" font-style:italic; color:#008000;">' Младший или старший суррогат UTF-16</span><br />            utfc <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">Chr</span></a><span style=" color:#000000;">(&amp;</span>hEF<span style=" color:#000000;">)</span> <span style=" color:#000000;">&amp;</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">Chr</span></a><span style=" color:#000000;">(&amp;</span>hBF<span style=" color:#000000;">)</span> <span style=" color:#000000;">&amp;</span> <a href="http://www.google.com/search?q=CHR+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">Chr</span></a><span style=" color:#000000;">(&amp;</span>hBD<span style=" color:#000000;">)</span><br />        <span style=" font-weight:600; color:#0000ff;">End</span> <span style=" font-weight:600; color:#0000ff;">If</span><br /> <br />        EncodeUTF8 <span style=" color:#000000;">=</span> EncodeUTF8 <span style=" color:#000000;">+</span> utfc<br />    <span style=" font-weight:600; color:#0000ff;">Next</span><br /><span style=" font-weight:600; color:#0000ff;">End</span> <span style=" font-weight:600; color:#0000ff;">Function</span><br /><br /><span style=" font-weight:600; color:#0000ff;">Function</span> ToLong<span style=" color:#000000;">(</span>intVal<span style=" color:#000000;">)</span><br />    <span style=" font-weight:600; color:#0000ff;">If</span> intVal <span style=" color:#000000;">&lt;</span> <span style=" color:#a52a2a;">0</span> <span style=" font-weight:600; color:#0000ff;">Then</span><br />        ToLong <span style=" color:#000000;">=</span> <span style=" color:#cd6a5a;">CLng</span><span style=" color:#000000;">(</span>intVal<span style=" color:#000000;">)</span> <span style=" color:#000000;">+</span> <span style=" color:#000000;">&amp;</span>H10000<br />    <span style=" font-weight:600; color:#0000ff;">Else</span><br />        ToLong <span style=" color:#000000;">=</span> <span style=" color:#cd6a5a;">CLng</span><span style=" color:#000000;">(</span>intVal<span style=" color:#000000;">)</span><br />    <span style=" font-weight:600; color:#0000ff;">End</span> <span style=" font-weight:600; color:#0000ff;">If</span><br /><span style=" font-weight:600; color:#0000ff;">End</span> <span style=" font-weight:600; color:#0000ff;">Function</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><br /><br /><span style=" font-size:15px; font-weight:600;">Декодируем UTF-8</span><br /><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ищем первый символ вида 11xxxxxx</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Считаем все последующие байты вида 10xxxxxx</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если последовательность из двух байт и первый байт вида 110xxxxx, то отсекаем приставки и складываем, умножив первый байт на 0x40.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Аналогично для более длинных последовательностей.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заменяем всю последовательность на нужный символ Юникода. </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Код (vb.net): </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#0000ff;">Function</span> DecodeUTF8<span style=" color:#000000;">(</span>s<span style=" color:#000000;">)</span><br />    <span style=" font-weight:600; color:#0000ff;">Dim</span> i, c, n, b1, b2, b3<br /> <br />    i <span style=" color:#000000;">=</span> <span style=" color:#a52a2a;">1</span><br />        <span style=" font-weight:600; color:#0000ff;">Do</span> <span style=" font-weight:600; color:#0000ff;">While</span> i <span style=" color:#000000;">&lt;=</span> len<span style=" color:#000000;">(</span>s<span style=" color:#000000;">)</span><br />            c <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=ASC+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">asc</span></a><span style=" color:#000000;">(</span>mid<span style=" color:#000000;">(</span>s,i,<span style=" color:#a52a2a;">1</span><span style=" color:#000000;">))</span><br />            <span style=" font-weight:600; color:#0000ff;">If</span> <span style=" color:#000000;">(</span>c <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>hC0<span style=" color:#000000;">)</span> <span style=" color:#000000;">=</span> <span style=" color:#000000;">&amp;</span>hC0 <span style=" font-weight:600; color:#0000ff;">Then</span><br />                n <span style=" color:#000000;">=</span> <span style=" color:#a52a2a;">1</span><br />                <span style=" font-weight:600; color:#0000ff;">Do</span> <span style=" font-weight:600; color:#0000ff;">While</span> i <span style=" color:#000000;">+</span> n <span style=" color:#000000;">&lt;=</span> len<span style=" color:#000000;">(</span>s<span style=" color:#000000;">)</span><br />                    <span style=" font-weight:600; color:#0000ff;">If</span> <span style=" color:#000000;">(</span><a href="http://www.google.com/search?q=ASC+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">asc</span></a><span style=" color:#000000;">(</span>mid<span style=" color:#000000;">(</span>s,i<span style=" color:#000000;">+</span>n,<span style=" color:#a52a2a;">1</span><span style=" color:#000000;">))</span> <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>hC0<span style=" color:#000000;">)</span> <span style=" color:#000000;">&lt;&gt;</span> <span style=" color:#000000;">&amp;</span>h80 <span style=" font-weight:600; color:#0000ff;">Then</span><br />                        <span style=" font-weight:600; color:#0000ff;">Exit</span> <span style=" font-weight:600; color:#0000ff;">Do</span><br />                    <span style=" font-weight:600; color:#0000ff;">End</span> <span style=" font-weight:600; color:#0000ff;">If</span><br />                    n <span style=" color:#000000;">=</span> n <span style=" color:#000000;">+</span> <span style=" color:#a52a2a;">1</span><br />                <span style=" font-weight:600; color:#0000ff;">Loop</span><br />                <span style=" font-weight:600; color:#0000ff;">If</span> n <span style=" color:#000000;">=</span> <span style=" color:#a52a2a;">2</span> <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">((</span>c <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>hE0<span style=" color:#000000;">)</span> <span style=" color:#000000;">=</span> <span style=" color:#000000;">&amp;</span>hC0<span style=" color:#000000;">)</span> <span style=" font-weight:600; color:#0000ff;">Then</span><br />                    b1 <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=ASC+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">asc</span></a><span style=" color:#000000;">(</span>mid<span style=" color:#000000;">(</span>s,i<span style=" color:#000000;">+</span><span style=" color:#a52a2a;">1</span>,<span style=" color:#a52a2a;">1</span><span style=" color:#000000;">))</span> <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>h3F<br />                    b2 <span style=" color:#000000;">=</span> c <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>h1F<br />                    c <span style=" color:#000000;">=</span> b1 <span style=" color:#000000;">+</span> b2 <span style=" color:#000000;">*</span> <span style=" color:#000000;">&amp;</span>h40<br />                <span style=" font-weight:600; color:#0000ff;">Elseif</span> n <span style=" color:#000000;">=</span> <span style=" color:#a52a2a;">3</span> <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">((</span>c <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>hF0<span style=" color:#000000;">)</span> <span style=" color:#000000;">=</span> <span style=" color:#000000;">&amp;</span>hE0<span style=" color:#000000;">)</span> <span style=" font-weight:600; color:#0000ff;">Then</span><br />                    b1 <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=ASC+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">asc</span></a><span style=" color:#000000;">(</span>mid<span style=" color:#000000;">(</span>s,i<span style=" color:#000000;">+</span><span style=" color:#a52a2a;">2</span>,<span style=" color:#a52a2a;">1</span><span style=" color:#000000;">))</span> <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>h3F<br />                    b2 <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=ASC+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">asc</span></a><span style=" color:#000000;">(</span>mid<span style=" color:#000000;">(</span>s,i<span style=" color:#000000;">+</span><span style=" color:#a52a2a;">1</span>,<span style=" color:#a52a2a;">1</span><span style=" color:#000000;">))</span> <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>h3F<br />                    b3 <span style=" color:#000000;">=</span> c <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>h0F<br />                    c <span style=" color:#000000;">=</span> b3 <span style=" color:#000000;">*</span> <span style=" color:#000000;">&amp;</span>H1000 <span style=" color:#000000;">+</span> b2 <span style=" color:#000000;">*</span> <span style=" color:#000000;">&amp;</span>H40 <span style=" color:#000000;">+</span> b1<br />                <span style=" font-weight:600; color:#0000ff;">Else</span><br />                    <span style=" font-style:italic; color:#008000;">' Символ больше U+FFFF или неправильная последовательность</span><br />                    c <span style=" color:#000000;">=</span> <span style=" color:#000000;">&amp;</span>hFFFD<br />                <span style=" font-weight:600; color:#0000ff;">End</span> <span style=" font-weight:600; color:#0000ff;">if</span><br />                s <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=LEFT+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">left</span></a><span style=" color:#000000;">(</span>s,i<span style=" color:#000000;">-</span><span style=" color:#a52a2a;">1</span><span style=" color:#000000;">)</span> <span style=" color:#000000;">+</span> <a href="http://www.google.com/search?q=CHRW+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">chrw</span></a><span style=" color:#000000;">(</span> c<span style=" color:#000000;">)</span> <span style=" color:#000000;">+</span> mid<span style=" color:#000000;">(</span>s,i<span style=" color:#000000;">+</span>n<span style=" color:#000000;">)</span><br />            <span style=" font-weight:600; color:#0000ff;">Elseif</span> <span style=" color:#000000;">(</span>c <span style=" font-weight:600; color:#0000ff;">and</span> <span style=" color:#000000;">&amp;</span>hC0<span style=" color:#000000;">)</span> <span style=" color:#000000;">=</span> <span style=" color:#000000;">&amp;</span>h80 <span style=" font-weight:600; color:#0000ff;">then</span><br />                <span style=" font-style:italic; color:#008000;">' Неожидаемый продолжающий байт</span><br />                s <span style=" color:#000000;">=</span> <a href="http://www.google.com/search?q=LEFT+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">left</span></a><span style=" color:#000000;">(</span>s,i<span style=" color:#000000;">-</span><span style=" color:#a52a2a;">1</span><span style=" color:#000000;">)</span> <span style=" color:#000000;">+</span> <a href="http://www.google.com/search?q=CHRW+site:msdn.microsoft.com"><span style=" text-decoration: underline; color:#000066;">chrw</span></a><span style=" color:#000000;">(&amp;</span>hFFFD<span style=" color:#000000;">)</span> <span style=" color:#000000;">+</span> mid<span style=" color:#000000;">(</span>s,i<span style=" color:#000000;">+</span><span style=" color:#a52a2a;">1</span><span style=" color:#000000;">)</span><br />            <span style=" font-weight:600; color:#0000ff;">End</span> <span style=" font-weight:600; color:#0000ff;">If</span><br />            i <span style=" color:#000000;">=</span> i <span style=" color:#000000;">+</span> <span style=" color:#a52a2a;">1</span><br />        <span style=" font-weight:600; color:#0000ff;">Loop</span><br />    DecodeUTF8 <span style=" color:#000000;">=</span> s<br /><span style=" font-weight:600; color:#0000ff;">End</span> <span style=" font-weight:600; color:#0000ff;">Function</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />По теме:<br /><a href="https://ru.wikipedia.org/wiki/%D0%AE%D0%BD%D0%B8%D0%BA%D0%BE%D0%B4"><span style=" text-decoration: underline; color:#0000ff;">Юникод на Википедии</span></a><br /><br /><a href="https://habrahabr.ru/post/138173/"><span style=" text-decoration: underline; color:#0000ff;">Источник</span></a> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Если честно я тоже первый раз знакомлюсь с этой темой </span><img src="image11487.png" /><span style=" font-size:8.25pt;"><br />Попробую объяснить.<br /><br /></span><a href="https://safezone.cc/members/5381/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Koza Nozdri</span></a><span style=" font-size:8.25pt;">, первые два числа это просто диапазон (в 16-ричной системе счисления).<br />В 10-чной смотри ниже мою таблицу.<br /><br />Кол-во лидирующих единичек (до цифры 0) показывает кол-во битов, которыми кодируется символ (исключение: 1 байт, где первым идет сразу 0):<br /><br />0......... - 1 байт<br />110...... - 2 байта<br />1110.... - 3 байта и т.д. :<br /><br />Чтобы узнать, сколько писать таких единичек,<br />нужно узнать ASCII-код кодируемого символа, и посмотреть колонку № 1 таблицы:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="DataTable_5a4691c12ceda_wrapper"></a><span style=" font-size:8.25pt;">О</span><span style=" font-size:8.25pt;">тфильтровать: </span></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0"><thead>
<tr>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Ищем диапазон, которому принадлежит ASCII-код кодируемого символа</span></p></td>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Сколько байт будет занимать 1 символ в кодированном виде</span></p></td>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Битовая запись кодированного символа</span></p></td>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Кол-во значащих битов</span></p></td>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Описание</span></p></td></tr></thead>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">0 — 127</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">1 байт</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">0aaa aaaa</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">7</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">ASCII, в том числе латинский алфавит, простейшие знаки препинания и арабские цифры</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">128 — 2047</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">2 байта</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">110x xxxx 10xx xxxx</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">11</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">кириллица, расширенная латиница, арабский, армянский, греческий, еврейский и коптский алфавит; сирийское письмо, тана, нко; МФА; некоторые знаки препинания</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">2048 — 65535</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">3 байта</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">1110 xxxx 10xx xxxx 10xx xxxx</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">16</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">кириллица, расширенная латиница, арабский, армянский, греческий, еврейский и коптский алфавит; сирийское письмо, тана, нко; МФА; некоторые знаки препинания</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">65536 — 2097151</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">4 байта</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">1111 0xxx 10xx xxxx 10xx xxxx 10xx xxxx</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">21</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">музыкальные символы, редкие китайские иероглифы, вымершие формы письменности</span></p></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Не используется</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">5 байт</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">1111 10xx 10xx xxxx 10xx xxxx 10xx xxxx 10xx xxxx</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">26</span></p></td>
<td></td></tr>
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Не используется</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">6 байт</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">1111 110x 10xx xxxx 10xx xxxx 10xx xxxx 10xx xxxx 10xx xxxx</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">31</span></p></td>
<td></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="DataTable_5a4691c12ceda_info"></a><span style=" font-size:8.25pt;">S</span><span style=" font-size:8.25pt;">howing 1 to 6 of 6 entries <br />где x - это значащие биты.<br /><br />Например, ты берешь символ </span><span style=" font-size:8.25pt; font-weight:600; color:#ff0000;">+</span><span style=" font-size:8.25pt;">. Вспоминаем </span><a href="http://www.dpva.info/Guide/GuideMathematics/GuideMathematicsNumericalSystems/TableCodeEquivalent/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">таблицу ASCII-кодов</span></a><span style=" font-size:8.25pt;">.<br />Его код = </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image31366.png" /><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Мы ведь уже научились переводить 10 (Dec) -&gt; 2 (Bin) с помощью калькулятора Windows (вид &quot;Программист&quot;) ? <br /><br />Все это - значащие биты (2-чное представление ASCII-кода кодируемого символа).<br /><br />Ищем диапазон по таблице. Нашли: 0 &lt;= </span><span style=" font-size:8.25pt; font-weight:600;">43</span><span style=" font-size:8.25pt;"> &lt;= 127.<br />Значит в кодированном виде будет занимать 1 байт. Смотрим правило (выше по таблице).<br />Первый бит будет = 0. Остальные просто переносим (не забывая дописать лидирующий значащий 0, чтобы получить полный байт (все 8 бит):<br />0</span><span style=" font-size:8.25pt; font-weight:600;">0101011</span><span style=" font-size:8.25pt;"><br />+ дописываем BOM (идентификатор, того что дальше идет кодировка UTF-8)<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image13916.png" /><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br />Итого:<br /></span><span style=" font-size:8.25pt; color:#0000ff;">1110 1111 1011 1011 1011 1111</span><span style=" font-size:8.25pt;"> 0</span><span style=" font-size:8.25pt; font-weight:600;">010 1011</span><span style=" font-size:8.25pt;"> - это и будет символ </span><span style=" font-size:8.25pt; font-weight:600; color:#ff0000;">+</span><span style=" font-size:8.25pt;"> в кодировке UTF-8.<br /><br />Кстати, сам BOM - это тоже закодированное в UTF-8 значение </span><span style=" font-size:8.25pt; font-weight:600;">FF FE</span><span style=" font-size:8.25pt;"> (по сути 2-байтовый символ с ASCII-кодом 65534, который в закодированном виде занимает 3 байта).<br />______________________<br />Теперь давай закодируем символ авторских прав ©.<br />ASCII код =<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image5481.png" /><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"><br /><br />Входит в диапазон по таблице. Нашли: 128 &lt;= 169 &lt;= 2047. А значит кодируется уже в 2 байта.<br />Кодированный шаблон такой:<br /></span><span style=" font-size:8.25pt; font-weight:600; color:#ff0000;">110</span><span style=" font-size:8.25pt; font-weight:600;">x xxxx</span><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt; font-weight:600; color:#ff0000;">10</span><span style=" font-size:8.25pt; font-weight:600;">xx xxxx</span><span style=" font-size:8.25pt;"><br /><br />Подставляем в шаблон вместо иксов 2-чное представление ASCII-кода символа (справа налево):<br /></span><span style=" font-size:8.25pt; font-weight:600; color:#ff0000;">110</span><span style=" font-size:8.25pt; font-weight:600; color:#8000ff;">0 00</span><span style=" font-size:8.25pt; font-weight:600; color:#00b359;">10</span><span style=" font-size:8.25pt; font-weight:600;"> </span><span style=" font-size:8.25pt; font-weight:600; color:#ff0000;">10</span><span style=" font-size:8.25pt; font-weight:600; color:#00b300;">10 1001<br /></span><span style=" font-size:8.25pt;"><br />не забываем дописать три нуля, чтобы завершить байт.<br />Дописываем BOM и получаем:<br /></span><span style=" font-size:8.25pt; color:#0000ff;">1110 1111 1011 1011 1011 1111</span><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt; color:#ff0000;">110</span><span style=" font-size:8.25pt; color:#8000ff;">0 00</span><span style=" font-size:8.25pt; color:#00b300;">10</span><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt; color:#ff0000;">10</span><span style=" font-size:8.25pt; color:#00b300;">10 1001</span><span style=" font-size:8.25pt;"><br /><br />Можно проверить результат в редакторе Notepad++ или AkelPad,<br />создав символ сначала в кодировке Windows-1251, а затем сохранив как UTF-8 с BOM.<br />Затем открыть любым HEX-редактором в 2-чном представлении. </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>