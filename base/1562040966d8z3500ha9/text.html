<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Очень часто мы сталкиваемся с ситуацией, когда макросы выполняются очень медленно, и требуется повысить быстродействие выполнения процедур на VBA.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Можно отметить два способа повышения производительности: ленивый и трудоемкий.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Ленивый способ</span> заключается в добавлении в начале кода процедуры двух строчек и в конце кода еще двух строчек. Для этого мы будем манипулировать двумя свойствами объекта Application: ScreenUpdating и Calculation. Сначала мы отключим прорисовку экрана и автовычисление, а в конце включим обратно.</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Sub</span><span style=" font-family:'Courier New';"> Test</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">   Application.ScreenUpdating = </span><span style=" font-family:'Courier New'; color:#0000ff;">False</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">   Application.Calculation = xlCalculationManual</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">      </span><span style=" font-family:'Courier New'; color:#008000;">'&lt;код процедуры&gt;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">   Application.Calculation = xlCalculationAutomatic</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">   Application.ScreenUpdating = </span><span style=" font-family:'Courier New'; color:#0000ff;">True</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">End Sub</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Зачастую это позволяет существенно повысить быстродействие макросов.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Трудоемкий способ.</span> Но иногда требуется повысить быстродействие выполнения макросов на несколько порядков. Это ситуации, когда требуется выполнять код за милисекунды (тысячные доли секунд) или обрабатывать большие объемы данных – миллион строк за пару минут. В таком случае придется полностью переписывать код процедуры. Чтобы не заниматься переделками надо изначально построить код процедуры следуя советам.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Совет 1. Объекты – самое медленное звено</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">VBA очень медленно обрабатывает объекты. Поэтому стараемся использовать как можно меньше объектов. А если мы используем объект в коде, то минимизируем количество обращений к нему.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Наиболее типичная ситуация обращение к ячейкам. Если код обращается к сотне ячеек, то это работает быстро, но когда счет идет на сотни тысяч ячеек, то быстродействие падает катастрофически.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример кода</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">For</span><span style=" font-family:'Courier New';"> i = 1 </span><span style=" font-family:'Courier New'; color:#0000ff;">To</span><span style=" font-family:'Courier New';"> 1000000</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">   Cells(i, 1).Value = 1</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Next</span><span style=" font-family:'Courier New';"> i</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Оптимизируем код</p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">Range(Cells(1,1), Cells(1000000,1)).Value = 1</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Данный код сработает значительно быстрее, т.к. в первом случае мы миллион раз обращались к объектам – ячейкам, в последнем случае, обращаемся только к трем объектам (диапазон – range и две ячейки cells).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Даже если в коде предполагается обращение к объекту два раза или более, то советую считывать значения свойства объекта в отдельную переменную.</p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">tmpValue = Cells(1, 1).Value</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">и в дальнейшем в коде процедуры обращаться к переменной tmpValue.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Совет 2. Ипсользование переменных и массивов</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Собственно второй совет, является следствие первого совета. Поэтому работу кода процедуры надо разделить на три этапа.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Первый – считываем данные из ячеек в массивы или переменные.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Второй – производим необходимую обработку с переменными и массивами.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Третий – записываем полученные значения в ячейки.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обработка единичных значений ячеек с помощью переменной</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> TmpValue </span><span style=" font-family:'Courier New'; color:#008000;">'Объявляем переменную</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">tmpValue = Cells(1, 1).Value </span><span style=" font-family:'Courier New'; color:#008000;">'Считываем значение</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#008000;">'&lt;Код обработки переменных&gt;</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">Cells(2, 2).Value = tmpValue </span><span style=" font-family:'Courier New'; color:#008000;">'Записываем значение</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обработка диапазона ячеек с помощью массива. По сути диапазон ячеек представляет собой двумерный массив.</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> tmpDynamicArray() </span><span style=" font-family:'Courier New'; color:#008000;">'Динамический массив</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> ngTable = Range(Cells(1, 1), Cells(10, 5))</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">tmpDynamicArray() = ngTable1.Value</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если мы заранее не знаем размеры исходного диапазона, то считать значения можно в динамический массив.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если мы будем считывать значения в статичный массив, то надо предусмотреть, чтобы размеры массива и диапазона соответствовали друг другу.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обращение к переменным или перебор значений массива происходит значительно быстрее, чем ячейкам. Особенно это заметно на больших объемах.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы записать значения в диапазон из двумерного массива, надо указать диапазон, соответствующий исходному массиву.</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">RowsCount = </span><span style=" font-family:'Courier New'; color:#0000ff;">Ubound</span><span style=" font-family:'Courier New';">(tmpDynamicArray,1) - </span><span style=" font-family:'Courier New'; color:#0000ff;">Ubound</span><span style=" font-family:'Courier New';">(tmpDynamicArray,1)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">ColumnsColumns = </span><span style=" font-family:'Courier New'; color:#0000ff;">Ubound</span><span style=" font-family:'Courier New';">(tmpDynamicArray,2) - </span><span style=" font-family:'Courier New'; color:#0000ff;">Ubound</span><span style=" font-family:'Courier New';">(tmpDynamicArray,2)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">FirstRow=1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">FirstColumn=1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">LastRow = FirstRow + RowsCount</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">LastColumn = First Column+ ColumnsCount</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">Range(Cells(FirstRow, FirstColumn), Cells(LastRow, LastColumn)).Value = tmpDynamicArray</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Совет 3. Циклы</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перебор объектов коллекций объектов с помощью цикла</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">For</span><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">each</span><span style=" font-family:'Courier New';"> ... </span><span style=" font-family:'Courier New'; color:#0000ff;">in</span><span style=" font-family:'Courier New';"> ...</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Next</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Работает значительно быстрее цикла</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">For</span><span style=" font-family:'Courier New';"> i = ... </span><span style=" font-family:'Courier New'; color:#0000ff;">To</span><span style=" font-family:'Courier New';"> ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Next</span><span style=" font-family:'Courier New';"> i</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Совет 4. Быстрый объект Dictionary</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Все таки среди объектов VBA есть одно исключение – объект Dictionary.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обращение к данному объекту происходит значительно быстро.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Совет 5. Подключение к внешним источникам данных</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Использование запросов к внешним базам данных также занимает значительное время. Поэтому старайтесь по возможности, реже считывать и подключаться к внешним базам данных. Желательно, чтобы SQL-запрос сразу возвращал нужные данные.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Совет 6. Логика алгоритма</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Конечно, старайтесь оптимизировать логику алгоритма. </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="item1"></a>© Тимур Пустогачев 2016 </p></body></html>