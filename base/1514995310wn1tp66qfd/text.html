<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">имя листа формулой</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задача: записать в отдельной ячейке или внутри формулы имя текущего листа(т.е. того, в котором сама функция).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В принципе это очень легко сделать простейшей <a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-funkciya-polzovatelyaudf/"><span style=" text-decoration: underline; color:#0000ff;">функцией пользователя</span></a>: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce7aaea184898123142"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">--------------------------------------------------------------------------------------- ' Procedure : GetShName ' DateTime : 04.03.2015 10:44 ' Author : The_Prist(Щербаков Дмитрий) ' http://www.excel-vba.ru ' Purpose : Функция возвращает в ячейку имя листа ' rCell - Необязательный аргумент. ' Если указан - функция вернет имя листа, на котором расположена эта ячейка ' Если не указан - функция вернет имя листа, в котором записана функция '--------------------------------------------------------------------------------------- Function GetShName(Optional rCell As Range) If Not rCell Is Nothing Then GetShName = rCell.Parent.Name Else GetShName = Application.Caller.Parent.Name End If End Function</span><span style=" font-size:12px;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:12px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:12px;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">9</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">10</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">11</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">12</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">13</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">14</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">15</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">16</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">17 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce7aaea184898123142-1"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">---------------------------------------------------------------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-2"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;"> Procedure : GetShName</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-3"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;"> DateTime  : 04.03.2015 10:44</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-4"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;"> Author    : The_Prist(Щербаков Дмитрий)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-5"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">             http://www.excel-vba.ru</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-6"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;"> Purpose   : Функция возвращает в ячейку имя листа</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-7"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">             rCell - Необязательный аргумент.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-8"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">                     Если указан - функция вернет имя листа, на котором расположена эта ячейка</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-9"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">                     Если не указан - функция вернет имя листа, в котором записана функция</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-10"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">---------------------------------------------------------------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-11"></a><span style=" font-size:12px;">F</span><span style=" font-size:12px;">unction</span><span style=" font-size:12px;"> GetShName(Optional rCell As Range)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-12"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">If Not rCell Is Nothing Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-13"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">GetShName = rCell.Parent.Name</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-14"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-15"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">GetShName = Application.Caller.Parent.Name</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-16"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7aaea184898123142-17"></a><span style=" font-size:12px;">E</span><span style=" font-size:12px;">nd</span><span style=" font-size:12px;"> Function</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Синтаксис:<br />получение имени листа, в котором записана функция:<br />=GetShName()<br />получение имени листа, в котором расположена указанная ячейка<br />=GetShName(A1) - данная запись равнозначна записи без ячейки, т.к. ячейка все равно в пределах листа с самой функцией<br />=GetShName(Лист2!A1)</p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Но бывают случаи, когда использование макросов весьма нежелательно. Тогда можно воспользоваться чуть более громоздкой и менее понятной формулой:<br />=ПСТР(ЯЧЕЙКА(&quot;filename&quot;;A2);ПОИСК(&quot;]&quot;;ЯЧЕЙКА(&quot;filename&quot;;A2))+1;31)<br />=MID(CELL(&quot;filename&quot;,A2),SEARCH(&quot;]&quot;,CELL(&quot;filename&quot;,A2))+1,31)<br />Однако эта формула вернет точно такой же результат, как функция пользователя выше и макросы совершенно не нужны.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь разберем эту формулу поподробнее<br />Самая основная часть - ЯЧЕЙКА(&quot;filename&quot;;A2). Функция <span style=" font-weight:600;">ЯЧЕЙКА (CELL)</span> с записанным первым аргументом &quot;filename&quot; возвращает полный путь к книге, включая имя листа и адрес ячейки, в которой записана функция:<br />C:\Users\Дмитрий\Desktop\[Tips_All_GetShName.xls]Лист1<br />Т.к. нам нужно только имя листа - мы применяем <span style=" font-weight:600;">ПСТР (MID)</span>, которая возвращает часть текста, начиная с указанной позиции символа. <span style=" font-weight:600;">ПОИСК (SEARCH)</span> ищет нам именно эту позицию - позицию символа &quot;]&quot;.<br />Если по шагам просмотреть этапы работы формулы, то будет нечто вроде:<br />=ПСТР(ЯЧЕЙКА(&quot;filename&quot;;A2);ПОИСК(&quot;]&quot;;ЯЧЕЙКА(&quot;filename&quot;;A2))+1;31)<br />Шаг1 =&gt;<br />=ПСТР(ЯЧЕЙКА(&quot;filename&quot;;A2);ПОИСК(&quot;]&quot;;C:\Users\Дмитрий\Desktop\[Tips_All_GetShName.xls]Лист1)+1;31)<br />Шаг2 =&gt;<br />=ПСТР(ЯЧЕЙКА(&quot;filename&quot;;A2);49+1;31)<br />Шаг3 =&gt;<br />=ПСТР(C:\Users\Дмитрий\Desktop\[Tips_All_GetShName.xls]Лист1;50;31)<br />Шаг4 =&gt;<br />=Лист1<br /><span style=" font-weight:600;">Первый момент:</span> почему применяю цифру 31 последним аргументом ПСТР? По факту, там необходимо указывать точное количество символов, но если указать больше - то будут взяты все символы от указанного и до последнего. Т.е можно было бы указать и 99, но 31 - это максимальное количество символов, которое можно использовать в имени листа.<br /><span style=" font-weight:600;">Второй момент:</span> первым аргументом функции ЯЧЕЙКА указывается текст, обозначающий тип сведений. В русской локализации он доступен на русском - &quot;имяфайла&quot;. Однако при открытии файла с этой функцией в другой локализации тип сведений не будет переведен и функция не сможет работать. Поэтому я указываю на английском, т.к. он является универсальным в данном случае и будет работать в любой локализации. Однако нет никакой ошибки, если указать на русском: ЯЧЕЙКА(&quot;имяфайла&quot;;A2)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вторым аргументом функции ЯЧЕЙКА ничего не указывать(=ЯЧЕЙКА(&quot;filename&quot;)), то функция вернет полный путь с именем того листа, который активен в данный момент(даже если это лист другой книги).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для чего вообще может быть нужно записывать имя листа в ячейку? Ну, например, если имя листа периодически меняется, а в своих формулах вы используете функции вроде ДВССЫЛ со ссылкой на этот лист. Либо для создания более наглядного оглавления через <a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-giperssylka/"><span style=" text-decoration: underline; color:#0000ff;">гиперссылки</span></a>.</p>
<hr />
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Кто-то уже явно догадался, что подобным же образом можно получить не только имя листа - но и имя книги:<br />=ПСТР(ЯЧЕЙКА(&quot;filename&quot;);ПОИСК(&quot;[&quot;;ЯЧЕЙКА(&quot;filename&quot;))+1;ПОИСК(&quot;]&quot;;ЯЧЕЙКА(&quot;filename&quot;))-ПОИСК(&quot;[&quot;;ЯЧЕЙКА(&quot;filename&quot;))-1)<br />так же как и для имени листа - можно указать ячейку из другой книги и тогда формула вернет имя той книги, из которой указана ячейка.<br />Если ячейка не указана - функция вернет имя активной в данный момент книги.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Так же можно получить полный путь к книге и имя книги(без квадратных скобок и имени листа):<br />=ПОДСТАВИТЬ(ПСТР(ЯЧЕЙКА(&quot;filename&quot;;A1);1;ПОИСК(&quot;]&quot;;ЯЧЕЙКА(&quot;filename&quot;;A1))-1);&quot;[&quot;;&quot;&quot;)</p></body></html>