<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="ucoz-forum-post-47210"></a><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Я</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;"> бы сделал, например, так - на DAO (исполняется в Excel): <br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:9pt; color:#6a1009;">Sub fromExcelToAccess()<br />    Dim dbe As Object 'DAO.DBEngine<br />    Dim db  As Object 'DAO.Database<br />    Dim rst As Object 'DAO.Recordset<br />    Dim i As Long<br />        <br />    Set dbe = CreateObject(&quot;DAO.DBEngine.120&quot;)<br />    Set db = dbe.OpenDatabase(&quot;C:\...\file.accdb&quot;)<br />    Set rst = db.TableDefs(&quot;ИмяТаблицы&quot;).OpenRecordset<br />        <br />    For i = 1 To 10 'цикл по записям Excel<br />        rst.AddNew<br />            rst(&quot;Поле1&quot;).Value = &quot;первое поле из Excel&quot;<br />            rst(&quot;Поле2&quot;).Value = &quot;второе поле из Excel&quot;<br />            rst(&quot;Поле3&quot;).Value = &quot;третье поле из Excel&quot;<br />        rst.Update<br />    Next<br />        <br />End Sub</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Можно и на более модерновом ADO, но DAO мне исторически ближе. И меньше буковок получается в плане &quot;строки подключения&quot; <br /><br />Для файлов c расширением mdb можно использовать Set dbe = CreateObject(&quot;DAO.DBEngine.36&quot;). Это по поводу универсальности.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:11pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="ucoz-forum-post-47211"></a><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Н</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">е в чистом виде универсально, в силу ограничений провайдеров данных (не может Jet работать с xls? при Access mdb, ACE тут все яднее). </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:9pt; color:#6a1009;">Public Sub AddNew()<br />    'Если хотя бы один из файлов 2007-2010, то<br />    'Const sConn As String = &quot;Provider=Microsoft.ACE.OLEDB.12.0;Mode=Share Deny None;Data Source=c:\sap\db.accdb&quot;<br />    Const sConn As String = &quot;Provider=Microsoft.Jet.OLEDB.4.0;;Mode=Share Deny None;Data Source=c:\sap\db.mdb&quot;<br />    Dim AddSQL As String<br />    Dim pConn As Object, AddRSet As Object, TableRSet As Object<br />    Set pConn = CreateObject(&quot;ADODB.Connection&quot;): pConn.Open sConn<br />    'Поменять на Excel 12.0 для версий файлов 2007-2010 (путь и имя файла с импортируемыми в Access значениями)<br />    AddSQL = &quot;Select t1.[Дата],t1.[Название],t1.[Данные] From [Excel 8.0;DATABASE=c:\SAP\book1.xls;HDR=YES].[Sheet1$] As t1&quot;<br />    'Заменить TableName на название таблицы в Access<br />    AddSQL = AddSQL &amp; &quot; Left Join TableName As t2 On ((t1.[Дата]=t2.[Дата]) And (t1.[Название]=t2.[Название]) And (t1.[Данные]=t2.[Данные]))&quot;<br />    AddSQL = AddSQL &amp; &quot; Where t2.[Дата] Is Null&quot;<br />    Set AddRSet = CreateObject(&quot;ADODB.Recordset&quot;): AddRSet.CursorLocation = 3<br />    AddRSet.Open AddSQL, pConn, 3, 1<br />    If AddRSet.RecordCount = 0 Then<br />        MsgBox &quot;Нет новых записей&quot;<br />    Else<br />        Set TableRSet = CreateObject(&quot;ADODB.Recordset&quot;): TableRSet.CursorLocation = 3<br />        'Заменить TableName на название таблицы в Access<br />        TableRSet.Open &quot;Select [Дата],[Название],[Данные] From TableName Where [Дата] Is Null&quot;, pConn, 3, 3<br />        Do Until AddRSet.EOF<br />            TableRSet.AddNew<br />            TableRSet(&quot;Дата&quot;).Value = AddRSet(&quot;Дата&quot;).Value<br />            TableRSet(&quot;Название&quot;).Value = AddRSet(&quot;Название&quot;).Value<br />            TableRSet(&quot;Данные&quot;).Value = AddRSet(&quot;Данные&quot;).Value<br />            AddRSet.MoveNext<br />        Loop<br />        TableRSet.Update<br />        TableRSet.Close<br />    End If<br />    AddRSet.Close: pConn.Close<br />End Sub</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; font-size:9pt; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Начал с кода Константина, потому что его код визуально меньше <br /><br /></span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Подправил с учётом расположений файлов, получилось так: <br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:8pt; color:#6a1009;">Sub fromExcelToAccess()<br />    Dim dbe As Object 'DAO.DBEngine<br />    Dim db  As Object 'DAO.Database<br />    Dim rst As Object 'DAO.Recordset<br />    Dim i As Long<br />        <br />    Set dbe = CreateObject(&quot;DAO.DBEngine.120&quot;)<br />    Set db = dbe.OpenDatabase(&quot;C:\...\Test.accdb&quot;)<br />    Set rst = db.TableDefs(&quot;Таблица1&quot;).OpenRecordset<br />        <br />    For i = 1 To Range(&quot;A&quot; &amp; Cells.Rows.Count).End(xlUp).Row - 1<br />            rst.AddNew<br />            rst(&quot;Поле1&quot;).Value = Range(&quot;a&quot; &amp; 1 + i).Value<br />            rst(&quot;Поле2&quot;).Value = Range(&quot;b&quot; &amp; 1 + i).Value<br />            rst(&quot;Поле3&quot;).Value = Range(&quot;c&quot; &amp; 1 + i).Value<br />        rst.Update<br />    Next<br />        <br />End Sub</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br /><br />Код работает правильно, но позволяет заливать одинаковые данные сколько угодно раз. Как этого избежать?</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:11pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Сделать поле1 и поле2 в Access ключевыми </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:11pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">ну и в коде надо будет еще Update обернуть обработкой ошибки: </span><span style=" font-family:'Courier New,courier'; font-size:11pt;"><br /></span><span style=" font-family:'FreeMono'; font-size:9pt; color:#6a1009;">    On Error Resume Next<br />    rst.Update<br />    On Error GoTo 0</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br />Я так обычно делаю, а кто-то в начале процедуры пишет только первый оператор.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:11pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Например, такой перебор записей набора с учетом фильтра (WHERE): <br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:9pt; color:#6a1009;">Sub traverseRecordset()<br />    Dim dbe As Object 'DAO.DBEngine<br />    Dim db  As Object 'DAO.Database<br />    Dim rst As Object 'DAO.Recordset<br />        <br />    Set dbe = CreateObject(&quot;DAO.DBEngine.120&quot;)<br />    Set db = dbe.OpenDatabase(&quot;C:\...\file.accdb&quot;)<br />    Set rst = db.OpenRecordset(&quot;SELECT * FROM Таблица1 WHERE 1=1&quot;)<br />        <br />    Do While Not rst.EOF 'цикл по записям<br />    <br />        'бла-бла-бла: что-то делаем с очередной записью<br />        'например, &quot;трогаем&quot; значение первого поля<br />        Debug.Print rst.Fields(0).Value<br />        <br />        rst.MoveNext<br />    Loop<br />        <br />End Sub</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; font-size:9pt; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="ucoz-forum-post-47342"></a><span style=" font-family:'DejaVu Sans'; font-size:7pt; font-weight:600;">Ц</span><span style=" font-family:'DejaVu Sans'; font-size:7pt; font-weight:600;">итата</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Я думал что можно как-то сверять данные на листе и данные в БД блоком</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br />В виде SQL запроса можно, как вариант к версии, выбирающий записи в таблице и листе по совпадению трёх полей <br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:11pt;"><br /></span><span style=" font-family:'FreeMono'; font-size:9pt; color:#6a1009;">    ExistsSQL = &quot;Select t1.[Дата],t1.[Название],t1.[Данные] From [Excel 8.0;DATABASE=c:\SAP\book1.xls;HDR=YES].[Sheet1$] As t1&quot;<br />    ExistsSQL = ExistsSQL &amp; &quot; Inner Join TableName As t2 On ((t1.[Дата]=t2.[Дата]) And (t1.[Название]=t2.[Название]) And (t1.[Данные]=t2.[Данные]))&quot;<br />    Set ExistsRSet = CreateObject(&quot;ADODB.Recordset&quot;): ExistsRSet.CursorLocation = 3<br />    ExistsRSet.Open ExistsSQL, pConn, 3, 1<br />    If ExistsRSet.RecordCount &gt; 0 Then<br />        Set pSheet = ActiveWorkbook.Worksheets<br />        pSheet.Range(&quot;A1:C1&quot;).Value = Array(&quot;Дата&quot;, &quot;Название&quot;, &quot;Данные&quot;)<br />        pSheet.Range(&quot;A2&quot;).CopyFromRecordset ExistsRSet<br />        MsgBox &quot;Создан лист дубликатов&quot;<br />    End If<br />    ExistsRSet.Close</span><span style=" font-family:'Courier New,courier'; font-size:11pt;"><br /></span><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br />Собственно, почти тоже самое используется в запросе на добавление AddSQL для отбора с листа записей, которые по всем трём полям не совпадают с существующими в таблице. <br /><br />По поводу первичного ключа. У вас же товар приходит по какой-то накладной или нечто подобное. Её и можно добавить в качестве элемента ключа: дата, название, накладная. <br />Или вариант: дата, название, время ввода в таблицу. <br />Или некоторое строковое значение - код ввода, получаемое как запрос к FileSystemObject.GetTempName: дата, название, кодВвода <br /></span><span style=" font-family:'Courier New,courier'; font-size:11pt;"><br /></span><span style=" font-family:'FreeMono'; font-size:9pt; color:#6a1009;">Public Function GetPKey()<br />    Dim fso As Object, sKey As String<br />    Set fso = CreateObject(&quot;Scripting.FileSystemObject&quot;)<br />    sKey = fso.GetTempName<br />    GetPKey = Mid$(sKey, 1, Len(sKey) - 4)<br />End Function<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="ucoz-forum-post-47360"></a><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Х</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">очу обратить внимание, что метод CopyFromRecordset объекта Range работает и в случае DAO (а не только ADO): <br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:7pt; font-weight:600;">Цитата</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Excel Developer Reference <br />Range.CopyFromRecordset Method <br />Copies the contents of an ADO or DAO Recordset object onto a worksheet, beginning at the upper-left corner of the specified range.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br /><br />Поэтому можно отобранные аксессные строки выгрузить на лист Excel: <br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:9pt; color:#6a1009;">Sub fromRecordset()<br /><br />    Dim dbe As Object 'DAO.DBEngine<br />    Dim db  As Object 'DAO.Database<br />    Dim rst As Object 'DAO.Recordset<br />        <br />    Set dbe = CreateObject(&quot;DAO.DBEngine.120&quot;)<br />    Set db  = dbe.OpenDatabase(&quot;C:\...\file.accdb&quot;)<br />    Set rst = db.OpenRecordset(&quot;SELECT * FROM Таблица1 WHERE 1=1&quot;)<br />    Range(&quot;A1&quot;).CopyFromRecordset rst          <br />        <br />End Sub</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br />А потом просто операцией присваивания передать диапазон выгрузки в массив VBA - ну, а дальше уже, как говорится, дело техники и фантазии.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br /></span></p></body></html>