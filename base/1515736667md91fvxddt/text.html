<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="pagetitle"></a><a href="http://forum.developing.ru/showthread.php/11979-VBA.-Копирование-со-структурой-папок?s=a8cd94aa52b157018d3eb5856bc00fbf"><span style=" text-decoration: underline; color:#0000ff;">V</span></a>BA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вид для печати</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style="" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_1"></a>25.11.2007 05:03Avsha </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">Приветствую,<br /><br />Уже отчаялся найти в Windows команду для копирования папки со структурой (с путем) до корневого диска.<br />Например, есть структура папок:<br />C:\Programs\Files\Path_01<br />C:\Programs\Files\Path_02<br />C:\Programs\Files\Path_03<br />C:\Programs\Files\Path_04<br />и т.д.<br /><br />Необходимо скопировать папку Path_02 на сменный носитель K с cохранением всей структуры папок:<br />K:\Programs\Files\Path_02<br /><br />Как это сделать в VBA или Windows?</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_2"></a>25.11.2007 09:30bi-lya </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">Avsha, такие два варианта (в любом случае получаем полный путь и отметаем &quot;С:\&quot; )<br />1. копируем всю папку Programs со всеми вложенными папками и файлами и потом удалять лишнее. IMHO - неудобный, нужно перебирать все файлы в директории, не говоря о том, что размер Programs может быть и не маленьким<br />2. на К:\ последовательно создаем структуру согласно разбитого по &quot;\&quot; пути (если неизвестна структура изначально) и уже в нее копируем нужный файл<br />Что-то вроде того по 2-му[CODE]Public Sub MakeStructure()<br />Dim fs As FileSystemObject<br />Dim foldCr As Folder<br /><br />Set fs = CreateObject(&quot;Scripting.FileSystemObject&quot;)<br /><br />fpath = &quot;C:\proba_1\proba_2\Проба.xls&quot; 'получаем путь<br /><br />f = Split(fpath, &quot;\&quot;)<br /><br />newFpath = &quot;d:\&quot;<br /><br />For a = 1 To UBound(f) - 1<br />Set foldCr = fs.CreateFolder(newFpath &amp; f(a))<br />newFpath = newFpath &amp; f(a) &amp; &quot;\&quot;<br />Next<br /><br />fs.CopyFile fpath, newFpath<br /><br />Set fs = Nothing<br />Set foldCr = Nothing<br />End Sub<br />[/CODE]</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_3"></a>25.11.2007 11:47bi-lya </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">Oops...<br />Разговор-то про папки, а не файл<br />Но смысл тот же, я думаю, только используем .CopyFolder</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_4"></a>25.11.2007 12:20Aent </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[b]Avsha[/b], Есть стандартная команда [b]xcopy[/b]. Набираем xcopy /? и читаем:<br />[quote]<br />.............<br />/T Создает структуру папок, но не копирует файлы. Не поддерживает<br />пустые папки и подпапки. Сочетание /T /E<br />поддерживает пустые папки и подпапки.<br />.............<br />[/quote]<br />Как вызвать из VBA полагаю Вам объяснять не нужно.</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_5"></a>25.11.2007 20:42Avsha </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[B]bi-lya[/B], спасибо за отклик<br /><br />Нашел вариант ручного копирования:<br /><br />1. Открываем (заходим) в папку, где лежат наши исходные файлы<br />2. Выделить исходный путь в строке &quot;Адрес&quot; и копируем в подручный блокнот<br />С:\Programs\Files\Path_01<br />3. Меняем диск С на диск К и приписываем еще команду md<br />md K:\Programs\Files\Path_01 (забираем в буфер)<br />4. Пуск\Выполнить\cmd<br />5. Вставка из буфера команды на создание структуры папок.<br />6. Копирование исходных файлов в полученную структуру папок.<br /><br />надеюсь, что это все можно сделать автоматически с помощью bat-файла, <br />который будет предварительно копироваться в исходную папку <br />(немного подправляться по необходимости) и просто запускаться.<br /><br />Думаю, можно этот вариант будет сделать и в виде exe-шника на VB, <br />используя CurDir, MkDir, FileCopy и задавая один лишь аргумент - Имя буквы диска назначения(K).<br /><br /><br />to [B]Aent[/B],<br />ключи от xcopy честно и упорно проверял, но использовать у меня их не вышло.<br />Может вы подскажете, что не так.<br />мой неработающий вариант следующий ...<br />[B]xcopy С:\Programs\Files\Path_01\ K:\ /T /E[/B]</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_6"></a>25.11.2007 21:39Aent </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[quote=&quot;Avsha&quot;]мой неработающий вариант следующий ...<br />xcopy С:\Programs\Files\Path_01\ K:\ /T /E[/quote]<br />Вы неверно указали путь.<br />Кстати, cначала нужно создать на диске K необходимую целевую папку.<br />Далее код на VBA<br />[code]<br />Sub test()<br />Dim rc As Long<br />MkDir &quot;k:\Path_01&quot;<br />rc = Shell(&quot;c:\Windows\System32\xcopy.exe &quot;&quot;C:\Program Files\Path01&quot;&quot; k:\Path_01 /T /E&quot;, 0)<br />End Sub<br />[/code]<br />Не забывайте, что если параметр командной строки содержит пробел, его нужно заключать в кавычки.<br />В нашем случае (т.к. Shell передаётся командная строка) - кавычки должны удваиваться.<br />Разумеется, всё легко параметризуется.</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_7"></a>26.11.2007 09:59Avsha </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">Aent ,<br />что-то ничего у меня не работает ни в VBA, ни в cmd.<br /><br />А у вас xcopy с ключами /T /E в оболочке cmd работает?</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_8"></a>26.11.2007 11:31Aent </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[quote=&quot;Avsha&quot;]А у вас xcopy с ключами /T /E в оболочке cmd работает?[/quote]<br />Да. Никаких проблем. И из VBA и из командной строки. Только что проверил.<br />Windows XP SP2<br />А что у Вас происходит после команды ?</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_9"></a>26.11.2007 12:36Avsha </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">Исходные папки<br />-----------------------<br />C:\Programs\Files\Path_01<br />E:\Path_01<br /><br />cmd...<br />xcopy C:\Programs\Files\Path_01 E:\Path_01 /T /E<br />xcopy C:\Programs\Files\Path_01 E: /T /E<br />- ничего не сообщает, просто опять выводит приглашение ввода C:\&gt;<br /><br />если не затруднит, приведите пожалуйста вариант вашей команды xcopy в cmd.</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_10"></a>26.11.2007 17:49Aent </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[b]Avsha[/b], возможно я не совсем понял что Вам нужно.<br />Приведённая вами команда Xcopy <br />[b]xcopy C:\Programs\Files\Path_01 E:\Path_01 /T /E[/b]<br />копирует структуру папок (в том числе пустых), являющихся подпапками<br />C:\Programs\Files\Path_01, предполагая что E:\Path_01 уже существует<br />Т.е на диске E: в папке Path_01 будет восоздана структура подпапок одноимённой<br />папки с диска C:<br />Сообщений Xcopy принормальной работе не выдаёт.<br /><br />Это же (c немного другими именами) делает и мой пример на VBA <br /><br />Если вам нужно на диске E: восоздавать полный путь от корня<br />(E:\Programs\Files\Path_01) - это другой вопрос.</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_11"></a>27.11.2007 17:42Игорь Акопян </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">добавлю что ключ /I создаст папку Path_01 если её не существует.<br /><br />ещё команда [B]FOR[/B] была довольно занятна... а вообще наверное батник придётся стартовать</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_12"></a>28.11.2007 01:11Aent </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[url]https://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/xcopy.mspx?mfr=true[/url]</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_13"></a>28.11.2007 14:45Игорь Акопян </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[b]Aent[/b], xcopy хорош, но он сделает каталоги вложенные в заданный первым параметром. <br />/S для рекурсии забыли</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_14"></a>29.11.2007 00:03Aent </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[quote=&quot;Игорь Акопян&quot;]он сделает каталоги вложенные в заданный первым параметром. <br />/S для рекурсии забыли[/quote]<br />??? Поясните, что Вы имеете в виду ? <br />/T /E - копируется [b]всё[/b] дерево подпапок. Отнюдь не только первый уровень.</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_15"></a>03.12.2007 12:21Игорь Акопян </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">упс... про /S погорячился... это я перепробывался ключей :)<br />основной тон сообщения заключался в неприменимости xcopy для задачи топикстартера.</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_16"></a>03.12.2007 19:41Aent </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[quote=&quot;Игорь Акопян&quot;]основной тон сообщения заключался в неприменимости xcopy для задачи топикстартера.[/quote]<br />Непонятно почему. Вложенные каталоги переносятся с любым разумным уровнем вложенности. <br />Или [b]Avsha[/b], я всё таки неправильно понял Вашу постановку задачи ?</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_17"></a>03.12.2007 21:42Avsha </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">to Aent,<br />xcopy копирует весь пучек вложенных папок<br />C:\Program\Path_01<br />C:\Program\Path_02<br />C:\Program\Path_03 и т.д.<br /><br />А мне требуется скопировать только [b]одну ветку с сохранением пути до корня[/b], например <br />C:\Program\Path_02 на <br />K:\Program\Path_02<br /><br />А этого xcopy сделать не сможет, она построит весь пучек \Path_01, \Path_02, \Path_03<br />:(<br /><br />Ну да ладно, считаю вопрос закрытым<br />ручная команда <br />md K:\Program\Path_02<br />- мне уже достаточно помогла :)</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_18"></a>04.12.2007 00:07Aent </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">[b]Avsha[/b], ну так ровно это я и предлагал<br />[code=VB]<br />Sub CopyPath(sSourcePath as string)<br />Dim rc As Long<br />Dim sTargetPath as string<br />sTargetPath = &quot;k:\&quot; &amp; Mid$(sSourcePath,4)<br />MkDir sTargetPath<br />rc = Shell(&quot;c:\Windows\System32\xcopy.exe &quot;&quot;&quot; &amp; sSourcePath &amp; &quot;&quot;&quot; &quot;&quot;&quot; &amp; sTargetPath &amp; &quot;&quot;&quot; /T /E&quot;, 0)<br />End Sub<br />[/code]<br />Впрочем, я всё время предполагаю, что исходные папки Path_xx cодержат подпапки...<br />Если это не так то конечно достаточно VBA команды MkDir. Вызов CMD (md) в этом<br />случае не нужен.<br />Впрочем, закроем тему :)</p>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_19"></a>04.12.2007 13:57Avsha </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">Re: VBA. Копирование со структурой папок</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:1; text-indent:0px;">Вот, вот, вот - <br />xcopy не хочет свою работу выполнять, а MkDir за нее отдувается :)</p></body></html>