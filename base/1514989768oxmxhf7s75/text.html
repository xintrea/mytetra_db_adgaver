<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как получить последннюю заполненную ячейку формулой?<span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Очень часто при работе с большими таблицами возникает вопрос: как узнать последнюю заполненную ячейку в столбце? Обычно это необходимо для того, чтобы суммировать или вычислять среднее только в пределах заданной таблицы, без учета пустых строк, т.к. в случае с вычислением среднего пустые строки могут повлиять на расчеты. По сути способов не так много. Я в этой статье покажу два варианта: в первом формула проще для понимания, но менее универсальна в использовании - она требует точно знать данные какого типа хранятся в столбце: числа или текст, т.к. ориентируется исключительно на тип данных. Вторая формула более универсальна, но может дольше работать.<br />Формула ниже по сути будет отбирать только числа и вернет номер самой нижней строки, в которой расположено любое число, даже если это нуль:<br />=ПОИСКПОЗ(3E+307;</span><span style=" font-size:8.25pt; color:#0000ff;">A1:A100</span><span style=" font-size:8.25pt;">)<br />=MATCH(3E+307,A1:A100)<br />А эта формула вернет номер строки с последней ячейкой, в которой записан любой текст<br />=ПОИСКПОЗ(&quot;яяя&quot;;</span><span style=" font-size:8.25pt; color:#0000ff;">A1:A100</span><span style=" font-size:8.25pt;">)<br />=MATCH(&quot;яяя&quot;,A1:A100)<br />Принцип работы этих формул основан на последнем аргументе функции ПОИСКПОЗ - интервальный просмотр. Если его не указывать, то принимается значения по умолчанию для этого аргумента. По умолчанию он равен 1, что означает искать наибольшее значение, которое меньше или равно искомому. Для &quot;правильной&quot; работы с этим параметром справка Excel рекомендует отсортировать по возрастанию массив значений, в которых осуществляется поиск искомого значения. Но в нашем случае сортировка как раз не нужна. Происходит следующее: в случае с числом мы задает максимально возможное число(3E+307), которого заведомо в искомых значениях быть не может. ПОИСКПОЗ сверяет каждое значение с этим числом. Определяет, что значение в массиве меньше искомого(но не равно ему!) и запоминает его позицию. Но т.к. ПОИСКПОЗ стремится найти самый подходящий вариант - то просматривает значения дальше, предполагая, что массив отсортирован по возрастанию и дальше пойдут значения ЕЩЕ БОЛЬШЕ предыдущего и там возможно есть значение, равное искомому. Но наш массив не отсортирован и значения там расположены абы как. Да и значения там все меньше указанного. В результате ПОИСКПОЗ доходит до последнего числа в указанном массиве и возвращает именно его позицию, т.к. дальше искать нечего и ПОИСКПОЗ считает, что это максимально подходящее число. Опять же потому, что считает, что значения у нас отсортированы.<br />Тоже самое и с текстом, только тут мы задаем текст &quot;яяя&quot;, который в бинарной сетке будет в самом нижу, т.к. буква &quot;я&quot; имеет самый большой числовой код. А три этих буквы подряд дают по сути &quot;самый большой текст&quot;.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Но чаще всего как раз заранее неизвестно, какие именно данные будут в ячейках: текстовые или числовые. Т.е. по факту в столбце могут быть абсолютно любые данные. В таких случаях можно применить один из следующих вариантов формулы:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">=МАКС(ПОИСКПОЗ({&quot;яяя&quot;;3E+307};A1:A100))<br />=MAX(MATCH({&quot;яяя&quot;,3E+307},A1:A100))</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">=ПРОСМОТР(2;1/(A1:A100&lt;&gt;&quot;&quot;);СТРОКА(A1:A100))<br />=LOOKUP(2,1/(A1:A100&lt;&gt;&quot;&quot;),ROW(A1:A100))</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Первая формула вводится как </span><a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-formula-massiva/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">формула массива</span></a><span style=" font-size:8.25pt;">(ввод формулы в ячейку завершается нажатием не просто Enter, а сочетанием клавиш </span><span style=" font-size:8.25pt; font-weight:600;">Ctrl</span><span style=" font-size:8.25pt;">+</span><span style=" font-size:8.25pt; font-weight:600;">Shift</span><span style=" font-size:8.25pt;">+</span><span style=" font-size:8.25pt; font-weight:600;">Enter</span><span style=" font-size:8.25pt;">). Но есть и еще один недостаток: если в столбце нет какого-либо типа данных - формула вернет </span><span style=" font-size:8.25pt; font-weight:600;">#Н/Д</span><span style=" font-size:8.25pt;">. Обхитрить можно, если захватить в расчет заголовок, в котором будет текст или число, в зависимости от того, какие данные предположительно могут отсутствовать. Или сделать двойной заголовок - в одном число, в другом текст. Основной принцип работы ПОИСКПОЗ в данном случае описан выше. Могу лишь добавить, что ввод её как формулу массива заставляет формулу искать как позицию самого дальнего числа, так и позицию самого дальнего текста. А функция МАКС(MAX) отбирает из найденных двух позиций максимальное значение.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Вторая формула вводится в ячейку обычным методом и вроде как не имеет никаких подводных камней. Кроме одного: не стоит указывать в качестве диапазона ВЕСЬ СТОЛБЕЦ с данными - формула может очень долго пересчитываться. Особенно это сказывается в файлах версии 2007 Excel, где строк больше миллиона. Предыдущие формулы лишены этого недостатка. Хотя я в любом случае советовал бы указывать явно диапазон &quot;с запасом&quot;.<br />Принцип её работы похож на ПОИСКПОЗ с небольшими дополнениями:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">A1:A100&lt;&gt;&quot;&quot; - здесь идет сравнение каждого значения в указанном диапазоне и если ячейка не пустая - возвращается ИСТИНА(TRUE).</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">1/(A1:A100&lt;&gt;&quot;&quot;) - здесь единица делится на полученные значения ИСТИНА(TRUE). Звучит как бред, но. Для Excel ИСТИНА это 1, а ЛОЖЬ - 0. Таким образом мы получаем массив значений 1 и #ДЕЛ/0(#DIV/0). Т.е. максимальное число в массиве у нас - 1. А принцип работы функции ПРОСМОТР(LOOKUP) очень похож на ПОИСКПОЗ, только она всегда стремиться найти наибольшее подходящее значение, меньшее или равное искомому. А в качестве искомого мы задаем 2, т.е. оно заведомо больше любого значения в массиве для поиска: =ПРОСМОТР(2;1/(A1:A100&lt;&gt;&quot;&quot;)</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Таким образом ПРОСМОТР всегда будет нам возвращать позицию последней заполненной ячейки. Последний аргумент функции ПРОСМОТР - массив, равный по размеру просматриваемому(A1:A100), из которого будет возвращено значение. Мы задаем в качестве этого массива значений для возврата массив номеров строк: СТРОКА(A1:A100). Т.е. если в массиве A1:A100 последнее значение будет в ячейке A9, то ПРОСМОТР вернет значение для СТРОКА(A9).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Как видно, недостатки есть в любой из приведенных формул, так что выбор в любом случае за Вами и зависеть он будет напрямую от поставленной задачи. </span></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Вот один из примеров, как можно применить определение последней ячейки в реальных формулах. Например, вычисление среднего значения:<br />=СРЗНАЧ(A2:ИНДЕКС(A1:A100;ПОИСКПОЗ(9E+307;A1:A100)))<br />Числовые данные начинаются с ячейки A2. В A1 заголовок, а где заканчиваются данные неизвестно - они постоянно изменяются: удаляются, дополняются.<br />В данном случае мы первой ячейкой указываем A2 - начало числовых данных. А вот далее уже идет вычисление последней ячейки:<br />ПОИСКПОЗ(9E+307;A1:A100)<br />В данном случае можно применить поиск последней ячейки именно с числом, т.к. </span><span style=" font-size:8.25pt; font-weight:600;">СРЗНАЧ(AVERAGE)</span><span style=" font-size:8.25pt;"> в любом случае игнорирует текст и лишние ячейки нам ни к чему. </span><span style=" font-size:8.25pt; font-weight:600;">ПОИСКПОЗ(MATCH)</span><span style=" font-size:8.25pt;"> возвращает номер последней ячейки в диапазоне A1:A100. Но чтобы получить именно ссылку на эту ячейку, а не просто её строку мы используем </span><span style=" font-size:8.25pt; font-weight:600;">ИНДЕКС(INDEX)</span><span style=" font-size:8.25pt;">:<br />ИНДЕКС(A1:A100;ПОИСКПОЗ(9E+307;A1:A100))<br />Т.е. по шагам формулу можно представить так:<br />=СРЗНАЧ(A2:ИНДЕКС(A1:A100;ПОИСКПОЗ(9E+307;A1:A100))) =&gt;<br />=СРЗНАЧ(A2:ИНДЕКС(A1:A100;9)) =&gt;<br />=СРЗНАЧ(A2:A9) =&gt;<br /></span><span style=" font-size:8.25pt; font-weight:600;">4,5</span><span style=" font-size:8.25pt;"><br /></span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">В приложенном к теме примере записаны все приведенные формулы, а так же пара примеров того, как эти формулы можно использовать в других формулах для определения конца диапазона.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Скачать пример </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image20211.png" /><span style=" font-size:8.25pt;">  </span><a href="http://www.excel-vba.ru/download/20/"><span style=" font-size:8.25pt; font-weight:600; text-decoration: underline; color:#0000ff;">Tips_General_Last_Cell_Formula.xls</span></a><span style=" font-size:8.25pt;"> (38,5 KiB, 2 246 скачиваний)</span></p></body></html>