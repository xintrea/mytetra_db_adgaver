<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="ucoz-forum-post-183004"></a>На днях участник <span style=" font-weight:600;">Djubocco</span> сетовал в соседней теме <a href="http://www.excelworld.ru/forum/17-4539-182810-16-1460047613"><span style=" text-decoration: underline; color:#0000ff;">http://www.excelworld.ru/forum/17-4539-182810-16-1460047613</span></a> , что его процедура перемещает 50 тыс. строк из Excel в Access за дикое количество времени, кажется, 167 минут?<br /><br />Я не успел откликнуться, а тема уже оказалось закрытой... А товарищ Djubocco чего-то замолчал... Но мой альтруистический порыв оказался сильнее - надо ж выручить человека! - поэтому сам возобновлю разговор.<br /><br />Использование библиотеки ADO в данном случае не очень удачный выбор. В Access существуют собственные, гораздо более эффективные средства экспорта/импорта.<br /><br />Вот код, исполняемый в Access, которым я сегодня за 2 минуты &quot;всосал&quot; xlsx-файл размером 18 мегайт, содержащий 400 тыс.строк х 11 столбцов:<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">Sub fastImport()<br />    Access.Application.DoCmd.TransferSpreadsheet acImport, acSpreadsheetTypeExcel12, &quot;Лист1&quot;, &quot;C:\...\...\MyFile.xlsx&quot;, True<br />End Sub</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#04056a;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">&quot;Access.Application&quot; указываю, чтобы было понятно, к чему привязываться, если код будет запускаться извне (из Excel или еще откуда). Внутри Access достаточно начать этот оператор с &quot;DoCmd&quot;.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#04056a;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">У меня аналогичный пример 12 столбцов, 400000 строк, вес файла Excel 33 мегабайта плюс вставка данных в существующую таблицу занял порядка 97 секунд. Office 2016, 64bit.<br />Но. И с ADODB не всё так плохо, кодом из Excel вставилось тоже самое в существующую таблицу в Access за 301 секунду<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">Public Sub InsertToTable()<br />    Const lastRow = 400000, lastCol = 12<br />    Dim pCon As New ADODB.Connection, pRSet As New ADODB.Recordset, vData As Variant<br />    Dim k As Long, t As Single, i As Long<br />    t = Timer: k = 0<br />    pCon.CursorLocation = adUseClient<br />    pCon.Open &quot;DBQ=c:\Projects\Database2 min.accdb;Driver={Microsoft Access Driver (*.mdb, *.accdb)};DriverId=25;FIL=MS Access;MaxBufferSize=2048;PageTimeout=5;ReadOnly=0;ExtendedAnsiSQL=1;&quot;<br />    pRSet.CursorLocation = adUseClient: pRSet.CursorType = adOpenStatic<br />    pRSet.Open &quot;Select * From forImport Where FLong1 Is Null&quot;, pCon, adOpenStatic, adLockOptimistic<br />    vData = Range(&quot;A2&quot;).Resize(lastRow, lastCol).Value<br />    pCon.BeginTrans<br />    For i = 1 To lastRow<br />        k = k + 1<br />        If (k Mod 10000) = 0 Then Debug.Print k: DoEvents<br />        pRSet.AddNew<br />        pRSet(0).Value = vData(i, 1)<br />        pRSet(1).Value = vData(i, 2)<br />        pRSet(2).Value = vData(i, 3)<br />        pRSet(3).Value = vData(i, 4)<br />        pRSet(4).Value = vData(i, 5)<br />        pRSet(5).Value = vData(i, 6)<br />        '<br />        pRSet(6).Value = vData(i, 7)<br />        pRSet(7).Value = vData(i, 8)<br />        pRSet(8).Value = vData(i, 9)<br />        pRSet(9).Value = vData(i, 10)<br />        pRSet(10).Value = vData(i, 11)<br />        pRSet(11).Value = vData(i, 12)<br />    Next<br />    pRSet.UpdateBatch: pCon.CommitTrans<br />    pRSet.Close: pCon.Close<br />    MsgBox Timer - t<br />End Sub</span><span style=" font-family:'Courier New,courier'; font-size:11pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br />Так что у автора закрытого топика скорее всего были индексы в таблице Access, что и приводило к таким &quot;тормозам&quot;.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:11pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:11pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">если из экселя запустим, то как эксель узнает куда экспортировать, ну там имя базы, таблицы?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;"><br />Ну, естественно, нужна предварительная подготовка. Типа CreateObject(&quot;Access.Application&quot;), OpenDatabase и т.д. Просто открыть файл MDB или новый и писать в него (как в случае с ADO) - недостаточно, т.к. объект DoCmd доступен только в экземпляре Access.<br /><br />P.S. Примерно такая минимальная болванка:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">Sub runAccess()<br />    Set acApp = CreateObject(&quot;Access.Application&quot;)<br />    acApp.OpenCurrentDatabase strFileName<br />    <br />    Set acDoCmd = acApp.DoCmd<br />    acDoCmd.TransferSpreadsheet 0, 9, &quot;Лист1&quot;, &quot;C:\...\...\MyFile.xlsx&quot;, True<br />    <br />    acApp.Quit<br />End Sub</span></p></body></html>