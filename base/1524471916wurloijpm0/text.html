<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.potolook.ru/blog/p,209/"><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:600; text-decoration: underline; color:#0000ff;">Как создать свое правило в VBA для Microsoft Outlook? Событие ItemAdd для папки Входящие</span></a><span style=" font-family:'DejaVu Sans'; font-size:11pt;">     	</span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">написано в рубрике: </span><a href="http://www.potolook.ru/blog/p,category/microsoft-outlook/"><span style=" font-family:'DejaVu Sans'; font-size:11pt; text-decoration: underline; color:#0000ff;">Microsoft Outlook</span></a><span style=" font-family:'DejaVu Sans'; font-size:11pt;"> —  Outlook Blogger @ Пт 18.08.2006 16:00</span></p>
<p style="-qt-paragraph-type:empty; margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:11pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">    Одним из огромных преимуществ Microsoft Outlook перед другими почтовиками несомненно является наличие встроенного VBA for Application. Т.е. простого интерпретатора языка VBScript, с помощью которого можно обращаться к объектной модели Microsoft Outlook и творить с ним многое, если не всё. Если Вы немного владеете Бейсиком, то Вам будет вполне по силам написать свой обработчик для правил сортировки, значимость которых трудно переоценить.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="more-209"></a><span style=" font-family:'DejaVu Sans'; font-size:11pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Итак, создаем свое собственное правило на VBScript которое пересылает на определенный адрес письма, попадающие в папку </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:600;">Входящие</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;"> до 9 утра и после 5 вечера. Заходим в меню </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-style:italic;">Сервис/Макрос/Редактор Visual Basic</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;"> и выбираем </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:600;">Проект1/Microsoft Office Outlook Objects/ThisOutlookSession</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:11pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Далее вставляем в область кода следующую программу:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;"> Public WithEvents myOlItems As Outlook.Items</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;"> Public Sub Application_Startup()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">    ' Reference the items in the Inbox. Because myOlItems is declared</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">    ' &quot;WithEvents&quot; the ItemAdd event will fire below.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">    Set myOlItems = Outlook.Session.GetDefaultFolder(olFolderInbox).Items</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;"> End Sub</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;"> Private Sub myOlItems_ItemAdd(ByVal Item As Object)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">    ' If it's currently not between 9:00 A.M. and 5:00 P.M.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">    If Time() &lt; #9:00:00 AM# Or Time() &gt; #5:00:00 PM# Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">       ' Check to make sure it is an Outlook mail message, otherwise</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">       ' subsequent code will probably fail depending on what type</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">       ' of item it is.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">       If TypeName(Item) = &quot;MailItem&quot; Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">          ' Forward the item just received</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">          Set myForward = Item.Forward</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">          ' Address the message</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">          myForward.Recipients.Add &quot;support(ат)positic.ru&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">          ' Send it</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">          myForward.Send</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">       End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;">    End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#eff0f1;"><span style=" font-family:'Courier New,Courier,sans-serif'; font-size:11pt; background-color:#eff0f1;"> End Sub</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:11pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Если требуется, то в скрипте можно легко поменять временной промежуток работы правила, а также почтовый адрес для пересылки.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Для работы VBA кода проверьте, что макросы разрешены для выполнения в меню </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-style:italic;">Сервис/Макрос/Безопасность</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">. Если же редактор VBA совсем не открывается, то стоит проверить соответствующую надстройку VBA for Application в меню </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-style:italic;">Сервис/Параметры/Дополнительно/Дополнительно/COM Надстройки</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Наше правило может конфликтовать с уже существующими стандартными правилами. К примеру если используется учетная запись сервера Exchange и настроено перемещение сообщений на стороне сервера, то наше правило может не сработать.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Событие </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:600;">ItemAdd</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;"> работает не только при получении почты, но и при простом перетаскивании сообщения в папку. Поэтому если Вы поздно ночью перенесете письмо в папку </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:600;">Входящие</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">, то выполнится наше правило и письмо перешлется. Также существует событие </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:600;">NewMail</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">, находящееся в объекте </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:600;">Application</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">, которое вызывается только после прихода новой почты. Причем вызывается оно только один раз, даже если пришло несколько писем, поэтому требуется дополнительная логика для их нахождения в папке </span><span style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:600;">Входящие</span><span style=" font-family:'DejaVu Sans'; font-size:11pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:11pt;">Описанным выше образом можно выполнять произвольные действия для любой папки, пользуясь только стандартной функциональностью Microsoft Outlook. В следующих постах читайте как создать обработчик стандартного правила Outlook на VBA.	</span></p></body></html>