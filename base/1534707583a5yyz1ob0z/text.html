<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="Top"></a><span style=" font-size:8.25pt; font-weight:600;">M</span><span style=" font-size:8.25pt; font-weight:600;">icrosoft Access: Запросы</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Автор Allen Browne:  июнь 2008 г.  Последнее обновление: март 2010 г.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Оригинал </span><a href="http://allenbrowne.com/QueryPerfIssue.html"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">http://allenbrowne.com/QueryPerfIssue.html</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Перевел с английского </span><a href="mailto:alx.artamonov@yandex.ru"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Александр Артамонов</span></a><span style=" font-size:8.25pt;">, ноябрь 2011 г.</span></p>
<hr />
<p style=" margin-top:10px; margin-bottom:4px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#3366cc;"><span style=" font-size:8.25pt; font-weight:600; color:#000000;">Содержание:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://alx-artamonov.narod.ru/index/0-13#IsNull"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Is Null, не IsNull()</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://alx-artamonov.narod.ru/index/0-13#Nz"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">IIf(), не Nz()</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://alx-artamonov.narod.ru/index/0-13#DomainAggregate"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Доменные агрегатные функции</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://alx-artamonov.narod.ru/index/0-13#CalcFields"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Критерии по вычисляемым полям</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://alx-artamonov.narod.ru/index/0-13#ConcatFields"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Сортировка по конкатенированным полям</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://alx-artamonov.narod.ru/index/0-13#WhereVsHaving"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Where против Having</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://alx-artamonov.narod.ru/index/0-13#FirstVsGroupBy"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">First против Group By</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:25px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://alx-artamonov.narod.ru/index/0-13#Other"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Прочие приемы оптимизации</span></a></p>
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Типичные тормоза запросов</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Предмет этой статьи - часто совершаемые ошибки, приводящие к ухудшению производительности запросов.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Мы предполагаем, что ваши таблицы содержат первичные ключи, внешние ключи и индексы на полях, по которым совершается поиск и сортировка.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Используйте SQL, а не VBA</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">JET/ACE (движок запросов в Аксессе) использует Structured Query Language (SQL), как и многие базы данных. JET также способен вызывать код Visual Basic for Applications (VBA). Это радикально расширяет возможности JET-а, но вызов VBA теряет смысл, если работу может выполнить SQL.</span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="IsNull"></a><span style=" font-size:8.25pt; font-weight:600;">I</span><span style=" font-size:8.25pt; font-weight:600;">s Null, не IsNull()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="1" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="5" bgcolor="#ffffff">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image28982.png" /><span style=" font-size:8.25pt;"> </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">WHERE </span><span style=" font-size:8.25pt; background-color:#ffff00;">IsNull(</span><span style=" font-size:8.25pt;">Table1.Field1</span><span style=" font-size:8.25pt; background-color:#ffff00;">)</span></p></td></tr>
<tr>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image6446.png" /><span style=" font-size:8.25pt;"> </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">WHERE (Table1.Field1 </span><span style=" font-size:8.25pt; background-color:#ffff00;">Is Null</span><span style=" font-size:8.25pt;">)</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600; font-style:italic;">Is Null</span><span style=" font-size:8.25pt;"> является родным выражением SQL.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600; font-style:italic;">IsNull()</span><span style=" font-size:8.25pt;"> - вызов VBA функции.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Не бывает веских причин вызывать IsNull() в запросе, так как SQL может самостоятельно оценить смысл выражения.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="Nz"></a><span style=" font-size:8.25pt; font-weight:600;">I</span><span style=" font-size:8.25pt; font-weight:600;">If(), не Nz()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="1" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="5" bgcolor="#ffffff">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image28982.png" /><span style=" font-size:8.25pt;"> </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">SELECT </span><span style=" font-size:8.25pt; background-color:#ffff00;">Nz(</span><span style=" font-size:8.25pt;">Table1.Field1,0</span><span style=" font-size:8.25pt; background-color:#ffff00;">)</span><span style=" font-size:8.25pt;"> AS Amount</span></p></td></tr>
<tr>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image6446.png" /><span style=" font-size:8.25pt;"> </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">SELECT </span><span style=" font-size:8.25pt; background-color:#ffff00;">IIf(</span><span style=" font-size:8.25pt;">Table1.Field1 Is Null, 0, Table1.Field1</span><span style=" font-size:8.25pt; background-color:#ffff00;">)</span><span style=" font-size:8.25pt;"> AS Amount</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Функция Nz() заменяет Null другим значением (для чисел обычно нулем, для текста - пустой строкой.) Новое значение является типом данных Variant, а VBA помечает его в свою очередь подтипом: String, Long, Double, Date и т.д.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">В VBA это просто замечательно: функция может возвращать разные подтипы в разных ситуациях. Но в запросе столбец может быть только ОДНОГО типа данных. JET, следовательно, воспринимает значения типа Variant как текстовые, так как что угодно (числа, даты, символы, ...) являются валидными в текстовом столбце.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Визуальным признаком того, что JET воспринимает столбец как текст, является выравнивание по левому краю. Числа и даты отображаются выровненными по правому краю.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Если вы ожидали числовую или колонку с датами, у вас серьезные проблемы. Текстовые поля оцениваются посимвольно. Т.е. 2 больше 19, потому что первый символ (2) больше, чем первый символ в другом тексте (1 in 19.) Подобным образом, 4/1/2009 идет после 1/1/2010 в текстовом столбца, так как 4 идет после 1.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Звоночек раздается, когда вы видите столбец выровненным по левому краю как текст, в то время как вы ожидали, что он будет трактоваться как число. Записи будут выбраны неверно, а сортировка будет выглядеть бессмысленной.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Можно было бы типизировать выражение еще вызовом еще одной функции VBA, но лучшим решением было бы позволить JET выполнить работы, не вызывая VBA вообще.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Вместо:<br /></span><span style=" font-family:'Courier New'; font-size:8.25pt;">    Nz(MyField,0)</span><span style=" font-size:8.25pt;"><br />используйте:<br /></span><span style=" font-family:'Courier New'; font-size:8.25pt;">    IIf(MyField Is Null, 0, MyField)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Да, придется чуть больше напечатать, но есть свои плюсы:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы избегаете вызова функции Nz().</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы сохраняете желаемый тип данных.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Критерии применяются корректно.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Столбец сортируется корректно.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Этот принцип относится не только к Nz(), но и к любой функции VBA, возвращающей Variant. Просто Nz() - наиболее распространенный случай.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">(Обратите внимание: функция JET IIf() намного более эффективна, чем одноименная функция в VBA. Функция VBA тратит время на оценку и истинной и ложной части и генерирует ошибки, если какая-нибудь из частей не срабатывает (даже если эта часть не нужна.) У JET-овской функции IIf() подобных проблем нет.)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="DomainAggregate"></a><span style=" font-size:8.25pt; font-weight:600;">Д</span><span style=" font-size:8.25pt; font-weight:600;">оменные агрегатные функции</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">DLookup(), DSum() и т.д. - медленные по выполнению функции. Они требуют вызова VBA, вызова службы выражений (Expression Service) и расходуют ресурсы (открывая дополнительные подключения к файлу данных). Особенно все затягивается, если JET должен выполнить операцию на каждой строке запроса.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://allenbrowne.com/subquery-01.html"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Подзапросы</span></a><span style=" font-size:8.25pt;"> будут значительно быстрее, чем доменные агрегатные функции. В большинстве случаев, вложенный запрос будет еще быстрее (т.е. еще один сохраненный запрос, который включается как &quot;таблица&quot; в первый запрос.)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Бывают случаи, когда доменная агрегатная функция все-таки является лучшим решением, которое у вас есть (например, когда нужны редактируемые результаты). Для таких случаев было бы полезно воспользоваться </span><a href="http://allenbrowne.com/ser-42.html"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">ELookup()</span></a><span style=" font-size:8.25pt;"> вместо встроенных функций.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"> </span></p>
<hr />
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Составляйте выражения, чтобы использовать индексы</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Запрос будет намного быстрее, если база данных может использовать индекс, чтобы выбирать или сортировать записи. Вот два примера.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="1" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="5" bgcolor="#ffffff">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image28982.png" /><span style=" font-size:8.25pt;"> </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">WHERE </span><span style=" font-size:8.25pt; background-color:#ffff00;">Year(</span><span style=" font-size:8.25pt;">Table1.MyDate</span><span style=" font-size:8.25pt; background-color:#ffff00;">)</span><span style=" font-size:8.25pt;"> = 2008</span></p></td></tr>
<tr>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image6446.png" /></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">WHERE (Table1.MyDate &gt;= #1/1/2008#)<br />AND (Table1.MyDate &lt; #1/1/2009#)</span></p></td></tr></table>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="CalcFields"></a><span style=" font-size:8.25pt; font-weight:600;">К</span><span style=" font-size:8.25pt; font-weight:600;">ритерии по вычисляемым полям</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">В примере справа функция Year() выглядит проще, но она будет выполняться намного медленнее.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Для каждой записи JET выполняет вызов функции VBA, получает результат, и затем сканирует таблицу целиком, чтобы отбросить записи с другими годами. Без этого вызова функции JET мог бы использовать индекс, чтобы мгновенно выбрать записи для 2008 года. Выполнение будет на порядок быстрее.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">(Вы могли бы использовать </span><span style=" font-size:8.25pt; font-style:italic;">WHERE Table1.MyDate Between #1/1/2008# And #12/31/2008#</span><span style=" font-size:8.25pt;">, но так теряются любые даты, у которых есть компонента времени в последнем дне).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Особенно избегайте вызов VBA в критериях отбора или в сортировке с тем, чтобы JET мог использовать индекс.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="1" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="5" bgcolor="#ffffff">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image28982.png" /></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">SELECT ClientID, Surname &amp; &quot;, &quot; + FirstName AS FullName<br />FROM tblClient<br />ORDER BY Surname </span><span style=" font-size:8.25pt; background-color:#ffff00;">&amp; &quot;, &quot; &amp;</span><span style=" font-size:8.25pt;"> FirstName;</span></p></td></tr>
<tr>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image6446.png" /></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">SELECT ClientID, Surname &amp; &quot;, &quot; + FirstName AS FullName<br />FROM tblClient<br />ORDER BY Surname</span><span style=" font-size:8.25pt; background-color:#ffff00;">,</span><span style=" font-size:8.25pt;"> FirstName, ClientID;</span></p></td></tr></table>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="ConcatFields"></a><span style=" font-size:8.25pt; font-weight:600;">С</span><span style=" font-size:8.25pt; font-weight:600;">ортировка по конкатенированным полям</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Представльте комбобокс для выбора людей по имени. Поле </span><span style=" font-size:8.25pt; font-style:italic;">ClientID</span><span style=" font-size:8.25pt;"> спрятано, а </span><span style=" font-size:8.25pt; font-style:italic;">Surname</span><span style=" font-size:8.25pt;"> и </span><span style=" font-size:8.25pt; font-style:italic;">FirstName</span><span style=" font-size:8.25pt;"> сцеплены конкатенацией в один столбец, так что отображается полное имя, даже когда комбобокс не находится в раскрытом состоянии.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Не сортируйте по конкатенированному полю! Сортируйте по двум полям, чтобы JET мог использовать индексы по этим полям для выполнения сортировки.</span></p>
<hr />
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Оптимизируйте групповые запросы</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Оптимизатор JET-а весьма неплох, так что вам может показаться, что простые запросы будут выполняться быстро и без советов из этого раздела. Все равно стоит потраченных усилий сделать запрос как можно лучше, чтобы он не стал внезапно тормозить, когда вы его измените.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="1" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="5" bgcolor="#ffffff">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image28982.png" /><span style=" font-size:8.25pt;"> </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">SELECT ClientID, Count(InvoiceID) AS HowMany<br />FROM tblInvoice<br />GROUP BY ClientID<br /></span><span style=" font-size:8.25pt; background-color:#ffff00;">HAVING</span><span style=" font-size:8.25pt;"> ClientID = 99;</span></p></td></tr>
<tr>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image6446.png" /></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">SELECT ClientID, Count(InvoiceID) AS HowMany<br />FROM tblInvoice<br /></span><span style=" font-size:8.25pt; background-color:#ffff00;">WHERE</span><span style=" font-size:8.25pt;"> ClientID = 99<br />GROUP BY ClientID;</span></p></td></tr></table>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="WhereVsHaving"></a><span style=" font-size:8.25pt; font-weight:600;">W</span><span style=" font-size:8.25pt; font-weight:600;">HERE против HAVING</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Итоговые запросы (те, что с предложением GROUP BY) могут иметь как предложение WHERE, так и предложение HAVING. Сначала выполняется WHERE - перед группировкой; затем следует HAVING - когда высчитываются итоги. Итак, имеет смысл поместить критерии в предложение WHERE и использовать HAVING только, когда нужно примерить критерии на итоги по группам.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">В конструкторе запросов Аксесса это не очевидно. Когда вы добавляете поле в строке конструктора, Аксесс устанавливает строку Групповая операция на </span><span style=" font-size:8.25pt; font-style:italic;">Группировка (Group By)</span><span style=" font-size:8.25pt;">, и хочется добавить критерии прямо под ним. Если вы это сделаете, критерии отбора окажутся в предложении HAVING. Чтобы использовать предложение WHERE clause, </span><span style=" font-size:8.25pt; font-weight:600;">добавьте поле в грид конструктора еще раз</span><span style=" font-size:8.25pt;"> и выберите Where в строке Групповая операция.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="FirstVsGroupBy"></a><span style=" font-size:8.25pt; font-weight:600;">F</span><span style=" font-size:8.25pt; font-weight:600;">IRST против GROUP BY</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="1" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="5" bgcolor="#ffffff">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image28982.png" /></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">SELECT EmployeeID, LastName, Notes<br />FROM Employees<br />GROUP BY EmployeeID, LastName, Notes;</span></p></td></tr>
<tr>
<td>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image6446.png" /></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">SELECT EmployeeID, </span><span style=" font-size:8.25pt; background-color:#ffff00;">First(</span><span style=" font-size:8.25pt;">LastName</span><span style=" font-size:8.25pt; background-color:#ffff00;">)</span><span style=" font-size:8.25pt;"> AS FirstOfLastName, <br /></span><span style=" font-size:8.25pt; background-color:#ffff00;">First(</span><span style=" font-size:8.25pt;">Notes</span><span style=" font-size:8.25pt; background-color:#ffff00;">)</span><span style=" font-size:8.25pt;"> AS FirstOfNotes<br />FROM Employees<br />GROUP BY EmployeeID;</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Когда вы добавляете поле в групповой запрос, Аксесс предлагает </span><span style=" font-size:8.25pt; font-style:italic;">Группировку/Group By</span><span style=" font-size:8.25pt;"> в строке Групповая операция. Следовательно, по умолчанию Аксесс будет группировать по всем этим полям.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Первичный ключ уникален. Так, если вы группируете по полю первичного ключа, нет никакой необходимости группировать по другим полям в этой таблице. Вы можете оптимизировать запрос, выбрав </span><span style=" font-size:8.25pt; font-style:italic;">First</span><span style=" font-size:8.25pt;"> вместо </span><span style=" font-size:8.25pt; font-style:italic;">Group By</span><span style=" font-size:8.25pt;"> в строке Групповая операция под другими полями. </span><span style=" font-size:8.25pt; font-style:italic;">First</span><span style=" font-size:8.25pt;"> позволяет JET вернуть значение из первой совпадающей записи, без необходимости группировать по этому полю.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Это сильно меняет дело в ситуации с полями типа </span><span style=" font-size:8.25pt; font-weight:600;">Memo</span><span style=" font-size:8.25pt;">. Если вы делаете GROUP BY по МЕМО-полю (</span><span style=" font-size:8.25pt; font-style:italic;">Notes</span><span style=" font-size:8.25pt;"> в примере), Аксесс сравнивает только первые 255 символов, а остальные просто </span><span style=" font-size:8.25pt; font-weight:600;">отсекаются</span><span style=" font-size:8.25pt;">! Выбирая </span><span style=" font-size:8.25pt; font-style:italic;">First</span><span style=" font-size:8.25pt;"> вместо </span><span style=" font-size:8.25pt; font-style:italic;">Группировка/Group By</span><span style=" font-size:8.25pt;">, JET может вернуть поле Memo полностью из первого же совпадения. Так что это не только более эффективно; это реально решает проблему усечения полей Memo.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">(Минусом использования </span><span style=" font-size:8.25pt; font-style:italic;">First</span><span style=" font-size:8.25pt;"> является получение полем псевдонима, напр. </span><span style=" font-size:8.25pt; font-style:italic;">FirstOfNotes</span><span style=" font-size:8.25pt;">.)</span></p>
<hr />
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="Other"></a><span style=" font-size:8.25pt; font-weight:600;">П</span><span style=" font-size:8.25pt; font-weight:600;">рочие приемы оптимизации</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Прочие предложения общего характера для оптимизации запросов в JET:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">С многотабличными запросами по возможности <span style=" font-weight:600;">используйте JOIN-ы</span>. JET выполнит такой запрос быстрее, чем с предложением WHERE по внешнему ключу.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Возвращайте по возможности меньше полей</span>. Это оптимизирует использование памяти и может сократить количество обращений к диску. Но включайте ключевые поля, чтобы дать JET-у быстрый способ идентифицировать записи.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Стройте строки запроса динамически</span>,как показано здесь <a href="http://allenbrowne.com/ser-62.html"><span style=" text-decoration: underline; color:#0000ff;">форма поиска</span></a>. Особенно там, где пользователь будет вводить только несколько из возможных критериев, которые вы ему предоставляете. Это радикально упрощает критерии. Аксесс применяет фильтру интеллектуально. т.е. Filter или WhereCondition обычно применяются перед тем, как он запрашивает записи из файла с данными.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Избегайте множества таблиц на внешней стороне JOIN-а, так как JET может их <a href="http://allenbrowne.com/BugOuterJoinExpression.html"><span style=" text-decoration: underline; color:#0000ff;">неправильно интерпретировать</span></a>.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы контролировать порядок выполнения, сохраните один запрос и используйте его как таблицу для другого запроса (вложенные запросы). Это важно, так как JET не считается со скобками в предложении FROM, когда он составляет план выполнения.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://allenbrowne.com/subquery-01.html"><span style=" text-decoration: underline; color:#0000ff;">Подзапросы</span></a> в общем менее эффективны, чем другие приемы (такие как JOIN-ы или вложенные сохраненные запросы), но более эффективны, чем доменные агрегатные функции.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Советы по перекрестным запросам см. <a href="http://allenbrowne.com/ser-67.html"><span style=" text-decoration: underline; color:#0000ff;">Техника построений перекрестных запросов</span></a>.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Используйте <a href="http://www.builderau.com.au/program/mysql/soa/Use-Jet-s-ShowPlan-to-write-efficient-queries/0,339028784,320277979,00.htm"><span style=" text-decoration: underline; color:#0000ff;">ShowPlan</span></a> для JET для более подробной информации по поводу того, как JET планирует выполнение запроса.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Оптимизация запросов - огромная тема. Для дальнейшего чтения см. </span><a href="http://safari.oreilly.com/9780321444431"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">SQL Queries for Mere Mortals</span></a><span style=" font-size:8.25pt;"> авторов Michael Hernandez и John Viescas.</span></p></body></html>