<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="cc-matrix-1501167885"></a><span style=" font-weight:600;">А</span><span style=" font-weight:600;">втофильтр</span> - очень удобный инструмент Excel и поэтому использовать его в VBA тоже хотелось бы. Но порой не всё так просто. Здесь я опишу лишь те проблемы, с которыми приходилось бороться лично, но не факт, что это исчерпывающий список. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">1. То, что в обычно жизни значение ячейки, в VBA может оказаться совсем не значением. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Была задача - подтянуть с помощью ВПР конкретное поле, а потом отфильтровать, оставив только тех, кто нашелся. Т.е. в обычной жизни я ставлю автофильтр &quot;всё, кроме #Н/Д&quot;. Записываю рекордером, всё достаточно очевидно: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">     ActiveSheet.Range(&quot;$A$1:$K$4480&quot;).AutoFilter Field:=10, Criteria1:=&quot;&lt;&gt;#Н/Д&quot; </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Однако на деле подобная запись оставит все записи. А дело всё в том, что то, что мы видим как &quot;#Н/Д&quot;, для VBA совсем не &quot;#Н/Д&quot;, а &quot;Error 2024&quot;. Подозреваю, что автофильтр на другие подобные &quot;служебные&quot; значения ячеек (например, #ДЕЛ/0) будет иметь те же проблемы. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Выход прост - не создавайте ошибок в ячейках, используйте функции Excel для обработки ошибок (еслиошибка, енд и др). Укажите что-нибудь осмысленно-бессмысленное для вывода в ячейку в случае ошибки (например, 11111 или ёёёёёёё), чтобы вы однозначно могли отличить ошибки от нормальных данных. А затем используйте автофильтр: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">     Range(&quot;$A$1:$K$4480&quot;).AutoFilter Field:=10, Criteria1:=&quot;&lt;&gt;11111&quot; </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2. Вторая проблема, с которой пришлось столкнуться, это фильтр на даты. Макрорекордер подсказывает нам синтаксис: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">     Range(&quot;$A$1:$J$4480&quot;).AutoFilter Field:=3, Criteria1:=&quot;&gt;28.08.2014&quot; </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Но использовать конкретную дату в макросе обычно нет смысла. Обычно мы используем переменную дату - последний год/полугодие/месяц. Поэтому синтаксис должен быть примерно таким: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">      Range(&quot;$A$1:$J$4480&quot;).AutoFilter Field:=3, Criteria1:=&quot;&gt;&quot; &amp; dat </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переменная же обычно задается от текущей даты (например, dat=Date-30). Однако, если оставить переменную в формате даты, фильтр не сработает. Её нужно сначала перевести в числовой формат. При этом у меня не сработал перевод в целое число, хотя гугл подсказывал мне его. Заработал толкьо с дробным. Итак, итоговый код: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">     dat = CDbl(Date) - 180   ' получаем число типа 44000 </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">     Range(&quot;$A$1:$J$4480&quot;).AutoFilter Field:=3, Criteria1:=&quot;&gt;&quot; &amp; dat </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">  </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">При этом формат фильтруемых ячеек у вас может оставаться датой. </p></body></html>