<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Кто вызвал функцию или процедуру? </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Предположим вы написали два макроса - один скрывает строки, другой отображает. </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7ad7104665768"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">скрываем строки Sub HideRows() Range(&quot;A3:A14&quot;).EntireRow.Hidden = True End Sub 'показываем строки Sub UnhideRows() Range(&quot;A3:A14&quot;).EntireRow.Hidden = False End Sub</span><span style=" font-size:12px;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:12px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:12px;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">8 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7ad7104665768-1"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">скрываем строки</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ad7104665768-2"></a><span style=" font-size:12px;">S</span><span style=" font-size:12px;">ub</span><span style=" font-size:12px;"> HideRows()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ad7104665768-3"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Range(&quot;A3:A14&quot;).EntireRow.Hidden = True</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ad7104665768-4"></a><span style=" font-size:12px;">E</span><span style=" font-size:12px;">nd</span><span style=" font-size:12px;"> Sub</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ad7104665768-5"></a><span style=" font-size:12px;">'</span><span style=" font-size:12px;">показываем строки</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ad7104665768-6"></a><span style=" font-size:12px;">S</span><span style=" font-size:12px;">ub</span><span style=" font-size:12px;"> UnhideRows()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ad7104665768-7"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Range(&quot;A3:A14&quot;).EntireRow.Hidden = False</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ad7104665768-8"></a><span style=" font-size:12px;">E</span><span style=" font-size:12px;">nd</span><span style=" font-size:12px;"> Sub</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">И, конечно - создали кнопки для вызова этих двух кодов (подробнее про создание кнопок - <a href="http://www.excel-vba.ru/chto-umeet-excel/kak-sozdat-knopku-dlya-vyzova-makrosa-na-liste/"><span style=" text-decoration: underline; color:#0000ff;">Как создать кнопку для вызова макроса на листе</span></a>). Но потом захотелось большего - чтобы была всего одна кнопка и первым нажатием строки скрывались, а вторым отображались. Сделать это не проблема, если применить такой финт: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7ae4081541182"></a><span style=" font-size:12px;">S</span><span style=" font-size:12px;">ub HideUnhideRows() Range(&quot;A3:A14&quot;).EntireRow.Hidden = Not Range(&quot;A3:A14&quot;).EntireRow.Hidden End Sub</span><span style=" font-size:12px;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:12px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:12px;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">3 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7ae4081541182-1"></a><span style=" font-size:12px;">S</span><span style=" font-size:12px;">ub</span><span style=" font-size:12px;"> HideUnhideRows()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ae4081541182-2"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Range(&quot;A3:A14&quot;).EntireRow.Hidden = Not Range(&quot;A3:A14&quot;).EntireRow.Hidden</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7ae4081541182-3"></a><span style=" font-size:12px;">E</span><span style=" font-size:12px;">nd</span><span style=" font-size:12px;"> Sub</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Но если код делается для пользователей, то лучше как-то дать понять им, в каком состоянии сейчас строки - скрыты или отображены и к какому действию приведет нажатие на кнопку. И лучше всего это сделать надписью на самой кнопке. Если кнопка одна на одном листе, то проблем быть не должно: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7aee302478779"></a><span style=" font-size:12px;">S</span><span style=" font-size:12px;">ub HideUnhideRows() If Range(&quot;A3:A14&quot;).EntireRow.Hidden Then Range(&quot;A3:A14&quot;).EntireRow.Hidden = False ActiveSheet.Shapes(1).TextFrame2.TextRange.Text = &quot;Скрыть строки&quot; Else Range(&quot;A3:A14&quot;).EntireRow.Hidden = True ActiveSheet.Shapes(1).TextFrame2.TextRange.Text = &quot;Показать строки&quot; End If End Sub</span><span style=" font-size:12px;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:12px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:12px;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">9 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7aee302478779-1"></a><span style=" font-size:12px;">S</span><span style=" font-size:12px;">ub</span><span style=" font-size:12px;"> HideUnhideRows()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aee302478779-2"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">If Range(&quot;A3:A14&quot;).EntireRow.Hidden Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aee302478779-3"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">Range(&quot;A3:A14&quot;).EntireRow.Hidden = False</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aee302478779-4"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">ActiveSheet.Shapes(1).TextFrame2.TextRange.Text = &quot;Скрыть строки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aee302478779-5"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aee302478779-6"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">Range(&quot;A3:A14&quot;).EntireRow.Hidden = True</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aee302478779-7"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">ActiveSheet.Shapes(1).TextFrame2.TextRange.Text = &quot;Показать строки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aee302478779-8"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aee302478779-9"></a><span style=" font-size:12px;">E</span><span style=" font-size:12px;">nd</span><span style=" font-size:12px;"> Sub</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Но если в книге несколько листов и на каждом по несколько кнопок, то не очень удобно будет в коде макроса указывать нужную кнопку. Да, можно указать по имени фигуры: ActiveSheet.Shapes(&quot;Скругленный прямоугольник 1&quot;). Но опять же - если кнопок много придется давать той единственной свое уникальное имя, совпадающее на всех листах. Но можно сделать проще - использовать свойство Caller: </p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7af7831381521"></a><span style=" font-size:12px;">S</span><span style=" font-size:12px;">ub HideUnhideRows() Dim sShName As String sShName = Application.Caller If ActiveSheet.Shapes(sShName).TextFrame2.TextRange.Text = &quot;Показать строки&quot; Then Range(&quot;A3:A14&quot;).EntireRow.Hidden = False ActiveSheet.Shapes(sShName).TextFrame2.TextRange.Text = &quot;Скрыть строки&quot; Else Range(&quot;A3:A14&quot;).EntireRow.Hidden = True ActiveSheet.Shapes(sShName).TextFrame2.TextRange.Text = &quot;Показать строки&quot; End If End Sub</span><span style=" font-size:12px;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:12px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:12px;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">9</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">10</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">11 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7af7831381521-1"></a><span style=" font-size:12px;">S</span><span style=" font-size:12px;">ub</span><span style=" font-size:12px;"> HideUnhideRows()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-2"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Dim sShName As String</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-3"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">sShName = Application.Caller</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-4"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">If ActiveSheet.Shapes(sShName).TextFrame2.TextRange.Text = &quot;Показать строки&quot; Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-5"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">Range(&quot;A3:A14&quot;).EntireRow.Hidden = False</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-6"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">ActiveSheet.Shapes(sShName).TextFrame2.TextRange.Text = &quot;Скрыть строки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-7"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-8"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">Range(&quot;A3:A14&quot;).EntireRow.Hidden = True</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-9"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">ActiveSheet.Shapes(sShName).TextFrame2.TextRange.Text = &quot;Показать строки&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-10"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7af7831381521-11"></a><span style=" font-size:12px;">E</span><span style=" font-size:12px;">nd</span><span style=" font-size:12px;"> Sub</span></p></td></tr></table>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь рассмотрим другую ситуацию, более распространенную. Вы написали свою <a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-funkciya-polzovatelyaudf/"><span style=" text-decoration: underline; color:#0000ff;">пользовательскую функцию</span></a>, которая должна суммировать данные ячейки со всех листов книги, кроме того, в котором сама функция. Часто это делают так:<br /></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7aff399501112"></a><span style=" font-size:12px;">F</span><span style=" font-size:12px;">unction СуммаЯчеекВсехЛистов(Ячейка As Range) Dim ws As Worksheet 'объявляем переменную для обращения к листам в цикле Dim dblSum As Double 'переменная для хранения суммы 'цикл по листам книги For Each ws In ActiveWorkbook.Worksheets If Not ws Is ActiveSheet Then 'исключаем активный лист из суммирования dblSum = dblSum + ws.Range(Ячейка.Address).Value End If Next ws 'присваиваем значение суммы функции СуммаЯчеекВсехЛистов = dblSum End Function</span><span style=" font-size:12px;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:12px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:12px;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">9</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">10</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">11</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">12 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7aff399501112-1"></a><span style=" font-size:12px;">F</span><span style=" font-size:12px;">unction</span><span style=" font-size:12px;"> СуммаЯчеекВсехЛистов(Ячейка As Range)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-2"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Dim ws As Worksheet 'объявляем переменную для обращения к листам в цикле</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-3"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Dim dblSum As Double 'переменная для хранения суммы</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-4"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">'цикл по листам книги</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-5"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">For Each ws In ActiveWorkbook.Worksheets</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-6"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">If Not ws Is ActiveSheet Then 'исключаем активный лист из суммирования</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-7"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">           </span><span style=" font-size:12px;">dblSum = dblSum + ws.Range(Ячейка.Address).Value</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-8"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-9"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Next ws</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-10"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">'присваиваем значение суммы функции</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-11"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">СуммаЯчеекВсехЛистов = dblSum</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7aff399501112-12"></a><span style=" font-size:12px;">E</span><span style=" font-size:12px;">nd</span><span style=" font-size:12px;"> Function</span></p></td></tr></table>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Но это очень неправильно. Во-первых, цикл идет по <span style=" font-weight:600;">листам активной</span> книги. А это значит, что если с этой книги перейти в другую - то функция будет вычислять сумму на листах именно этой книги, а не той, в которой записана функция. Во-вторых, строка If Not ws Is ActiveSheet Then исключает из суммирования лист <span style=" font-weight:600;">активной</span> книги, а не той книги, в которой записана функция. Это может привести к ошибочным расчетам, что весьма критично, если на расчеты функции опираются функции других книг и листов. Поэтому надо определять не активную книгу, а именно ту, в которой функция. Здесь опять поможет свойство Caller:<br /></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7b05394815071"></a><span style=" font-size:12px;">F</span><span style=" font-size:12px;">unction СуммаЯчеекВсехЛистов(Ячейка As Range) Dim ws As Worksheet 'объявляем переменную для обращения к листам в цикле Dim dblSum As Double 'переменная для хранения суммы Dim rFuncCell As Range 'переменная для хранения ссылки на ячейку с функцией Dim wsFunc As Worksheet 'переменная для хранения ссылки на лист с функцией Dim wbFunc As Workbook 'переменная для хранения ссылки на книгу с функцией Set rFuncCell = Application.Caller 'ячейка с функцией Set wsFunc = rFuncCell.Parent 'лист с функцией Set wbFunc = wsFunc.Parent 'книга с функцией 'для листа и книги можно записать одной строкой: 'Set wsFunc = Application.Caller.Parent 'лист с функцией 'Set wbFunc = Application.Caller.Parent.Parent 'книга с функцией 'цикл по листам книги с функцией For Each ws In wbFunc.Worksheets If Not ws Is wsFunc Then 'исключаем лист с функцией из суммирования dblSum = dblSum + ws.Range(Ячейка.Address).Value End If Next ws 'присваиваем значение суммы функции СуммаЯчеекВсехЛистов = dblSum End Function</span><span style=" font-size:12px;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:12px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:12px;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">9</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">10</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">11</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">12</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">13</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">14</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">15</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">16</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">17</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">18</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">19</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">20</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">21</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">22</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:12px;">23 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce6c5a7b05394815071-1"></a><span style=" font-size:12px;">F</span><span style=" font-size:12px;">unction</span><span style=" font-size:12px;"> СуммаЯчеекВсехЛистов(Ячейка As Range)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-2"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Dim ws As Worksheet     'объявляем переменную для обращения к листам в цикле</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-3"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Dim dblSum As Double    'переменная для хранения суммы</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-4"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Dim rFuncCell As Range  'переменная для хранения ссылки на ячейку с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-5"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Dim wsFunc As Worksheet 'переменная для хранения ссылки на лист с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-6"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Dim wbFunc As Workbook  'переменная для хранения ссылки на книгу с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-7"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-8"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Set rFuncCell = Application.Caller 'ячейка с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-9"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Set wsFunc = rFuncCell.Parent      'лист с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-10"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Set wbFunc = wsFunc.Parent         'книга с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-11"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">'для листа и книги можно записать одной строкой:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-12"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">'Set wsFunc = Application.Caller.Parent        'лист с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-13"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">'Set wbFunc = Application.Caller.Parent.Parent 'книга с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-14"></a><span style=" font-size:12px;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-15"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">'цикл по листам книги с функцией</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-16"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">For Each ws In wbFunc.Worksheets</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-17"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">If Not ws Is wsFunc Then 'исключаем лист с функцией из суммирования</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-18"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">           </span><span style=" font-size:12px;">dblSum = dblSum + ws.Range(Ячейка.Address).Value</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-19"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">       </span><span style=" font-size:12px;">End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-20"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">Next ws</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-21"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">'присваиваем значение суммы функции</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-22"></a><span style=" font-size:12px;"> </span><span style=" font-size:12px;">   </span><span style=" font-size:12px;">СуммаЯчеекВсехЛистов = dblSum</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce6c5a7b05394815071-23"></a><span style=" font-size:12px;">E</span><span style=" font-size:12px;">nd</span><span style=" font-size:12px;"> Function</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А теперь попробуем разобраться, что же за зверь такой, этот Caller.<br />Caller - свойство объекта Application, которое возвращает информацию о том, как(чем) был вызван код. Есть несколько вариантов вызова и в зависимости от них значение, возвращаемое Caller меняется:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Если вызов был из функции пользователя</span> - Caller вернет объект Range, представляющий ссылку на ячейку, в которой записана функция пользователя. Если это функция введена как <a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-formula-massiva/"><span style=" text-decoration: underline; color:#0000ff;">формула массива</span></a> - то Caller вернет ссылку на все ячейки, в которые записана функция</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Если вызов был кнопкой на листе</span> - Caller вернет текст, содержащий локальное имя объекта Shape, к которому привязан вызов процедуры</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Если вызов был из событийной процедуры</span>(Workbook_Open и им подобные), либо процедура была вызвана через Alt+F11 - Caller вернет ошибку <span style=" font-weight:600;">REF</span></li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Если процедура вызвана с панели</span>(Ribbon или настраиваемая панель) - Caller будет иметь тип Variant(), но не сможет определить как именно был вызван код и при попытке обращения к нему получим так же ошибку REF</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Если вызов был через процедуры автоматизации</span> (Auto_Open, Auto_Close, Auto_Activate, Auto_Deactivate) - Caller вернет тип String и содержит имя книги и активного листаэто устаревшие процедуры, которые сейчас заменены событийными в классах книг и листов, но тем не менее их можно встретить в некоторых кодах</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Хотел бы так же отметить, что для определения ячейки с функцией можно использовать объект Application.ThisCell, который возвращает ссылку на ячейку, из которой была вызвана функция. Этот объект внутри функций пользователя можно применять точно так же, как и Caller. Но он не может быть применен для определения других методов вызова функций и процедур, как Caller.</p></body></html>