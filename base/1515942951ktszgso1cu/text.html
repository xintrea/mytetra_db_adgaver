<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">15. Арифметика чисел с плавающей точкой: проблемы и ограничения </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="aswift_0_expand"></a><a href="http://pythoner.name/documentation/tutorial/floatingpoint#representation-error"><span style=" text-decoration: underline; color:#0000ff;">О</span></a><span style=" text-decoration: underline; color:#0000ff;">шибки представления</span></li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Числа с плавающей точкой представлены в компьютерном железе как дроби с основанием 2 (двоичная система счисления). Например, десятичная дробь </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">0.125</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">имеет значение 1/10 + 2/100 + 5/1000, и таким же образом двоичная дробь </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">0.001</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">имеет значение 0/2 + 0/4 + 1/8. Эти две дроби имеют одинаковые значения, отличаются только тем, что первая записана в дробной нотации по основанию 10, а вторая по основанию 2. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">К сожалению, большинство десятичных дробей не могут быть точно представлены в двоичной записи. Следствием этого является то, что в основном десятичные дробные числа вы вводите только приближенными к двоичным, которые и сохраняются в компьютере. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проблему легче понять сначала в десятичной системе счисления. Рассмотрим дробь 1/3. Вы можете приблизительно представить ее десятичной дробью: </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">0.3</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">или лучше </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">0.33</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">еще лучше </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">0.333</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">и так далее. Независимо от того, как много цифр вы запишите, результат никогда не будет точно 1/3, но будет все более лучшим приближением к 1/3. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Точно также не важно, как много цифр с основанием 2 вы будете использовать, десятичное значение 0.1 не может быть представлено точно в двоичной записи дроби. По основанию 2 дробь 1/10 - это бесконечно повторяющаяся дробь </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">0.0001100110011001100110011001100110011001100110011...</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Остановка при любом конечном количестве бит приведет к получению приближения. Сегодня на большинстве компьютеров вещественные числа приближены с использованием бинарных дробей, чей числитель использует первые 53 бита, начиная с самого значимого  бита, и чей знаменатель является степенью двойки. В случае 1/10, бинарная дробь есть <span style=" font-family:'Courier New,courier';">3602879701896397 / 2 ** 55</span>, которая близка, но не точно равна действительному значению 1/10. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Многие пользователи не осведомлены о приближении из-за способа отображения значений. Python выводит только десятичное приближение настоящего десятичного значения от двоичного приближения, хранимого на компьютере. На большинстве машин, если бы Python выводил настоящее десятичное значение двоичного приближения 0.1, то тогда бы отобразилось следующее </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; 0.1</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">0.1000000000000000055511151231257827021181583404541015625</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Здесь больше цифр, чем большинство людей найдут полезными, поэтому, вместо этого, Python позволяет управлять количеством цифр, отображая округленное значение </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; 1 / 10</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">0.1</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просто помните, даже если отображенный результат выглядит как точное значение 1/10, на самом деле хранимое значение - самое близкое представление бинарной дроби. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Примечательно, что есть множество различных десятичных чисел, которые разделяют одинаковую самую близкую приблизительную двоичную дробь. Например, число  0.1 и 0.10000000000000001 и 0.1000000000000000055511151231257827021181583404541015625 являются все приближенными к 3602879701896397 / 2 ** 55. Поскольку все эти десятичные значения разделяют одно и тоже приближение, любой один из них мог бы быть отображен при сохранении инварианта <span style=" font-family:'Courier New,courier';">eval(repr(x)) == x</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Исторически, приглашение Python и встроенная функция repr() выбрали бы одну из 17 значащих цифр, <span style=" font-family:'Courier New,courier';">0.10000000000000001</span>. Начиная с Python 3.1, на большинстве систем теперь Python способен выбрать самую короткую из них и просто отобразить <span style=" font-family:'Courier New,courier';">0.1</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заметьте, что это очень естественно для двоичного вещественного числа: это не баг в Python и также не баг в вашем коде. Вы увидите то же самое во всех языках, которые поддерживают арифметику с плавающей точкой вашего железа (хотя некоторые языки могут не отображать различия по-умолчанию, или во всех режимах вывода). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для более приятного вывода вы можете пожелать использовать строковое форматирование для создания ограниченного числа значащих цифр: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; format(math.pi, '.12g')  # задает 12 значащих цифр</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">'3.14159265359'</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; format(math.pi, '.2f')   # задает 2 цифры после запятой</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">'3.14'</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; repr(math.pi)</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">'3.141592653589793'</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Важно осознавать, что в реальном понимании это иллюзия: вы просто округляете вывод действительного машинного значения. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Одна иллюзия может порождать другую. Например, поскольку 0.1 не точно 1/10, суммирование трех значений 0.1 может не произвести точно 0.3, либо: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; .1 + .1 + .1 == .3</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">False</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="result_box"></a>Также, поскольку 0.1 не может приблизиться к точному значению 1/10 и 0.3 не может приблизиться к точной величине 3/10, то предварительное округление с помощью функции <a href="http://pythoner.name/documentation/library/functions#round"><span style=" text-decoration: underline; color:#0000ff;">round()</span></a> не может помочь: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; round(.1, 1) + round(.1, 1) + round(.1, 1) == round(.3, 1)</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">False</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="result_box"></a>Хотя цифры не могут быть приближены к их предназначенным точным значениям, функция round() может быть полезна для пост-округления, так что результаты с неточными значениями становятся сопоставимы друг с другом: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; round(.1 + .1 + .1, 10) == round(.3, 10)</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">True</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Двоичная арифметика чисел с плавающей точкой содержит много сюрпризов подобных этому. Проблема с &quot;0.1&quot; объяснена в точных деталях ниже, в разделе &quot;Представление ошибок&quot;. См. The Perils of Floating Point, где более полный отчет о других обычных сюрпризах. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="result_box"></a>Как говорится ближе к концу: &quot;нет легких ответов&quot;. Но спокойно, не будьте чрезмерно осторожны насчет вещественных чисел! Ошибки в операциях с вещественными числами в Python унаследованы от чисел с плавающей точкой железа, и на большинстве машин <a name="result_box"></a>составляет не более 1 части в 2**53 за операцию. Это более чем адекватно для большинства задач, но вам нужно иметь в виду, что это не десятичная арифметика и что каждая вещественная операция может претерпевать новую ошибку округления. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Хотя патологические случаи действительно существуют, в повседневности, используя арифметику чисел с плавающей точкой, в конце вы будете видеть тот результат, который ожидали, если вы просто округляете финальные результаты к определенному количеству десятичных чисел. <a href="http://pythoner.name/documentation/library/stdtypes#str"><span style=" text-decoration: underline; color:#0000ff;">str()</span></a> обычно достаточно, а для более тонкого контроля см. <a href="http://pythoner.name/documentation/library/stdtypes#str.format"><span style=" text-decoration: underline; color:#0000ff;">str.format()</span></a> спецификаторы формата метода в Format String Syntax (docs.python.org/3/library/string.html#formatstrings). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для случаев, которые требуют точного десятичного представления, попробуйте использовать модуль decimal (docs.python.org/3/library/decimal.html#module-decimal), который реализует десятичную арифметику, подходящую для бухгалтерских приложений и высокоточных приложений. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Другая форма точной арифметики поддерживается модулем fractions (docs.python.org/3/library/fractions.html#module-fractions), который реализует арифметику, основанную на рациональных числах (так числа подобные 1/3 могут быть представлены точно). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вы сильно используете операции с плавающей точкой, вам следует взглянуть на пакет Numerical Python и множество других пакетов для математических и статистических операций, предоставляемых проектом SciPy. См. &lt;scipy.org&gt;. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Python предоставляет инструменты, которые могут помочь в тех редких случаях, когда вы действительно хотите знать точное значение вещественного числа. Метод <a href="http://pythoner.name/documentation/library/stdtypes#float.as_integer_ratio"><span style=" text-decoration: underline; color:#0000ff;">float.as_integer_ratio()</span></a> выражает значение вещественного числа как дробь: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; x = 3.14159</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; x.as_integer_ratio()</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">(3537115888337719, 1125899906842624)</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поскольку это соотношение точное, оно может быть использовано, чтобы без потерь воссоздать первоначальное значение: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; x == 3537115888337719 / 1125899906842624</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">True</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Метод float.hex() выражает вещественное число в шестнадцатеричной (с основанием 16) системе счисления, снова давая точное значение, хранимое вашим компьютером: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; x == float.fromhex('0x1.921f9f01b866ep+1')</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">True</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поскольку представление точно, это полезно для надежного переноса значений через различные версии Python (платформенная независимость) и обмена данными с другими языками, которые поддерживают такой же формат (такие как Java и C99). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Другой полезный инструмент - функция math.fsum() (docs.python.org/3/library/math.html#math.fsum), которая помогает смягчить потерю точности во время суммирования. Она отслеживает &quot;потерянные цифры&quot; как значения, добавляемые к текущему итогу. <a name="result_box"></a>Это может повлиять на общую точность, так что ошибки не накапливались до такой степени, чтобы влиять на итоговое значение: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; sum([0.1] * 10) == 1.0</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">False</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; math.fsum([0.1] * 10) == 1.0</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">True</span> </pre>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="representation-error"></a><span style=" font-size:x-large; font-weight:600;">1</span><span style=" font-size:x-large; font-weight:600;">5.1. Ошибки представления</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Этот раздел разъясняет &quot;0.1&quot; пример в деталях и показывает, как вы можете представить точный анализ таких случаев.<a name="result_box"></a> Предполагается базовое знакомство с двоичным представлением чисел с плавающей точкой. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ошибки представления относятся к тому факту, что некоторые (большинство, на самом деле) десятичные дроби не могут быть представлены точно как двоичные (с основанием 2) дроби. Это главная причина, почему Python (или Perl, C, C++, Java, Fortran и многие другие) обычно не будут отображать точное десятичное число, которое вы ожидаете. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Почему это так? 1/10 нельзя точно представить в виде двоичной дроби. Почти все компьютеры сегодня (ноябрь 2000) используют IEEE-754 арифметику вещественных чисел, и почти все платформы отображают вещественные числа Python в IEEE-754 &quot;двойной точности&quot;. Двойные 754 содержат 53 бита точности, так п<a name="result_box"></a>ри вводе компьютер стремится преобразовать 0,1 в ближайшую дробь, это может иметь вид J/2** N, где J - целое число, содержащее ровно 53 бита. Перезаписывая </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">1 / 10 ~= J / (2**N)</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">как </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">J ~= 2**N / 10</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">и вспоминая, что J имело точно 53 бита (является <span style=" font-family:'Courier New,courier';">&gt;= 2**52</span>, но &lt; <span style=" font-family:'Courier New,courier';">2**53</span>), наилучшее значение для N - это 56: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; 2**52 &lt;=  2**56 // 10  &lt; 2**53</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">True</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="result_box"></a>То есть 56 - единственное значение для N, которое оставляет J с точно 53 битами. Наилучшее возможное значение для J тогда есть округленное частное: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; q, r = divmod(2**56, 10)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; r</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">6</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поскольку остаток больше, чем половина от 10, наилучшее приближение получается путем округления в большую сторону: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; q+1</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">7205759403792794</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поэтому лучшее возможное приближение к 1/10 в двойной 754 точности: </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">7205759403792794 / 2 ** 56</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Деление числителя и знаменателя на два сокращает дробь к: </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">3602879701896397 / 2 ** 55</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заметьте, что поскольку мы округлили в большую сторону, это в действительности немного больше, чем 1/10; если мы бы так не округляли, частное было бы немного меньше, чем 1/10. Но в любом случае оно не может быть точно равно 1/10! </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Так компьютер никогда не &quot;видит&quot; 1/10: что он видит - это точная дробь, данная выше, наилучшее 754 двойное приближение, которое можно получить: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; 0.1 * 2 ** 55</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">3602879701896397.0</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если мы умножим ту дробь на 10**55, мы можем увидеть значение до 55 десятичных цифр: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; 3602879701896397 * 10 ** 55 // 2 ** 55</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">1000000000000000055511151231257827021181583404541015625</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">обозначаемое, что точное число, хранимое в компьютере, приравнено к десятичному значению 0.1000000000000000055511151231257827021181583404541015625. Вместо отображения полного десятичного значения, многие языки (включая более старые версии Python) округляют результат до 17 значащих цифр: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; format(0.1, '.17f')</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">'0.10000000000000001'</span> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Модули fractions (docs.python.org/3/library/fractions.html#module-fractions) и decimal (docs.python.org/3/library/decimal.html#module-decimal) легко выполняют эти вычисления: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; from decimal import Decimal</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; from fractions import Fraction</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; Fraction.from_float(0.1)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">Fraction(3602879701896397, 36028797018963968)</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; (0.1).as_integer_ratio()</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">(3602879701896397, 36028797018963968)</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; Decimal.from_float(0.1)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">Decimal('0.1000000000000000055511151231257827021181583404541015625')</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">&gt;&gt;&gt; format(Decimal.from_float(0.1), '.17')</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">'0.10000000000000001'</span></pre>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Создано</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2017-07-02 </p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://pythoner.name/comment/reply/node/93/comment#comment-form"><span style=" text-decoration: underline; color:#0000ff;">Добавить комментарий</span></a> </li></ul>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="book-label-26"></a><span style=" font-size:x-large; font-weight:600;">П</span><span style=" font-size:x-large; font-weight:600;">ерекрёстные ссылки книги для 15. Арифметика чисел с плавающей точкой: проблемы и ограничения</span> </p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style="" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://pythoner.name/documentation/tutorial/tab-history"><span style=" text-decoration: underline; color:#0000ff;">14. Редактирование интерактивного ввода и подстановка истории</span></a> </li>
<li style="" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://pythoner.name/documentation/tutorial"><span style=" text-decoration: underline; color:#0000ff;">Вверх</span></a> </li>
<li style="" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://pythoner.name/documentation/tutorial/appendix"><span style=" text-decoration: underline; color:#0000ff;">16. Дополнение</span></a> </li></ul></body></html>