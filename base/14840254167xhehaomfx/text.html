<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В статье &quot;<a href="http://www.programm-school.ru/struct_workbook_excel.html"><span style=" text-decoration: underline; color:#0000ff;">Иерархия(структура) рабочей книги Excel</span></a>&quot; была рассмотрена структура рабочей книги, листа и приложения в целом. Из этого возникает вопрос, каким образом можно получить, например кол-во страниц в книге Excel, или их имена. С количеством все просто, к примеру, для того чтобы получить кол-во открытых книг, достаточно воспользоваться следующей командой:<br /><span style=" font-weight:600;">Application.Workbooks.Count</span><br /><br />Чтобы получить кол-во страниц в активной книге:<br /><span style=" font-weight:600;">ActiveWorkbook.Worksheets.Count</span><br /><br />Если же требуется получить кол-во страниц в определенной книге для этого воспользуйтесь:<br /><span style=" font-weight:600;">Workbooks(1).Worksheets.Count</span><br />или<br /><span style=" font-weight:600;">Workbooks(&quot;имя книги.xls&quot;).Worksheets.Count</span><br /><br />В первом случае обращение к нужной книге происходит по индексу. Индекс присваивается в порядке открытия книг. Этот вариант не совсем удобен если необходимо обратится к конкретной книге т.к. книги могут открываться в разном порядке. Поэтому второй вариант команды позволяет обратиться к книге по ее полному имени.<br /><br />Теперь перейдем к рассмотрению работы с конструкцией <span style=" font-weight:600;">For Each ... Next</span>.<br /><br />Синтаксис конструкции <span style=" font-weight:600;">For Each ... Next<br /><br /></span><span style=" font-weight:600;">For Each </span>Элемент<span style=" font-weight:600;"> In </span>Коллекция(Группа)<br />       [команды]<br /><span style=" font-weight:600;">[Exit For]<br />       </span>[команды]<br /><span style=" font-weight:600;">Next [</span>Элемент<span style=" font-weight:600;">]</span><br /><br />Данная конструкция позволяет поочередно обратится к каждому элементу группы или коллекции. Коллекция это группа одинаковых (однотипных) объектов. Например, массивы, или коллекции <a href="http://www.programm-school.ru/struct_workbook_excel.html"><span style=" text-decoration: underline; color:#0000ff;">WorkBooks, Worksheets</span></a> .<br /><span style=" font-weight:600;">For Each ... Next</span> по принципу работы похож на цикл <span style=" font-weight:600;">For...Next,</span> который был рассмотрен <a href="http://www.programm-school.ru/rabota_s_ciklom_for_vba.html"><span style=" text-decoration: underline; color:#0000ff;">здесь</span></a>. Схожесть в том что, перебирается каждый элемент коллекции или группы по порядку. Не буду томить скучной теорией перейдем к рассмотрению примеров.<br /><br /><span style=" font-weight:600; font-style:italic;">Пример 1</span>. Необходимо получить имена всех открытых книг Excel. Имена всех рабочих книг доступны в коллекции Workbooks.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Пример 1</span>. Необходимо получить имена всех открытых книг Excel. Имена всех рабочих книг доступны в коллекции Workbooks.</p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0" bgcolor="#e4f9fd">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Sub GetWorkBooksName()<br />Dim WBooks As Workbook<br />Dim Msg As String<br /><br />   For Each WBooks In Workbooks<br />      Msg = Msg &amp; WBooks.Name &amp; Chr(13)<br />   Next WBooks<br /><br />  MsgBox Msg<br />End Sub</p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Пример 2</span>. Необходимо получить имена всех страниц в активной книге. Имена страниц содержатся в коллекции Worksheets.</p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0" bgcolor="#e4f9fd">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Sub GetWorkSheetsName()<br />Dim Item As Worksheet<br /><br />   For Each Item In ActiveWorkbook.Worksheets<br />     MsgBox &quot;Отображаемое имя листа &quot; &amp; CStr(Item.Index) &amp; &quot; - &quot; &amp; Item.Name<br />   Next Item<br />   <br />End Sub</p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Пример 3</span>. Необходимо посчитать кол-во страниц во всех открытых книгах Excel.</p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0" bgcolor="#e4f9fd">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Sub GetAllCountSheets()<br />Dim WBooks As Workbook<br />Dim kolSheet As Long<br />Dim Msg As String<br /><br />kolSheet = 0<br />   For Each WBooks In Workbooks<br />      kolSheet = kolSheet + Workbooks(WBooks.Name).Worksheets.Count<br />   Next WBooks<br /><br />MsgBox &quot;Всего страниц в открытых книгах: &quot; &amp; CStr(kolSheet)<br />   <br />End Sub</p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Пример 4. </span>Необходимо преобразовать весь текст в выделенном диапазоне ячеек в верхний регистр т.е. сделаем буквы большими. Для этого воспользуемся коллекцией Selection (тип Range - хранит область выделенных ячеек) и функцией перевода символов в верхний регистр <span style=" font-weight:600;">UCase</span> (если необходим перевод в нижний регистр, то воспользуйтесь функцией <span style=" font-weight:600;">LCase</span>).</p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0" bgcolor="#e4f9fd">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Sub RangeUpCase()<br />Dim Cell As Range<br /> <br />   For Each Cell In Selection<br />    Cell.Value = UCase(Cell.Value)<br />   Next Cell<br /><br />End Sub</p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Выделяем нужные ячейки или диапазон ячеек с текстом и запускаем макрос.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Пример 5. </span>И заключительный пример, закроем все рабочие книги Excel, кроме активной, без сохранения.</p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0" bgcolor="#e4f9fd">
<tr>
<td>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Sub CloseBooks()<br />Dim WBook As Workbook<br />  <br />   For Each WBook In Workbooks<br />     If WBook.Name &lt;&gt; ActiveWorkbook.Name Then WBook.Close False<br />   Next WBook<br />   <br />End Sub</p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">За закрытие книги Excel отвечает команда WBook.<span style=" font-weight:600;">Close. </span>Параметр False указывает, что закрываем все книги без сохранения. Если этот параметр изменить на True, то все книги будут закрываться предварительно сохранившись. Если же этот параметр убрать, то при закрытии книг с внесенными изменениями выскочит диалоговое окно с вопросом о сохранении.<br /><br />Все примеры, рассмотренные в статье, Вы можете скачать ниже. Все.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Прикрепленный файл:</span> <a href="http://dfiles.ru/files/mubv2akrd"><span style=" font-weight:600; text-decoration: underline; color:#0000ff;">Пример работы For Each.zip</span></a></p></body></html>