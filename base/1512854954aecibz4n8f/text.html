<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">Что мы знаем про каунтеры (aka счетчики)</span> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Опубликовано: 30 апр 04<br />Рейтинг: </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.addthis.com/bookmark.php?v=250&amp;username=xa-4cb75b821386eec8"><span style=" text-decoration: underline; color:#0000ff;">Добавить в закладки и поделиться</span></a> </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><a href="http://www.sql.ru/faq/faq_topic.aspx?fid=214#add-comment"><span style=" text-decoration: underline; color:#0000ff;">Оценить и прокомменитировать</span></a><br /><a href="http://www.sql.ru/faq/faq_topic.aspx?fid=214#"><span style=" text-decoration: underline; color:#0000ff;">Распечатать статью</span></a><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Автор: Владимир Саныч, участники форума по Аксессу<br />Прислал: Владимир Саныч </p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; text-decoration: underline;">Вопросы</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><br />Q1: Как создать свой счетчик (чтобы поле было не типа счетчик)?<br /><br />Q2: Как заставить счетчик начать выдавать значения начиная с некоторой заданной величины?<br /><br />Q3: Может ли поле счетчика содержать повторяющиеся значения?<br /><br />Q4: В таблице есть счетчик, но его значения идут не подряд, несколько чисел в середине отсутствуют. Как перезаполнить поле, чтобы дырок не было? (Другой вариант вопроса. Счетчик показывает, что последняя запись в моей таблице имеет номер N, а реально записей меньше. Почему счетчик неправильно считает количество записей в таблице? Что это - баг или фича?)<br /><br />Q5: Как сымитировать счетчик в отчете?<br /><br />Q6: Как сымитировать счетчик в запросе на добавление?<br /><br />Q7: Как сымитировать счетчик в обычном запросе либо ленточной форме?<br /><br />Q8: Как получить значение счетчика только что добавленной записи?<br /><br />Q9: Как создать одним запросом таблицу со счетчиком?<br /><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; text-decoration: underline;">Вопросы с ответами</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><br /><span style=" font-weight:600;">Q1: Как создать свой счетчик (чтобы поле было не типа счетчик)?</span><br /><br />A: Надо написать функцию, к которой обращаться либо в DefaultValue контрола (к сожалению, DefaultValue поля в таблице допускает только ограниченный набор стандартных функций), либо в программе, которая добавляет запись через рекордсет, либо в запросе на добавление. Ниже приведено несколько вариантов такой функции. Особое внимание надо уделить обработчику ошибок.<br /><br /><span style=" text-decoration: underline;">Вариант 1</span><br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">Nz(DMax(...),</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">0</span><span style=" font-family:'Courier New,courier';">)+</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Так можно нумеровать записи даже внутри группы, а не только насквозь через всю таблицу. Для этого надо правильно задать параметры DMax.<br /><br />Правда, надо отдельно позаботиться о ситуации, когда два юзера обратятся к этому &quot;генератору счетчиков&quot; одновременно.<br /><br /><span style=" text-decoration: underline;">Вариант 2</span><br /><br />Заводим отдельную таблицу с одним полем типа счетчик и без данных. Приводимая ниже процедура обращается к такой таблице и возвращает очередное значение для &quot;нашего&quot; счетчика. Внимание - файл, в котором сидит эта таблица, запрещено сжимать.<br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Function</span><span style=" font-family:'Courier New,courier';"> Cou() </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Long</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#0000ff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> ws </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> Workspace, db </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> Database</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> rsCounter </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> Recordset</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">On</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Error</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">GoTo</span><span style=" font-family:'Courier New,courier';"> errCou</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> ws = DBEngine(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">0</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> db = CurrentDb</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">ws.BeginTrans</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">2</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> rsCounter = db.OpenRecordset(</span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;select * from tabCounter&quot;</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">3</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rsCounter.AddNew</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">Cou = rsCounter!nCounter</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#000000;">'Close without update!'</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rsCounter.</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Close</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">4</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">ws.CommitTrans</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">5</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Exit</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Function</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#0000ff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">errCou:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Select</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Case</span><span style=" font-family:'Courier New,courier';"> Erl</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Case</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">3</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        rsCounter.</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Close</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> rsCounter = </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        ws.Rollback</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        DBEngine.Idle DB_FREELOCKS</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Resume</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Case</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">2</span><span style=" font-family:'Courier New,courier';">, </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">4</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        ws.Rollback</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        DBEngine.Idle DB_FREELOCKS</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Resume</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Case</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Resume</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Next</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">End</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Select</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#0000ff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">End</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Function</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Подвариант: все-таки делать rsCounter.Update, тогда по виду этой таблицы будет сразу ясно, какое значение было выдано последним. Правда, в этом случае файл станет расти.<br /><br />Еще подвариант: держать в этой таблице одну запись, в которой находится очередное значение счетчика, и вместо AddNew делать Edit и rsCounter!nCounter=rsCounter!nCounter+1, а потом соответственно Update.<br /><br /><span style=" text-decoration: underline;">Вариант 3 (от Гетца)</span><br /><br />Держим в отдельной таблице очередное значение счетчика и каждый раз увеличиваем его на 1. Таблица блокируется на момент чтения и увеличения счетчика, а все, кто в нее будут в это время стучаться, спокойно ждут (см. обработчик ошибок adhGetNextAutoNumber_Err) освобождения таблицы.<br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Function</span><span style=" font-family:'Courier New,courier';"> adhGetNextAutoNumber(</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">ByVal</span><span style=" font-family:'Courier New,courier';"> strTableName </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">String</span><span style=" font-family:'Courier New,courier';">) </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Long</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#0000ff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">On</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Error</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">GoTo</span><span style=" font-family:'Courier New,courier';"> adhGetNextAutoNumber_Err</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> wrk </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> dao.Workspace</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> db </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> dao.Database</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> rstAutoNum </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> dao.Recordset</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> lngW </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> lngX </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> intRetryCount </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Integer</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Randomize</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    DoCmd.Hourglass True</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    intRetryCount = </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">0</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-weight:600; color:#00008b;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> wrk = dao.DBEngine.Workspaces(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">0</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> db = wrk.OpenDatabase(adhCurrentDBPath() &amp; adhcAutoNumDb, False)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> rstAutoNum = db.OpenRecordset(strTableName &amp; </span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;_ID&quot;</span><span style=" font-family:'Courier New,courier';">, dbOpenTable, dbDenyRead)</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    rstAutoNum.MoveFirst</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    rstAutoNum.Edit</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    rstAutoNum!NextAutoNumber = rstAutoNum!NextAutoNumber + </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    rstAutoNum.Update</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    adhGetNextAutoNumber = lngNextAutoNum</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">adhGetNextAutoNumber_Exit:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    DoCmd.Hourglass False</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">On</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Error</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Resume</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Next</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    rstAutoNum.</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Close</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> rstAutoNum = </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    db.</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Close</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> db = </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    wrk.</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Close</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> wrk = </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Exit</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Function</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#0000ff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">adhGetNextAutoNumber_Err:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Select</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Case</span><span style=" font-family:'Courier New,courier';"> Err.Number</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Case</span><span style=" font-family:'Courier New,courier';"> adhcErrRI, adhcLockErrCantUpdate2, adhcLockErrTableInUse</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">            intRetryCount = intRetryCount + </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">            </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">If</span><span style=" font-family:'Courier New,courier';"> intRetryCount &gt; adhcLockRetries </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Then</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                adhGetNextAutoNumber = -</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Resume</span><span style=" font-family:'Courier New,courier';"> adhGetNextAutoNumber_Exit</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">            </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                dao.DBEngine.Idle</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                lngW = intRetryCount ^ </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">2</span><span style=" font-family:'Courier New,courier';"> * _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                  Int((adhcLockUBound - adhcLockLBound + </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span><span style=" font-family:'Courier New,courier';">) * Rnd() + adhcLockLBound)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">For</span><span style=" font-family:'Courier New,courier';"> lngW = </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">To</span><span style=" font-family:'Courier New,courier';"> lngW</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                    DoEvents</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Next</span><span style=" font-family:'Courier New,courier';"> lngW</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Resume</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">            </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">End</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">If</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Case</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">            MsgBox </span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;Error &quot;</span><span style=" font-family:'Courier New,courier';"> &amp; Err.Number &amp; </span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;: &quot;</span><span style=" font-family:'Courier New,courier';"> &amp; Err.Description, _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">             vbOKOnly + vbCritical, </span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;adhGetNextAutoNumber&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">            adhGetNextAutoNumber = -</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">            </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Resume</span><span style=" font-family:'Courier New,courier';"> adhGetNextAutoNumber_Exit</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">End</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Select</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#0000ff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">End</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Function</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-weight:600;">Q2: Как заставить счетчик начать выдавать значения начиная с некоторой заданной величины?</span><br /><br />A1: Добавить в таблицу со счетчиком при помощи инсерта запись, в которой полю счетчика дается значение на 1 меньше, чем надо. Потом удалить эту запись. Способ работает только при условии, что этот счетчик этого или большего значения еще не выдавал. (Если таким образом дать счетчику отрицательное значение, то он начнет выдавать отрицательные значения, несмотря на то что уже выдавал значения, большие их. Играя на этом, можно добиться, чтобы счетчик выдавал любые значения, в т.ч. и те, которые уже были.)<br /><br />A2: Сжать базу, в которой сидит таблица со счетчиком. Счетчик будет выдавать значения начиная с наибольшего из существующих +1. В некоторых версиях Аксесса это работает только при условии, что таблица со счетчиком пуста (и тогда счетчик начнет выдавать значения с 1).<br /><br />A3: Начиная с Аксесса 2000, можно запустить запрос наподобие такого:<br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">alter</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">table</span><span style=" font-family:'Courier New,courier';"> Таблица1 </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">alter</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">column</span><span style=" font-family:'Courier New,courier';"> ПолеСчетчик counter(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span><span style=" font-family:'Courier New,courier';">,</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-weight:600;">Q3: Может ли поле счетчика содержать повторяющиеся значения?</span><br /><br />A: В принципе да. Этого несложно достичь, меняя состояние счетчика описанными способами. Однако если при этом возникнут нарушения ключа (вообще говоря, поле счетчика можно и не делать ключевым, но обычно все-таки принято делать), то записи просто не смогут добавляться. Каждая неудачная попытка добавить запись будет увеличивать значение счетчика на 1. Когда зона существующих значений будет пройдена, то записи опять смогут добавляться.<br /><br /><span style=" font-weight:600;">Q4: В таблице есть счетчик, но его значения идут не подряд, несколько чисел в середине отсутствуют. Как перезаполнить поле, чтобы дырок не было? (Другой вариант вопроса. Счетчик показывает, что последняя запись в моей таблице имеет номер N, а реально записей меньше. Почему счетчик неправильно считает количество записей в таблице? Что это - баг или фича?)</span><br /><br />A: Это нормальная ситуация. Если возникла необходимость, чтобы значения счетчика шли подряд, значит база была спроектирована неверно. Поле счетчика должно служить только для однозначной идентификации записей (и, возможно, порядка их занесения), юзер не должен видеть его значений, а если и увидит, то не должен возражать против тех значений, которые есть. <span style=" font-weight:600;">Счетчик не служит для подсчета записей.</span><br /><br /><span style=" font-weight:600;">Q5: Как сымитировать счетчик в отчете?</span><br /><br />A: Заводим текстбокс и задаем ему свойства:<br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">ControlSource = </span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;=1&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">RunningSum = Over All</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-weight:600;">Q6: Как сымитировать счетчик в запросе на добавление?</span><br /><br />A: Пишем функцию примерно такого вида:<br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Function</span><span style=" font-family:'Courier New,courier';"> MyFun(varDummy </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> Variant, Optional iStartValue </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> Variant) </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Static</span><span style=" font-family:'Courier New,courier';"> n </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">If</span><span style=" font-family:'Courier New,courier';"> IsMissing(iStartValue) </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Then</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    MyFun = n</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    n = n + </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    n = iStartValue</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    MyFun = True</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">End</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">If</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">End</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Function</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />В запросе обращаемся к ней дважды:<br /><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">в части WHERE - с параметрами (чтоугодно,N), где N равно нужному начальному значению счетчика;<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">в части SELECT - в качестве первого параметра передавать любое поле из таблицы, второй параметр не указывать.<br /><br />Внимание: упрощать этот код, удаляя из него параметр, передаваемый в части SELECT, - нельзя. Без параметра функция будет вызвана только один раз, а не в каждой записи заново.<br /><br /><span style=" font-weight:600;">Q7: Как сымитировать счетчик в обычном запросе либо ленточной форме?</span><br /><br />A1:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">SELECT</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Select</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#ff00ff;">Sum</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#00008b;">1</span><span style=" font-family:'Courier New,courier';">) </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">From</span><span style=" font-family:'Courier New,courier';"> t </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">AS</span><span style=" font-family:'Courier New,courier';"> p </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Where</span><span style=" font-family:'Courier New,courier';"> p.f&lt;=p1.f), p1.f</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">FROM</span><span style=" font-family:'Courier New,courier';"> t </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">AS</span><span style=" font-family:'Courier New,courier';"> p1</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">ORDER</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">BY</span><span style=" font-family:'Courier New,courier';"> p1.f;</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />A2:<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">SELECT</span><span style=" font-family:'Courier New,courier';"> DCount(</span><span style=" font-family:'Courier New,courier'; color:#ff0000;">&quot;f&quot;</span><span style=" font-family:'Courier New,courier';">, </span><span style=" font-family:'Courier New,courier'; color:#ff0000;">&quot;t&quot;</span><span style=" font-family:'Courier New,courier';">,</span><span style=" font-family:'Courier New,courier'; color:#ff0000;">&quot;f&lt;=&quot;</span><span style=" font-family:'Courier New,courier';"> &amp; CStr(f)), f</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">FROM</span><span style=" font-family:'Courier New,courier';"> t</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">ORDER</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">BY</span><span style=" font-family:'Courier New,courier';"> f;</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Примечание 1. Поле f обязано быть уникальным.<br /><br />Примечание 2. Способ 1 быстрее работает, но является необновляемым.<br /><br />Примечание 3. Аналогичный вопрос в другом разделе FAQ: <a href="http://www.sql.ru/faq/faq_topic.aspx?fid=126"><span style=" text-decoration: underline; color:#0000ff;">http://www.sql.ru/faq/faq_topic.aspx?fid=126</span></a><br /><br />A3: В новых версиях Аксесса у формы есть свойство CurrentRecord.<br /><br /><span style=" font-weight:600;">Q8: Как получить значение счетчика только что добавленной записи?</span><br /><br />A1: Если запись добавляется через рекордсет, то так:<br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.AddNew</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">переменная = rs!полесчетчика</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.Update</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#000000;">'или</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#000000;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> rs = ...OpenRecordset(</span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;...where 1=0&quot;</span><span style=" font-family:'Courier New,courier';">) </span><span style=" font-family:'Courier New,courier'; color:#000000;">'обязательно пустой рекордсет</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.AddNew </span><span style=" font-family:'Courier New,courier'; color:#000000;">'ровно один раз; при добавлении двух и более записей ничего не получится</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.Update</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.MoveFirst</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">переменная = rs!полесчетчика</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#000000;">'или</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#000000;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.AddNew</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.Update</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.Bookmark = rs.LastModified</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">переменная = rs!полесчетчика</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />A2: Более широкий круг применимости у такого способа:<br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New,courier';"> rs </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">As</span><span style=" font-family:'Courier New,courier';"> ADODB.Recordset </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">Set</span><span style=" font-family:'Courier New,courier';"> rs = </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">New</span><span style=" font-family:'Courier New,courier';"> ADODB.Recordset</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">CurrentProject.Connection.Execute </span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;INSERT ...&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Open</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#008080;">&quot;SELECT @@identity as cou&quot;</span><span style=" font-family:'Courier New,courier';">, CurrentProject.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">переменная = rs!cou</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">rs.</span><span style=" font-family:'Courier New,courier'; color:#0000ff;">Close</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Однако и этот способ имеет ограничения, а именно:<br /><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">работает либо через ADO, либо через DAO в Jet 4 и позже, и только с базами формата Аксесса 2000 и позже;<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">возвращает значение только из записи, добавленной программно, но не через юзер-интерфейс.<br /><br />A3: Для adp годится такая модификация того же способа:<br /><br /></p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#0000ff;">SELECT</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#ff00ff;">SCOPE_IDENTITY</span><span style=" font-family:'Courier New,courier';">() </span><span style=" font-family:'Courier New,courier'; color:#0000ff;">AS</span><span style=" font-family:'Courier New,courier';"> [SCOPE_IDENTITY]</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-weight:600;">Q9: Как создать одним запросом таблицу со счетчиком?</span><br /><br />A: create table xx (id counter)</p></body></html>