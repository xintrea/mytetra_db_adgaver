<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://excelvba.ru/articles/WinAPI"><span style=" text-decoration: underline; color:#0000ff;">Различие в вызовах функций WinAPI в зависимости от версий Windows и Office</span></a> </p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://excelvba.ru/articles"><span style=" text-decoration: underline; color:#0000ff;">Статьи</span></a> </li></ul></td></tr></table>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Поскольку в приложениях Office 2010 встроен другой VBA (VBA7), в отличие от ранних версий Excel, требуется предусмотреть в коде макросов различных варианты вызова API-функций Windows, чтобы они сохранили свою работоспособность при работе в любой версии Office.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Кроме того, в 64-битных Windows синтаксис вызова функций WinAPI тоже немного отличается от 32-битных систем.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В общем случае, <span style=" font-weight:600;">код, корректно работающий в 64-битной Windows</span>, будет выглядеть примерно так:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#If Win64 </span><span style=" font-family:'monospace'; color:#000080;">Then</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> MyMathFunc </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;User32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> N </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> MyMathFunc </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;User32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> N </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А это код, который не будет выдавать ошибку при работе в <span style=" font-weight:600;">Office 2010</span>:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#If VBA7 </span><span style=" font-family:'monospace'; color:#000080;">Then</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> PtrSafe </span><span style=" font-family:'monospace'; color:#000080;">Sub</span><span style=" font-family:'monospace';"> MessageBeep </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;User32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> N </span><span style=" font-family:'monospace'; color:#000080;">AS</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Sub</span><span style=" font-family:'monospace';"> MessageBeep </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;User32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> N </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Как же добиться работоспособности кода на любом компьютере?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А вот как: <span style=" font-weight:600;">добавляйте описания функций WinAPI для всех возможных конфигураций</span>. Например, ниже приведён универсальный код для вызова WinAPI функции <span style=" font-weight:600; font-style:italic;">URLDownloadToFile</span>: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#If Win64 </span><span style=" font-family:'monospace'; color:#000080;">Then</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #If VBA7 </span><span style=" font-family:'monospace'; color:#000080;">Then</span><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#008000;">' Windows x64, Office 2010</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">        </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> PtrSafe </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> URLDownloadToFile </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;urlmon&quot;</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Alias</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;URLDownloadToFileA&quot;</span><span style=" font-family:'monospace';"> _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">                (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> pCaller </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> szURL </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">String</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> szFileName </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">String</span><span style=" font-family:'monospace';">, _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">                 </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwReserved </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> lpfnCB </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #Else    </span><span style=" font-family:'monospace'; color:#008000;">' Windows x64,Office 2003-2007</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">        </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> URLDownloadToFile </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;urlmon&quot;</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Alias</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;URLDownloadToFileA&quot;</span><span style=" font-family:'monospace';"> _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">                                           (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> pCaller </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> szURL </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">String</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> szFileName </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">String</span><span style=" font-family:'monospace';">, _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">                                            </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwReserved </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> lpfnCB </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #If VBA7 </span><span style=" font-family:'monospace'; color:#000080;">Then</span><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#008000;">' Windows x86, Office 2010</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">        </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> PtrSafe </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> URLDownloadToFile </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;urlmon&quot;</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Alias</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;URLDownloadToFileA&quot;</span><span style=" font-family:'monospace';"> _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">                (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> pCaller </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> szURL </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">String</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> szFileName </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">String</span><span style=" font-family:'monospace';">, _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">                 </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwReserved </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> lpfnCB </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #Else    </span><span style=" font-family:'monospace'; color:#008000;">' Windows x86, Office 2003-2007</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">        </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> URLDownloadToFile </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;urlmon&quot;</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Alias</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;URLDownloadToFileA&quot;</span><span style=" font-family:'monospace';"> _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">                                           (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> pCaller </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> szURL </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">String</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> szFileName </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">String</span><span style=" font-family:'monospace';">, _</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">                                            </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwReserved </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> lpfnCB </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Более подробно тема описана <a href="http://msdn.microsoft.com/en-us/library/ee691831(office.14).aspx"><span style=" text-decoration: underline; color:#0000ff;">на сайте Microsoft</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ещё один пример - универсальная декларация функции <span style=" font-weight:600;">GetTickCount</span>:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#If Win64 </span><span style=" font-family:'monospace'; color:#000080;">Then</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #If VBA7 </span><span style=" font-family:'monospace'; color:#000080;">Then</span><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#008000;">' Windows x64, Office 2010</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">        </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> PtrSafe </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> GetTickCount </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;Kernel32&quot;</span><span style=" font-family:'monospace';"> () </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #Else    </span><span style=" font-family:'monospace'; color:#008000;">' Windows x64,Office 2003-2007</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">        </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> GetTickCount </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;Kernel32&quot;</span><span style=" font-family:'monospace';"> () </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongLong</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #If VBA7 </span><span style=" font-family:'monospace'; color:#000080;">Then</span><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#008000;">' Windows x86, Office 2010</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">        </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> PtrSafe </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> GetTickCount </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;Kernel32&quot;</span><span style=" font-family:'monospace';"> () </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #Else    </span><span style=" font-family:'monospace'; color:#008000;">' Windows x86, Office 2003-2007</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">        </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> GetTickCount </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;Kernel32&quot;</span><span style=" font-family:'monospace';"> () </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    #End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">(добавлено позже)</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вообще, код достаточно писать в 2 вариантах (ветку Win64 не обязательно прописывать)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для функций GetKeyState и Sleep, код будет выглядеть так:<br />(чтобы работало во всех версиях Office и Windows)</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#If VBA7 </span><span style=" font-family:'monospace'; color:#000080;">Then</span><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#008000;">'  Office 2010</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> PtrSafe </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> GetKeyState </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;user32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> nVirtKey </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Integer</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> PtrSafe </span><span style=" font-family:'monospace'; color:#000080;">Sub</span><span style=" font-family:'monospace';"> Sleep </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;Kernel32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwMilliseconds </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#Else    </span><span style=" font-family:'monospace'; color:#008000;">'  Office 2003-2007</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> GetKeyState </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;user32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> nVirtKey </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Integer</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Sub</span><span style=" font-family:'monospace';"> Sleep </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;Kernel32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwMilliseconds </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">----------------<br />(добавлено ещё позже)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ну а ещё правильнее будет написать так:<br />(c использованием LongPtr для версий Office, начиная с 2010)<br /></p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#If VBA7 </span><span style=" font-family:'monospace'; color:#000080;">Then</span><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#008000;">'  Office 2010-2013</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> PtrSafe </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> Beep </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;kernel32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwFreq </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongPtr, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwDuration </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongPtr) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> LongPtr</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#Else    </span><span style=" font-family:'monospace'; color:#008000;">'  Office 2003-2007</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">    </span><span style=" font-family:'monospace'; color:#000080;">Declare</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Function</span><span style=" font-family:'monospace';"> Beep </span><span style=" font-family:'monospace'; color:#000080;">Lib</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#800000;">&quot;kernel32&quot;</span><span style=" font-family:'monospace';"> (</span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwFreq </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">, </span><span style=" font-family:'monospace'; color:#000080;">ByVal</span><span style=" font-family:'monospace';"> dwDuration </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span><span style=" font-family:'monospace';">) </span><span style=" font-family:'monospace'; color:#000080;">As</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#000080;">Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">#End </span><span style=" font-family:'monospace'; color:#000080;">If</span></pre>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">25129 просмотров </li></ul></td>
<td></td></tr></table></body></html>