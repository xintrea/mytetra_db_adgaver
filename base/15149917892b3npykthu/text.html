<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как собрать данные с нескольких листов или книг? </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Очень часто бывает необходимо собрать данные с нескольких листов одной книги или даже с листов нескольких книг. Например, каждую неделю мы получаем некие отчеты от отделов, которые необходимо собрать в одну общую таблицу для построения </span><a href="http://www.excel-vba.ru/chto-umeet-excel/obshhie-svedeniya-o-svodnyx-tablicax/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">сводной таблицы</span></a><span style=" font-size:8.25pt;">. Или это могут быть некие книги прайсов по товарам от разных поставщиком, который опять же надо сначала объединить, а потом уже анализировать. Вручную делать это довольно муторно. И то, муторно это только для первых 20-ти листов/файлов, потом становится просто тошно. Поэтому решил поделиться решением, которое поможет собрать данные со всех листов книги, со всех листов всех указанных книг или только с указанных листов: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4cf03fce042120144191"></a><span style=" font-size:8.25pt;">'</span><span style=" font-size:8.25pt;">--------------------------------------------------------------------------------------- ' Module : mConsolidated ' DateTime : 02.02.2010 17:06 ' Author : The_Prist(Щербаков Дмитрий) ' Purpose : http://www.excel-vba.ru/chto-umeet-excel/kak-sobrat-dannye-s-neskolkix-listov-ili-knig/ ' Процедура сбора данных с нескольких листов/книг '--------------------------------------------------------------------------------------- Option Explicit Sub Consolidated_Range_of_Books_and_Sheets() Dim iBeginRange As Object, lCalc As Long, lCol As Long Dim oAwb As String, sCopyAddress As String, sSheetName As String Dim lLastrow As Long, lLastRowMyBook As Long, li As Long, iLastColumn As Integer Dim wsSh As Object, wsDataSheet As Object, bPolyBooks As Boolean, avFiles Dim wbAct As Workbook Dim bPasteValues As Boolean On Error Resume Next 'Выбираем диапазон выборки с книг Set iBeginRange = Application.InputBox(&quot;Выберите диапазон сбора данных.&quot; &amp; vbCrLf &amp; _ &quot;1. При выборе только одной ячейки данные будут собраны со всех листов начиная с этой ячейки. &quot; &amp; _ vbCrLf &amp; &quot;2. При выделении нескольких ячеек данные будут собраны только с указанного диапазона всех листов.&quot;, Type:=8) 'для указания диапазона без диалогового окна: 'Set iBeginRange = Range(&quot;A1:A10&quot;) 'диапазон указывается нужный 'Если диапазон не выбран - завершаем процедуру If iBeginRange Is Nothing Then Exit Sub 'Указываем имя листа 'Допустимо указывать в имени листа символы подставки ? и *. 'Если указать только * то данные будут собираться со всех листов sSheetName = InputBox(&quot;Введите имя листа, с которого собирать данные(если не указан, то данные собираются со всех листов)&quot;, &quot;Параметр&quot;) 'Если имя листа не указано - данные будут собраны со вех листов If sSheetName = &quot;&quot; Then sSheetName = &quot;*&quot; On Error GoTo 0 'Запрос - вставлять на результирующий лист все данные 'или только значения ячеек (без формул и форматов) bPasteValues = (MsgBox(&quot;Вставлять только значения?&quot;, vbQuestion + vbYesNo, &quot;Excel-VBA&quot;) = vbYes) 'Запрос сбора данных с книг(если Нет - то сбор идет с активной книги) If MsgBox(&quot;Собрать данные с нескольких книг?&quot;, vbInformation + vbYesNo, &quot;Excel-VBA&quot;) = vbYes Then avFiles = Application.GetOpenFilename(&quot;Excel files(*.xls*),*.xls*&quot;, , &quot;Выбор файлов&quot;, , True) If VarType(avFiles) = vbBoolean Then Exit Sub bPolyBooks = True lCol = 1 Else avFiles = Array(ThisWorkbook.FullName) End If 'отключаем обновление экрана, автопересчет формул и отслеживание событий 'для скорости выполнения кода и для избежания ошибок, если в книгах есть иные коды With Application lCalc = .Calculation .ScreenUpdating = False: .EnableEvents = False: .Calculation = xlManual End With 'создаем новый лист в книге для сбора Set wsDataSheet = ActiveWorkbook.Sheets.Add(After:=Sheets(Sheets.Count)) 'если нужно сделать сбор данных на новый лист книги с кодом 'Set wsDataSheet = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count)) 'цикл по книгам For li = LBound(avFiles) To UBound(avFiles) If bPolyBooks Then Set wbAct = Workbooks.Open(Filename:=avFiles(li)) Else Set wbAct = ThisWorkbook End If oAwb = wbAct.Name 'цикл по листам For Each wsSh In wbAct.Sheets If wsSh.Name Like sSheetName Then 'Если имя листа совпадает с именем листа, в который собираем данные 'и сбор идет только с активной книги - то переходим к следующему листу If wsSh.Name = wsDataSheet.Name And bPolyBooks = False Then GoTo NEXT_ With wsSh Select Case iBeginRange.Count Case 1 'собираем данные начиная с указанной ячейки и до конца данных lLastrow = .Cells(1, 1).SpecialCells(xlLastCell).Row iLastColumn = .Cells.SpecialCells(xlLastCell).Column sCopyAddress = .Range(.Cells(iBeginRange.Row, iBeginRange.Column), .Cells(lLastrow, iLastColumn)).Address Case Else 'собираем данные с фиксированного диапазона sCopyAddress = iBeginRange.Address End Select lLastRowMyBook = wsDataSheet.Cells.SpecialCells(xlLastCell).Row + 1 'вставляем имя книги, с которой собраны данные If lCol Then wsDataSheet.Cells(lLastRowMyBook, 1).Resize(Range(sCopyAddress).Rows.Count).Value = oAwb If bPasteValues Then 'если вставляем только значения .Range(sCopyAddress).Copy wsDataSheet.Cells(lLastRowMyBook, 1).Offset(, lCol).PasteSpecial xlPasteValues Else .Range(sCopyAddress).Copy wsDataSheet.Cells(lLastRowMyBook, 1).Offset(, lCol) End If End With End If NEXT_: Next wsSh If bPolyBooks Then wbAct.Close False Next li With Application .ScreenUpdating = True: .EnableEvents = True: .Calculation = lCalc End With End Sub </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:8.25pt;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">9</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">10</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">11</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">12</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">13</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">14</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">15</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">16</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">17</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">18</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">19</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">20</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">21</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">22</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">23</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">24</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">25</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">26</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">27</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">28</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">29</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">30</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">31</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">32</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">33</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">34</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">35</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">36</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">37</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">38</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">39</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">40</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">41</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">42</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">43</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">44</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">45</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">46</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">47</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">48</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">49</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">50</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">51</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">52</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">53</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">54</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">55</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">56</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">57</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">58</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">59</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">60</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">61</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">62</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">63</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">64</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">65</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">66</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">67</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">68</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">69</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">70</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">71</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">72</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">73</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">74</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">75</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">76</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">77</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">78</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">79</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">80</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">81</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">82</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">83</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">84</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">85</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">86</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">87</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">88</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">89</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">90</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">91</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">92</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">93</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">94</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">95</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">96</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">97 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4cf03fce042120144191-1"></a><span style=" font-size:8.25pt;">'</span><span style=" font-size:8.25pt;">---------------------------------------------------------------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-2"></a><span style=" font-size:8.25pt;">'</span><span style=" font-size:8.25pt;"> Module    : mConsolidated</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-3"></a><span style=" font-size:8.25pt;">'</span><span style=" font-size:8.25pt;"> DateTime  : 02.02.2010 17:06</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-4"></a><span style=" font-size:8.25pt;">'</span><span style=" font-size:8.25pt;"> Author    : The_Prist(Щербаков Дмитрий)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-5"></a><span style=" font-size:8.25pt;">'</span><span style=" font-size:8.25pt;"> Purpose   : http://www.excel-vba.ru/chto-umeet-excel/kak-sobrat-dannye-s-neskolkix-listov-ili-knig/</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-6"></a><span style=" font-size:8.25pt;">'</span><span style=" font-size:8.25pt;">             Процедура сбора данных с нескольких листов/книг</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-7"></a><span style=" font-size:8.25pt;">'</span><span style=" font-size:8.25pt;">---------------------------------------------------------------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-8"></a><span style=" font-size:8.25pt;">O</span><span style=" font-size:8.25pt;">ption Explicit</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-9"></a><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-10"></a><span style=" font-size:8.25pt;">S</span><span style=" font-size:8.25pt;">ub Consolidated_Range_of_Books_and_Sheets()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-11"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Dim iBeginRange As Object, lCalc As Long, lCol As Long</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-12"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Dim oAwb As String, sCopyAddress As String, sSheetName As String</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-13"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Dim lLastrow As Long, lLastRowMyBook As Long, li As Long, iLastColumn As Integer</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-14"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Dim wsSh As Object, wsDataSheet As Object, bPolyBooks As Boolean, avFiles</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-15"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Dim wbAct As Workbook</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-16"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Dim bPasteValues As Boolean</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-17"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-18"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   On Error Resume Next</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-19"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Выбираем диапазон выборки с книг</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-20"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Set iBeginRange = Application.InputBox(&quot;Выберите диапазон сбора данных.&quot; &amp; vbCrLf &amp; _</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-21"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                                          &quot;1. При выборе только одной ячейки данные будут собраны со всех листов начиная с этой ячейки. &quot; &amp; _</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-22"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                                          vbCrLf &amp; &quot;2. При выделении нескольких ячеек данные будут собраны только с указанного диапазона всех листов.&quot;, Type:=8)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-23"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'для указания диапазона без диалогового окна:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-24"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Set iBeginRange = Range(&quot;A1:A10&quot;) 'диапазон указывается нужный</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-25"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Если диапазон не выбран - завершаем процедуру</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-26"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   If iBeginRange Is Nothing Then Exit Sub</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-27"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Указываем имя листа</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-28"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Допустимо указывать в имени листа символы подставки ? и *.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-29"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Если указать только * то данные будут собираться со всех листов</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-30"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   sSheetName = InputBox(&quot;Введите имя листа, с которого собирать данные(если не указан, то данные собираются со всех листов)&quot;, &quot;Параметр&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-31"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Если имя листа не указано - данные будут собраны со вех листов</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-32"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   If sSheetName = &quot;&quot; Then sSheetName = &quot;*&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-33"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   On Error GoTo 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-34"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Запрос - вставлять на результирующий лист все данные</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-35"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'или только значения ячеек (без формул и форматов)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-36"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   bPasteValues = (MsgBox(&quot;Вставлять только значения?&quot;, vbQuestion + vbYesNo, &quot;Excel-VBA&quot;) = vbYes)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-37"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Запрос сбора данных с книг(если Нет - то сбор идет с активной книги)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-38"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   If MsgBox(&quot;Собрать данные с нескольких книг?&quot;, vbInformation + vbYesNo, &quot;Excel-VBA&quot;) = vbYes Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-39"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       avFiles = Application.GetOpenFilename(&quot;Excel files(*.xls*),*.xls*&quot;, , &quot;Выбор файлов&quot;, , True)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-40"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       If VarType(avFiles) = vbBoolean Then Exit Sub</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-41"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       bPolyBooks = True</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-42"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       lCol = 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-43"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-44"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       avFiles = Array(ThisWorkbook.FullName)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-45"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-46"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'отключаем обновление экрана, автопересчет формул и отслеживание событий</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-47"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'для скорости выполнения кода и для избежания ошибок, если в книгах есть иные коды</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-48"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   With Application</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-49"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       lCalc = .Calculation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-50"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       .ScreenUpdating = False: .EnableEvents = False: .Calculation = xlManual</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-51"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   End With</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-52"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'создаем новый лист в книге для сбора</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-53"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Set wsDataSheet = ActiveWorkbook.Sheets.Add(After:=Sheets(Sheets.Count))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-54"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'если нужно сделать сбор данных на новый лист книги с кодом</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-55"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'Set wsDataSheet = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-56"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   'цикл по книгам</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-57"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   For li = LBound(avFiles) To UBound(avFiles)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-58"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       If bPolyBooks Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-59"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">           Set wbAct = Workbooks.Open(Filename:=avFiles(li))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-60"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-61"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">           Set wbAct = ThisWorkbook</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-62"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-63"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       oAwb = wbAct.Name</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-64"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       'цикл по листам</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-65"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       For Each wsSh In wbAct.Sheets</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-66"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">           If wsSh.Name Like sSheetName Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-67"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">               'Если имя листа совпадает с именем листа, в который собираем данные</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-68"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">               'и сбор идет только с активной книги - то переходим к следующему листу</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-69"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">               If wsSh.Name = wsDataSheet.Name And bPolyBooks = False Then GoTo NEXT_</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-70"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">               With wsSh</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-71"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   Select Case iBeginRange.Count</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-72"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   Case 1 'собираем данные начиная с указанной ячейки и до конца данных</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-73"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                       lLastrow = .Cells(1, 1).SpecialCells(xlLastCell).Row</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-74"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                       iLastColumn = .Cells.SpecialCells(xlLastCell).Column</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-75"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                       sCopyAddress = .Range(.Cells(iBeginRange.Row, iBeginRange.Column), .Cells(lLastrow, iLastColumn)).Address</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-76"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   Case Else 'собираем данные с фиксированного диапазона</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-77"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                       sCopyAddress = iBeginRange.Address</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-78"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   End Select</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-79"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   lLastRowMyBook = wsDataSheet.Cells.SpecialCells(xlLastCell).Row + 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-80"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   'вставляем имя книги, с которой собраны данные</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-81"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   If lCol Then wsDataSheet.Cells(lLastRowMyBook, 1).Resize(Range(sCopyAddress).Rows.Count).Value = oAwb</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-82"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   If bPasteValues Then 'если вставляем только значения</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-83"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                       .Range(sCopyAddress).Copy</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-84"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                       wsDataSheet.Cells(lLastRowMyBook, 1).Offset(, lCol).PasteSpecial xlPasteValues</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-85"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-86"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                       .Range(sCopyAddress).Copy wsDataSheet.Cells(lLastRowMyBook, 1).Offset(, lCol)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-87"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">                   End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-88"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">               End With</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-89"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">           End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-90"></a><span style=" font-size:8.25pt;">N</span><span style=" font-size:8.25pt;">EXT_:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-91"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       Next wsSh</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-92"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       If bPolyBooks Then wbAct.Close False</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-93"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   Next li</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-94"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   With Application</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-95"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">       .ScreenUpdating = True: .EnableEvents = True: .Calculation = lCalc</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-96"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   End With</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4cf03fce042120144191-97"></a><span style=" font-size:8.25pt;">E</span><span style=" font-size:8.25pt;">nd Sub</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Приведенный выше код необходимо вставить в стандартный модуль(</span><a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-modul-kakie-byvayut-moduli#StandartModule"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Что такое модуль? Какие бывают модули?</span></a><span style=" font-size:8.25pt;">). Выполнить его можно будет из этой книги нажатием клавиш </span><span style=" font-size:8.25pt; font-weight:600;">Alt</span><span style=" font-size:8.25pt;">+</span><span style=" font-size:8.25pt; font-weight:600;">F8</span><span style=" font-size:8.25pt;">. В появившемся окне выбрать Consolidated_Range_of_Books_and_Sheets и нажать Выполнить. Так же можно </span><a href="http://www.excel-vba.ru/chto-umeet-excel/kak-sozdat-knopku-dlya-vyzova-makrosa-na-liste/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">создать на листе кнопку</span></a><span style=" font-size:8.25pt;"> и назначить ей данный макрос. Так же, если впервые работаете с макросами настоятельно рекомендую прочитать статью: </span><a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-makros-i-gde-ego-iskat/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Что такое макрос и где его искать?</span></a><span style=" font-size:8.25pt;">, а так же </span><a href="http://www.excel-vba.ru/chto-umeet-excel/pochemu-ne-rabotaet-makros/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Почему не работает макрос?</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">После вызова макроса поочередно будут появляется запросы, в которых надо будет указать исходные параметры:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Диапазон сбора данных - Если в окне выбора диапазона выбрать только одну ячейку, то данные будут собраны со всех листов книги/книг, начиная с этой ячейки и до последней ячейки листа.<br />Если выбрать несколько ячеек, данные будут собраны только с указанного диапазона всех листов книги/книг.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имя листа - Необязателен для указания. Если не указан - данные будут собраны со всех листов. Указать можно как точное соответствие имени листа, так и с частичным соответствием. Например, если в книгах для сбора данных необходимо собрать данные только с листа &quot;Январь&quot;, то следует так и указать - &quot;Январь&quot;. Если требуется собрать данные только с листов, начинающихся с &quot;Продажи&quot;(&quot;Продажи ЮГ&quot;, &quot;Продажи НН&quot;, &quot;Продажи Запад&quot; и т.д.), то следует применить символ подстановки звездочку - &quot;Продажи*&quot;. Если надо собрать с листов, содержащих в имени &quot;продажи&quot;(&quot;Итоговые продажи ЮГ&quot;, &quot;Продажи НН&quot;, &quot;Сезонные продажи&quot; и т.д.), то указываем &quot;*продажи*&quot;. Если надо собрать только с листа &quot;Сезонные продажи&quot;, но известно, что вместо пробела может быть нижнее подчеркивание или тире(&quot;Сезонные продажи&quot;, &quot;Сезонные_продажи&quot;, &quot;Сезонные-продажи&quot;) или иной символ, то можно также применить звездочку - &quot;Сезонные*продажи&quot;. Но если среди листов могут встречаться и такие как &quot;Сезонные разовые продажи&quot;, &quot;Сезонные корпоративные продажи&quot; и т.п., но информацию с них собирать не надо, то можно применить вопросительный знак - &quot;Сезонные?продажи&quot;. Вопросительный знак заменяет любой один символ, звездочка - любое количество любых символов.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее появится запрос: Вставлять только значения? - если выбрать <span style=" font-weight:600;">Да</span>, то в результирующий лист с листов будут вставлены исключительно значения ячеек (без формул, форматов, заливки ячеек, цвета шрифта и т.п.). Может пригодится, если на листах для сбора записаны формулы, ссылающиеся на другие листы, книги, диапазоны. При обычном копировании может случиться так, что формула выдаст ошибку, т.к. в книге для вставки нет таких листов и диапазонов или данные расположены иначе. Если выбрать <span style=" font-weight:600;">Нет</span>, то все ячейки с листов на результирующий будут копироваться в точности как в исходных листах.</li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">И последний запрос: Собрать данные с нескольких книг? - если выбрать <span style=" font-weight:600;">Да</span>, то появится диалоговое окно выбора файлов. Надо указать все файлы, данные с которых необходимо собрать. Если выбрать <span style=" font-weight:600;">Нет</span>, то данные будут собираться с листов только активной книги.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Данные будут собраны на новый лист книги с макросом. Если данные собирались с нескольких книг, то в первый столбец будут занесены имена книг, с которых собраны данные.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Если после сбора данных обнаружили, что после каждого файла/листа много пустых строк, то следует найти в коде строку:<br /></span><a name="crayon-5a4cf03fce053426843461"></a><span style=" font-size:8.25pt;">l</span><span style=" font-size:8.25pt;">Lastrow = .Cells(1, 1).SpecialCells(xlLastCell).Row</span><span style=" font-size:8.25pt;"><br />и заменить её на строку примерно следующего содержания:<br /></span><a name="crayon-5a4cf03fce059418699417"></a><span style=" font-size:8.25pt;">l</span><span style=" font-size:8.25pt;">Lastrow = .Cells(.Rows.Count, 1).End(xlUp).Row</span><span style=" font-size:8.25pt;"><br />где 1 - это номер столбца на листах данных, в котором искать последнюю заполненную ячейку. <br />Актуально это для файлов с одинаковой структурой. Например, если сбор идет с листов по продажам, то вполне может быть такое, что в столбце 1 может не быть данных. Поэтому следует определить номер столбца, в котором наполнение данных максимально. Например, это может быть столбец с наименованиями товара или с суммами. Если это столбец D, то следует строку записать так:<br /></span><a name="crayon-5a4cf03fce05e922334396"></a><span style=" font-size:8.25pt;">l</span><span style=" font-size:8.25pt;">Lastrow = .Cells(.Rows.Count, 4).End(xlUp).Row 'ищем последнюю строку в 4-м столбце</span><span style=" font-size:8.25pt;"><br />Подробнее про определение последней строки можно прочитать в статье: </span><a href="http://www.excel-vba.ru/chto-umeet-excel/kak-opredelit-poslednyuyu-yachejku-na-liste-cherez-vba/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Как определить последнюю ячейку на листе через VBA?</span></a></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt; font-weight:600;">Важное замечание:</span><span style=" font-size:8.25pt;"> Если вы используете Excel 2007 и выше и файлы для сбора данных тоже в этом формате, то следует скачанный файл сначала сохранить в формат &quot;Книга Excel с поддержкой макросов(.xlsm)&quot;, закрыть и открыть заново. Иначе есть шанс получить ошибку при сборе данных, т.к. Excel будет в режиме совместимости и не сможет поместить на результирующий лист более 65536 строк.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Скачать пример: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image25018.png" /><span style=" font-size:8.25pt;">  </span><a href="http://www.excel-vba.ru/download/25/"><span style=" font-size:8.25pt; font-weight:600; text-decoration: underline; color:#0000ff;">Tips_Macro_Consolidated.xls</span></a><span style=" font-size:8.25pt;"> (50,0 KiB, 26 836 скачиваний)</span></p></body></html>