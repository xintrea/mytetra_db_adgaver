<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Отлов ошибок и отладка кода VBA </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Очень часто начинающие работать в VBA сталкиваются с различными ошибками, которые выдает код в момент выполнения. Если не знать как поступить в данном случае – то очень сложно будет исправить код быстро, а то и вообще невозможно будет определить причину ошибки без помощи более &quot;продвинутых&quot; пользователей. Новички зачастую делают правки наугад, что может порождать иные ошибки, а это в свою очередь не только затрудняет поиск первоначальной ошибки, но и может привести к невозможности исправить код вообще. Поэтому в этой статье я решил описать как производить отладку кода и определять ошибки.<br />Чтобы описанное в статье можно было сразу опробовать в практике советую скачать файл пример:</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image31266.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">  </span><a href="http://www.excel-vba.ru/download/102/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; text-decoration: underline; color:#0000ff;">Пример таблицы и кода</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> (35,5 KiB, 1 078 скачиваний)</span><span style=" font-size:8.25pt;"> </span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<hr width="100%"/>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Что будет рассмотрено:</span><span style=" font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.excel-vba.ru/chto-umeet-excel/otlov-oshibok-i-otladka-koda-vba/#tips_vba_debug_onerror"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Способы отладки кода в момент появления ошибки</span></a> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.excel-vba.ru/chto-umeet-excel/otlov-oshibok-i-otladka-koda-vba/#tips_vba_debug_locals_watches"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Использование окон Locals и Watches для отладки</span></a> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.excel-vba.ru/chto-umeet-excel/otlov-oshibok-i-otladka-koda-vba/#tips_vba_debug_stepbystep"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Пошаговая отладка кода - что это такое, как и когда применять</span></a> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.excel-vba.ru/chto-umeet-excel/otlov-oshibok-i-otladka-koda-vba/#tips_vba_debug_onerrorresume"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Ошибок нет, но код все равно не выполняется</span></a> </li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Помимо этого в конце статьи можно скачать файл с кодами ошибок VBA и их расшифровками.</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Исходные данные<br />Допустим, имеется простая таблица<br /></span><img src="image23775.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />И код, который должен пройтись по каждой строке таблицы, перемножить цену (столбец </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Цена</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) на количество (столбец </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Продажи шт</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">), просуммировать перемноженные данные и вывести результирующую сумму в ячейку В17:</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Option Explicit Sub PrimitiveCode() Dim lr As Long, dblSumm As Double, dblIncr As Double 'цикл от первой строки таблицы до последней For lr = 1 To 14 'перемножение Цены на Количество (C*E) dblIncr = Cells(l, 3).Value * Cells(lr, 5).Value 'прибавление результата к переменной общей суммы dblSumm = dblSumm + dblIncr Next 'выводим результат в ячейку B17 Cells(17, 2).Value = dblSumm End Sub</span><span style=" font-size:8.25pt;"> </span></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td style=" padding-left:0; padding-right:0; padding-top:0; padding-bottom:0;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">Option Explicit </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">Sub PrimitiveCode() </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Dim lr As Long, dblSumm As Double, dblIncr As Double </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'цикл от первой строки таблицы до последней </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    For lr = 1 To 14 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        'перемножение Цены на Количество (C*E) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        dblIncr = Cells(l, 3).Value * Cells(lr, 5).Value </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        'прибавление результата к переменной общей суммы </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        dblSumm = dblSumm + dblIncr </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Next </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'выводим результат в ячейку B17 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Cells(17, 2).Value = dblSumm </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">End Sub </span></p></td>
<td style=" padding-left:0; padding-right:0; padding-top:0; padding-bottom:0;"></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="tips_vba_debug_onerror"></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br /></span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> <br />Отладка кода в момент появления ошибки<br />Если посмотреть на код выше, то опытный программист VBA сразу поймет, что в таком виде код работать не будет – не выполнится и одна строка. Сразу появится ошибка:<br /></span><img src="image31318.png" /><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Ошибка означает, что внутри кода есть переменная, которая ранее не была объявлена.<br />Сама переменная, которую VBA считает не объявленной будет выделена:<br /></span><img src="image27673.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />Подробнее об этой ошибке и её причинах можно почитать в статье: </span><a href="http://www.excel-vba.ru/chto-umeet-excel/variable-not-defined-ili-chto-takoe-option-explicit-i-zachem-ono-nuzhno/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Variable not defined или что такое Option Explicit и зачем оно нужно?</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />Если кратко, то переменной </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">l</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> нет среди объявленных переменных</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">(Dim l As)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и мы не можем её использовать. В данном случае это опечатка и там должна быть </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">lr</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, а не </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">l</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Исправляем переменную и код будет выглядеть так:</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Sub PrimitiveCode() Dim lr As Long, dblSumm As Double, dblIncr As Double 'цикл от первой строки таблицы до последней For lr = 1 To 14 'перемножение Цены на Количество (C*E) dblIncr = Cells(lr, 3).Value * Cells(lr, 5).Value 'прибавление результата к переменной общей суммы dblSumm = dblSumm + dblIncr Next 'выводим результат в ячейку B17 Cells(17, 2).Value = dblSumm End Sub</span><span style=" font-size:8.25pt;"> </span></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td style=" padding-left:0; padding-right:0; padding-top:0; padding-bottom:0;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">Sub PrimitiveCode() </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Dim lr As Long, dblSumm As Double, dblIncr As Double </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'цикл от первой строки таблицы до последней </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    For lr = 1 To 14 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        'перемножение Цены на Количество (C*E) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        dblIncr = Cells(lr, 3).Value * Cells(lr, 5).Value </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        'прибавление результата к переменной общей суммы </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        dblSumm = dblSumm + dblIncr </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Next </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'выводим результат в ячейку B17 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Cells(17, 2).Value = dblSumm </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">End Sub </span></p></td>
<td style=" padding-left:0; padding-right:0; padding-top:0; padding-bottom:0;"></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">С виду код теперь выполнен правильно и ошибок вызывать не должен. Однако, если его попытаться выполнить опять получим ошибку – на этот раз ошибку типов данных(Type Mismatch):<br /></span><img src="image9926.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />В момент появления главное нажать </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Debug</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, а не </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">End</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> (если будет желание прочитать про тип ошибки подробнее – можно еще нажать Help, текст будет на английском). VBA подсветит желтым строку, вычисления или операции в которой вызывают ошибку:<br /></span><img src="image15247.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />Теперь самый важный этап – необходимо определить причину ошибки. С виду все хорошо – одна ячейка перемножается на другую. Без опыта сложно сходу понять, что это ошибка типов данных, хоть VBA прямо об этом говорит(Type Mismatch – в переводе &quot;Несовпадение типов&quot;). Поэтому самое надежное в этом случае – это определить значение каждой составляющей той строки, в которой возникла ошибка. В случае с кодом выше можно воспользоваться двумя методами:</span><span style=" font-size:8.25pt;"> </span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Навести курсор мыши на любую переменную(dblSum, lr) и посмотреть всплывающую подсказку, которая показывает имя переменной и её текущее значение:<br /></span><img src="image4278.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />После этого переходим на лист с таблицей и смотрим, какое значение в ячейке первой строки третьего столбца(Cells(1,3)). Там значение </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Закуп цена</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, что явно не является числом. Следовательно перемножить его нельзя, т.к. это текст. Отсюда и ошибка типов – с текстом нельзя производить математические операции. Для вычислений предполагается в данном случае числовой тип данных(Integer,Long,Double).</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Узнать сразу значение ячейки </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Cells(lr, 3).Value</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и ячейки </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Cells(lr, 5).Value</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Наведение курсора мыши в данном случае не даст результата. Как правило наведение курсора мыши не имеет эффекта если это не объявленные как переменные объекты </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">(как в этом случае - Cells)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Такие объекты не всегда могут быть вычислены в памяти в момент отладки. Поэтому чтобы просмотреть значение ячейки сначала необходимо отобразить окно </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Immediate</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">(отобразить можно сочетанием клавиш </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; font-style:italic;">Ctrl</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">+</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; font-style:italic;">G</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;"> или через меню </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; font-style:italic;">View</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">-</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; font-style:italic;">Immediate Window</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Затем скопировать полностью нужную переменную</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">(Cells(i, 3).Value</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) и в окне </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Immediate</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> написать:<br />?<br />и после вопр.знака вставить скопированное. Должно получиться:<br />?Cells(i, 3).Value<br />И нажать </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Enter</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Строкой ниже в этом окне будет выведено значение для объекта</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">(если оно может быть получено)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">:<br /></span><img src="image28909.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />По сути результат будет как и в первом примере – мы увидим, что в ячейке текст. Чем второй метод лучше первого? Тем, что таким образом можно сразу получить значение, не переходя на лист и не выискивая нужный номер строки. Ведь это в примере он равен 1, в реальности же строка может быть и 24451.</span> </li></ol>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<hr width="100%"/>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="tips_vba_debug_locals_watches"></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br /></span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> <br />Окна Locals и Watches<br />Так же для отслеживания значений переменных очень удобно использовать окно </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Locals</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и окно </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Watches</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">.<br />Окно Locals<br />Окно </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Locals</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> отображает все локальные переменные, задействованные в выполняемой в настоящий момент процедуре:<br /></span><img src="image8879.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />Как видно в этом окне отображается имя переменной, её тип и значение. Все хорошо, но в этом окне отображаются исключительно локальные переменные, объявленные на уровне модуля. Переменных других модулей, объявленные как Public и используемые в текущей процедуре там не отображаются. Подробнее про видимость переменных можно узнать в статье: </span><a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-peremennaya-i-kak-pravilno-eyo-obyavit/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Что такое переменная и как правильно её объявить?</span></a><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Окно Watches<br />Окно </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Watches</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> представляет большую ценность – в это окно можно просто &quot;перетащить&quot; нужную переменную или объект и в этом окне будут отражены все данные об имени переменной, её типе и текущем значении:<br /></span><img src="image485.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />Теперь рассмотрим чуть подробнее как перетаскивать в это окно данные. На примере кода выше:</span><span style=" font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Выделяем </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Cells(i, 3).Value</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Не снимая выделения наводим курсор мыши на это выделение</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Зажимаем левую кнопку мыши и не отпуская её переносим курсор в любое место окна Watches</span> </li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Все, данные по переменной загружены и доступны для просмотра. По сути все умеют это делать - процесс очень схож с обычным перемещением файлов и папок по рабочему столу. Выделили и с зажатой левой кнопкой мыши перенесли в нужное место.<br />В чем еще один плюс этого окна – в этом окне можно оставлять эти значения и просматривать в моменты пошаговой отладки только занесенные в это окно переменные(про пошаговую отладку будет рассказано ниже). Если вдруг какая-то переменная/объект стали не нужны для постоянного отслеживания их данных – можно удалить их из окна Watches, чтобы не мешалась. Для этого выделяем переменную-правая кнопка мыши – </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Delete Watch</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Так же можно поиграть с иными пунктами, наибольший интерес из которых на мой взгляд, представляет пункт </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Edit Watch</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. После его нажатия появится окно<br /></span><img src="image964.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />Самые основные пункты в этом окне, важные для отладки:</span><span style=" font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Break Then value Changes</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Если его установить, VBA будет отслеживать значение этой переменной и останавливать код при любом изменении значения переменной. Это может пригодится для отслеживания значений в циклах</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Break Then value Is True</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> – пункт пригодится для переменных с типом Boolean или для логических выражений. Как только переменная или результат выражения примет значение True – код будет остановлен на этой строке.<br />Например, необходимо остановить код, если номер строки будет равен 10(т.е. переменная lr примет значение 10). Тогда выражение будет иметь вид:</span> </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">If lr = 10 Then 'код End if </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">If lr = 10 Then </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">'код </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">End if </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#04056a;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />Тогда надо будет выделить в строке </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">If lr = 10 Then</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> само условное выражение </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">lr = 10</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, перенести её в окно </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Watches</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, выделить строку в окне </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Watches</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> с этим выражением, нажать правую кнопку мыши и выбрать </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Edit Watch</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Выбрать в окне </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Break Then value Is True</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Теперь как только переменная lr достигнет значения 10(т.е. обрабатываться будет 10-я строка таблицы) – код остановится и строка с выражением будет выделена желтым. Можно будет проанализировать другие переменные или продолжить выполнение кода в пошаговом режиме(см.далее).</span><span style=" font-size:8.25pt;"> </span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<hr width="100%"/>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="tips_vba_debug_stepbystep"></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br /></span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> <br /></span><span style=" font-size:13pt; font-weight:600;">Пошаговая отладка кода</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br />После знакомства с отладкой кода при возникновении ошибки работать с пошаговой отладкой будет проще.<br />Что такое вообще пошаговая отладка?<br />Это просмотр этапов выполнения кода строка за строкой.</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Для чего это может быть нужно?</span><span style=" font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Чтобы проанализировать чужой код и понять более точно, что он делает изнутри, а не только увидеть результат его выполнения</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Если вы начинающий программист и часто используете макрорекордер(записываете макросы) - то пошаговая отладка поможет понять какое действия выполняет каждая строка. Это поможет быстрее научиться понимать код и убирать из него лишнее, а так же совмещать различные коды</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Если внутри кода есть ошибка логики выполнения. Это, пожалуй, самая сложная ошибка, т.к. в этом случае VBA не останавливает работу и не говорит об ошибке. Код выполняется без ошибок, но результат не такой, как ожидалось. Это означает, что либо какой-то переменной назначается не то значение, либо какое-то условие неверно или выполняется не в тот момент, в который должно. В общем по сути это ошибка разработчика, не приводящая к ошибкам синтаксиса или типов, которые VBA может отследить.</span> </li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Как делать пошаговую отладку? Все просто: устанавливаете курсор в любом месте внутри кода и нажимаете клавишу </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">F8</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> (либо выбрать в меню </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Degub</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">-</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Step Into</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">). Теперь при каждом нажатии клавиши </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">F8</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> код будет выполнять одну строку кода за другой в той очередности, в которой они расположены в процедуре. Если внутри процедуры будет вызов второй процедуры или функции – код пошагово выполнит и её и затем вернется в основную процедуру.<br />Так же хочу привести еще пару сочетаний клавиш, которые удобно применять при пошаговой отладке:</span><span style=" font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Shift+F8(</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Degub</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">-</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Step Over</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) - выполнение вложенной функции/процедуры без захода в неё. Если внутри основной процедуры или функции выполняется другая процедура или функция и Вы уверены, что она работает правильно - просматривать пошагово весь код вложенной процедуры/функции не имеет смысла. Чтобы вложенная процедура/функция выполнилась без пошагового просмотра надо просто нажать указанное сочетание клавиш тогда, когда строка вызова вложенной процедуры/функции будет подсвечена желтым</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Ctrl+Shift+F8(</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Degub</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">-</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Step Out</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) - завершение вложенной функции/процедуры и выход в основную с остановкой. Если все же перестарались и перешли в пошаговый проход вложенной функции(или сделали это специально, но посмотрели все, что надо) - то нажимаете это сочетание и код быстро выполнить вложенную функцию, перейдет в основную и остановится для дальнейшей пошаговой отладки</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Ctrl+F8(</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Degub</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">-</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Run to Cursor</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">) - выполнение процедуры до строки, в которой на данный момент установлен курсор</span> </li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Точки останова<br />Но куда чаще бывает нужно не просто весь код пройти пошагово, а начать пошаговое выполнение только начиная с какой-либо одной строки, чтобы не мотать строк 40 кода(да еще с циклами) ради достижения одной какой-то строки. Еще точки останова очень полезны при отладке событийных процедур(вроде Worksheet_Change, Worksheet_BeforeDoubleClick, событий элементов форм и т.п.), т.к. они в большинстве своем содержат аргументы и выполнить по F8 их просто невозможно и выполняются они только при наступлении самого события, которые они призваны обработать.<br />Чтобы дать понять VBA на какой строке необходимо будет остановится необходимо установить курсор мыши в любое место нужной строки и нажать </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">F9</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> или </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Debug</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">-</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Toggle Breakpoint</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Строка будет выделена темно-красным цветом.<br />Это еще называется установкой </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">точки останова</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Убрать точку останова можно так же, как она была установлена – </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">F9</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> или </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Debug</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">-</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Toggle Breakpoint</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Так же точку основа можно установить с помощью мыши: для этого необходимо в области левее окна с кодом напротив нужной строки один раз щелкнуть левой кнопкой мыши:<br /></span><img src="image26838.png" /><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Теперь можно запустить код любым удобным способом </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">(в отладке это как правило делается клавишей </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; font-style:italic;">F5</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;"> или с панели: </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; font-style:italic;">Run</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">-</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; font-style:italic;">Run Sub/UserForm</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Как только код дойдет до указанной точки останова он остановится и строка будет подсвечена желтым. Дальше можно либо продолжить выполнение в пошаговом режиме</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">(нажимая </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; font-style:italic;">F8</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">, либо</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-style:italic;">(проверив значения нужных переменных и объектов)</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> нажать опять </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">F5</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> и код продолжит выполняться автоматически, пока не выполнится или не достигнет другой точки останова. Самих же точек останова может быть сколько угодно и расположены они могут быть в любой процедуре или функции.<br />Следует помнить, что после закрытия файла с кодом точки останова не сохраняются и при следующем открытии книги их необходимо будет установить заново, если это необходимо.</span><span style=" font-size:8.25pt;"> </span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<hr width="100%"/>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="tips_vba_debug_onerrorresume"></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"><br /></span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> <br />Ошибок нет, но код все равно не выполняется<br />Еще хочу добавить, что ошибки могут появляться не всегда, даже если они есть. Бывает и так, что код выполняется без ошибок, но однако либо выполняется не так, либо вообще ничего не делает. Как правило причин две:</span><span style=" font-size:8.25pt;"> </span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Логика кода построена неверно и ошибок VBA действительно не возникает. Но т.к. логика неверна - код выполняет не то, что от него ожидается. Решение одно - пошагово выполнить весь код и детально просмотреть всё, чтобы обнаружить в какой строке или строках нарушена логика</span> </li>
<li style=" font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Один из очень распространенных вариантов: в начале кода стоит обработчик ошибок On Error Resume Next и дальше обработчик не отменяется. Данный обработчик указывает VBA, что при возникновении ошибки её следует игнорировать и переходит к выполнению следующего оператора/строки. Таким образом ошибка хоть и возникает, но она пропускается и не показывается, а выполнение кода продолжается как ни в чем не бывало. Однако как правило одна ошибка влечет другую и третью и т.д. и может получиться так, что все строки после первой ошибочной станут так же ошибочными и как следствие не выполнятся. Данный оператор будет применяться либо до конца процедуры, либо до тех пор, пока в коде не будет поставлен иной обработчик ошибок:<br />On Error GoTo </span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Метка</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> - переход выполнения кода к указанной метке(</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600;">Метка</span><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">).<br />On Error GoTo 0 - по сути отменяет условный переход при возникновении ошибок. Метка 0 считается обнулением переходов</span> </li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Один из примеров того, для чего может применяться обработчик ошибок можно найти в статье: </span><a href="http://www.excel-vba.ru/chto-umeet-excel/kak-iz-excel-obratitsya-k-drugomu-prilozheniyu/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; text-decoration: underline; color:#0000ff;">Как из Excel обратиться к другому приложению</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">. Там данный обработчик необходим, чтобы проверить открыто ли уже приложение Word. Если открыто - то ошибка не возникнет. Если же закрыто - то будет ошибка. И этот момент как правило и отслеживается. Я расставил подробные комментарии в коде, чтобы было более понятно что к чему:</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Sub Check_OpenWord() Dim objWrdApp As Object On Error Resume Next 'необходимо, чтобы на первой же строке код не выдал ошибку при закрытом Word 'пытаемся подключится к объекту Word Set objWrdApp = GetObject(, &quot;Word.Application&quot;) 'если Word закрыт - обязательно возникнет ошибка 429, 'указывающая на то, что невозможно подключиться к объекту Word 'при этом переменная objWrdApp будет равняться Nothing, т.к. значение не удалось присвоить If objWrdApp Is Nothing Then 'так же можно использовать и такую строку: 'If Err.Number = 429 Then 'если ошибка 429 - значит Word не запущен - надо создавать новый 'создаем новый экземпляр Set objWrdApp = CreateObject(&quot;Word.Application&quot;) 'делаем приложение видимым. По умолчанию открывается в скрытом режиме objWrdApp.Visible = True Else 'приложение открыто - выдаем сообщение MsgBox &quot;Приложение Word уже открыто&quot;, vbInformation, &quot;Check_OpenWord&quot; End If End Sub</span><span style=" font-size:8.25pt;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td style=" padding-left:0; padding-right:0; padding-top:0; padding-bottom:0;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;"> Sub Check_OpenWord() </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Dim objWrdApp As Object </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    On Error Resume Next 'необходимо, чтобы на первой же строке код не выдал ошибку при закрытом Word </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'пытаемся подключится к объекту Word </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Set objWrdApp = GetObject(, &quot;Word.Application&quot;) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'если Word закрыт - обязательно возникнет ошибка 429, </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'указывающая на то, что невозможно подключиться к объекту Word </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'при этом переменная objWrdApp будет равняться Nothing, т.к. значение не удалось присвоить </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    If objWrdApp Is Nothing Then </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'так же можно использовать и такую строку: </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    'If Err.Number = 429 Then 'если ошибка 429 - значит Word не запущен - надо создавать новый </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        'создаем новый экземпляр </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        Set objWrdApp = CreateObject(&quot;Word.Application&quot;) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        'делаем приложение видимым. По умолчанию открывается в скрытом режиме </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        objWrdApp.Visible = True </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    Else </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        'приложение открыто - выдаем сообщение </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">        MsgBox &quot;Приложение Word уже открыто&quot;, vbInformation, &quot;Check_OpenWord&quot; </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">    End If </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#04056a;">End Sub </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#04056a;"><br /></p></td>
<td style=" padding-left:0; padding-right:0; padding-top:0; padding-bottom:0;"></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Для чего вообще это нужно? Ведь можно создавать новый экземпляр. А дело в том, что не всегда правильно создавать новый - куда правильнее зачастую подключиться к ранее открытому, чем плодить новые экземпляры и захламлять диспетчер задач.<br />Тему обработки ошибок я здесь пока не раскрываю полностью, т.к. это не на один абзац. В одной из следующий статей постараюсь более подробно рассказать как и где их лучше применять и как правильно, а когда лучше вообще воздержаться от их использования.</span><span style=" font-size:8.25pt;"> </span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<hr width="100%"/>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">Конечно, статья не описывает способы устранения ошибок - это просто невозможно. Только известных типов ошибок в VBA более 3 тысяч. Все их упоминать бессмысленно. Целью статьи было помочь начинающим найти строку с ошибкой и рассказать как производить отладку кода при необходимости. А все остальное придет с опытом. Однако на всякий случай я решил выложить файл Excel с описанием большей части ошибок, которые могут возникнуть. В файле указан номер ошибки, описание на английском и описание на русском. Причин ошибки может быть множество, поэтому нет однозначных рекомендаций по устранению каждой из них. Все зависит от данных и от самого кода.</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image31266.png" /><span style=" font-family:'Times New Roman,serif'; font-size:12pt;">  </span><a href="http://www.excel-vba.ru/download/101/"><span style=" font-family:'Times New Roman,serif'; font-size:12pt; font-weight:600; text-decoration: underline; color:#0000ff;">Ошибки VBA с описанием</span></a><span style=" font-family:'Times New Roman,serif'; font-size:12pt;"> (152,0 KiB, 2 022 скачиваний)</span><span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">  </span></p></body></html>