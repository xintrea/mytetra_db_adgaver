<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:6pt; font-weight:600;">Что необходимо для внесения изменений в проект VBA(макросы) программно</span><span style=" font-family:'MS Shell Dlg 2'; font-size:6pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Рано или поздно у разработчика по различным причинам возникает желание внести какие-либо изменения в созданный им код или добавить в только что созданный кодом файл код VBA. Распространенная ситуация: создали файл обработки, разослали пользователям. Потом доработали код VBA, что-то там добавили, улучшили, а заменять файлы пользователей уже нельзя(они там данные вносят и хранят). Изменять отдельно код VBA каждого файла занятие не из самых привлекательных. Вот здесь-то как раз очень бы пригодилось изменять коды программно.<br />О том как именно изменять описано в других статьях, например: </span><a href="http://www.excel-vba.ru/chto-umeet-excel/kak-dobavit-kod-procedury-programmno-skopirovat-modul/"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; text-decoration: underline; color:#0000ff;">Как добавить код процедуры программно, скопировать модуль</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">. Эта же статья посвящена тому, что необходимо знать прежде чем начать вносить изменения.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Итак, работать с объектной моделью проекта VBA нам позволяет библиотека Microsoft Visual Basic For Applications Extensibility. Её можно подключить через меню VBE:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:600;">Tools</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">-</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:600;">References</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">-Microsoft Visual Basic For Applications Extensibility 5.X </span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-style:italic;">(номер может быть другим)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Так же эту библиотеку к проекту можно подключить программно</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-style:italic;">(по идентификатору </span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:600; font-style:italic;">GUID</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-style:italic;">)</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a2a6fcf8cce5991533095"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">T</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">hisWorkbook.VBProject.References.AddFromGuid _ GUID:=&quot;{0002E157-0000-0000-C000-000000000046}&quot;, Major:=5, Minor:=3 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">ThisWorkbook.VBProject.References.AddFromGuid _</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">                  GUID:=&quot;{0002E157-0000-0000-C000-000000000046}&quot;, Major:=5, Minor:=3</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Что мне нравится в VBA так это то, что он допускает обращение к методам и свойствам объектов любой имеющейся библиотеки без её подключения в настройках, чем я постоянно и пользуюсь - в своих кодах я не использую текстовые константы из библиотеки Extensibility, заменив их числовыми. Это избавляет от проверки подключенной библиотеки на ПК конечного пользователя. Подключение же библиотеки позволяет использовать Intellisence для интуитивного просмотра свойст и методов объектов. Бывает очень полезно, если не знаете какое-либо свойство или метод или константу. Подключили библиотеку, подсмотрели, применили.<br />Но куда важнее то, без чего работа с проектом VBA программно невозможна. Я знаю два основных условия:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:9pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Необходимо проставить доверие к проекту VBA: </li>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#008000;">Excel 2010</span>: <span style=" font-weight:600;">Файл</span> -<span style=" font-weight:600;">Параметры</span> -<span style=" font-weight:600;">Центр управления безопасностью</span> -<span style=" font-weight:600;">Параметры макросов</span> -поставить галочку «<span style=" font-weight:600;">Доверять доступ к объектной модели проектов VBA</span>»;</li>
<li style=" font-family:'MS Shell Dlg 2'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#008000;">Excel 2007</span>: <span style=" font-weight:600;">Меню</span> -<span style=" font-weight:600;">Параметры Excel</span> -<span style=" font-weight:600;">Центр управления безопасностью</span> -<span style=" font-weight:600;">Параметры макросов</span> -поставить галочку «<span style=" font-weight:600;">Доверять доступ к объектной модели проектов VBA</span>»;</li>
<li style=" font-family:'MS Shell Dlg 2'; font-size:9pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#008000;">Excel 2003</span>: <span style=" font-weight:600;">Сервис</span> –<span style=" font-weight:600;">Параметры</span> -вкладка <span style=" font-weight:600;">Безопасность</span> -<span style=" font-weight:600;">Параметры макросов</span>-<span style=" font-weight:600;">Доверять доступ к Visual Basic Project</span></li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:2; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Причем сделать это необходимо на том ПК, на котором будет выполняться код. </span></p>
<li style=" font-family:'MS Shell Dlg 2'; font-size:9pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Изменяемый VBA-проект не должен быть защищен.</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Исключить первое условие программно нельзя. Точнее через VBA не получится изменить данный параметр, т.к. это будет происходить в любом случае при запущенном Excel, а при изменении данного параметра программно необходим перезапуск приложения. Да и изменить параметр возможно лишь через реестр, а не у всех пользователей может быть доступ не только к записи, но и даже к чтению реестра Windows. Зато можно проверить разрешен ли доступ к проектной модели VBA и если запрещен, то уведомить пользователя в необходимости это сделать и приложить инструкции по необходимым действиям.<br />Можно использовать такой код для проверки: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a2a6fcf8ccf3086162378"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">S</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">ub Check_VBOM() Dim oVBProj As Object On Error Resume Next Set oVBProj = ActiveWorkbook.VBProject If Not oVBProj Is Nothing Then MsgBox &quot;Доступ к проектной модели VBA разрешен&quot;, vbInformation Else MsgBox &quot;Доступ к проектной модели VBA запрещен&quot;, vbInformation End If End Sub </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"> Sub Check_VBOM()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Dim oVBProj As Object</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    On Error Resume Next</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Set oVBProj = ActiveWorkbook.VBProject</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    If Not oVBProj Is Nothing Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">        MsgBox &quot;Доступ к проектной модели VBA разрешен&quot;, vbInformation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">        MsgBox &quot;Доступ к проектной модели VBA запрещен&quot;, vbInformation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">End Sub</span></p></td>
<td></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Главное его достоинство в том, что он не требует наличия каких-либо прав доступа к реестру.<br />А кодом ниже можно проверить доступ к объектной модели VBA проекта через реестр Windows, что означает необходимость наличия у пользователя прав доступа как минимум для чтения реестра: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a2a6fcf8ccf9994597274"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">S</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">ub Change_VBOM() Dim objShell As Object, sExVersion As String, lLevel As Long 'Определяем версию Excel и в зависимости от этого определяем ветку реестра sExVersion = Application.Version Set objShell = CreateObject(&quot;WScript.Shell&quot;) lLevel = objShell.RegRead(&quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;) 'Проверяем доступ к объектной модели VBA If lLevel = 0 Then MsgBox &quot;Доступ к проектной модели VBA запрещен&quot;, vbInformation Else MsgBox &quot;Доступ к проектной модели VBA разрешен&quot;, vbInformation End If Set objShell = Nothing End Sub </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"> Sub Change_VBOM()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Dim objShell As Object, sExVersion As String, lLevel As Long</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    'Определяем версию Excel и в зависимости от этого определяем ветку реестра</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    sExVersion = Application.Version</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Set objShell = CreateObject(&quot;WScript.Shell&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    lLevel = objShell.RegRead(&quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    'Проверяем доступ к объектной модели VBA</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    If lLevel = 0 Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">        MsgBox &quot;Доступ к проектной модели VBA запрещен&quot;, vbInformation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">        MsgBox &quot;Доступ к проектной модели VBA разрешен&quot;, vbInformation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Set objShell = Nothing</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">End Sub</span></p></td>
<td></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Если вдруг кому-то захочется поэкспериментировать, то вот код для VB, который меняет доступ программно: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a2a6fcf8ccfe995888116"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">S</span><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">ub Change_VBOM() Dim objExcelApp As Object, objShell As Object, sExVersion As String, lLevel As Long 'Определяем версию Excel и в зависимости от этого определяем ветку реестра Set objExcelApp = CreateObject(&quot;Excel.Application&quot;) sExVersion = objExcelApp.Version: objExcelApp.Quit Set objShell = CreateObject(&quot;WScript.Shell&quot;) lLevel = objShell.RegRead(&quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;) 'Разрешаем доступ к объектной модели VBA 'AccessVBOM - 0 - запрещен доступ; 1 - разрешен If lLevel = 0 Then objShell.RegWrite _ &quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; _ sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;, 1, &quot;REG_DWORD&quot; End If Set objExcelApp = Nothing: Set objShell = Nothing End Sub </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"> Sub Change_VBOM()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Dim objExcelApp As Object, objShell As Object, sExVersion As String, lLevel As Long</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    'Определяем версию Excel и в зависимости от этого определяем ветку реестра</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Set objExcelApp = CreateObject(&quot;Excel.Application&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    sExVersion = objExcelApp.Version: objExcelApp.Quit</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Set objShell = CreateObject(&quot;WScript.Shell&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    lLevel = objShell.RegRead(&quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    'Разрешаем доступ к объектной модели VBA</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    'AccessVBOM - 0 - запрещен доступ; 1 - разрешен</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    If lLevel = 0 Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">        objShell.RegWrite _</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">                &quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; _</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">                sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;, 1, &quot;REG_DWORD&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">    Set objExcelApp = Nothing: Set objShell = Nothing</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#04056a;">End Sub</span></p></td>
<td></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;">Зато снять пароль с проекта VBA можно средствами самого VBA. Об этом я рассказывал в статье </span><a href="http://www.excel-vba.ru/chto-umeet-excel/kak-programmno-snyat-parol-s-vba-proekta/"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; text-decoration: underline; color:#0000ff;">Как программно снять пароль с VBA проекта?</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt;"><br />Других ограничений на программное внесение изменений в проект VBA я пока не нашел.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">'========================================================================================</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">Sub Check_VBOM()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Dim oVBProj As Object</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    On Error Resume Next</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Set oVBProj = ActiveWorkbook.VBProject</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    If Not oVBProj Is Nothing Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">        MsgBox &quot;Доступ к проектной модели VBA разрешен&quot;, vbInformation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">        MsgBox &quot;Доступ к проектной модели VBA запрещен&quot;, vbInformation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">End Sub</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">Sub Check2_VBOM()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Dim objShell As Object, sExVersion As String, lLevel As Long</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    'Определяем версию Excel и в зависимости от этого определяем ветку реестра</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    sExVersion = Application.Version</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Set objShell = CreateObject(&quot;WScript.Shell&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    lLevel = objShell.RegRead(&quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    'Проверяем доступ к объектной модели VBA</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    If lLevel = 0 Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">        MsgBox &quot;Доступ к проектной модели VBA запрещен&quot;, vbInformation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Else</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">        MsgBox &quot;Доступ к проектной модели VBA разрешен&quot;, vbInformation</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Set objShell = Nothing</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">End Sub</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">Sub Change_VBOM()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Dim objExcelApp As Object, objShell As Object, sExVersion As String, lLevel As Long</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    'Определяем версию Excel и в зависимости от этого определяем ветку реестра</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Set objExcelApp = CreateObject(&quot;Excel.Application&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    sExVersion = objExcelApp.Version: objExcelApp.Quit</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Set objShell = CreateObject(&quot;WScript.Shell&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    lLevel = objShell.RegRead(&quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    'Разрешаем доступ к объектной модели VBA</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    'AccessVBOM - 0 - запрещен доступ; 1 - разрешен</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    If lLevel = 0 Then</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">        objShell.RegWrite _</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">                &quot;HKEY_CURRENT_USER\Software\Microsoft\Office\&quot; &amp; _</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">                sExVersion &amp; &quot;\Excel\Security\AccessVBOM&quot;, 1, &quot;REG_DWORD&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    End If</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">    Set objExcelApp = Nothing: Set objShell = Nothing</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:4px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:9pt; color:#0a106a;">End Sub</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:9pt;"><br /></p></body></html>