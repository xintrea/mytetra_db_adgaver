<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Работа с внешними источниками данных Материалы по работе с внешними источниками данных на примере Excel и SQL. Рассмотрим способы передачи данных между Excel и внешней базой данной на SQL сервере с помощью ADO. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Задача первая. Подключаемся к внешней базе данных.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для начала надо подключиться к внешней базе данных. Подключение возможно если на компьютере установлен драйвер. Список установленных драйверов для подключения к базам данных на компьютере под управлением Windows: </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#993300;">Панель управления\Все элементы панели управления\Администрирование\Источники данных (ODBC)</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проверить подключение к базе данных можно простым способом. Создаем пустой файл (например, &quot;текстовый документ.txt&quot;), затем изменяем имя и расширение на .udl (например, &quot;connect.udl&quot;). Двойной клик мышкой по новому файлу, далее приступаете к настройке и проверке подключения к базе данных. После того, как удалось настроить корректное подключение к базе данных, сохраняем файл &quot;connect.udl&quot;. Открываем файл &quot;connect.udl&quot; обычным текстовым редактором (например, блокнотом), и видим в строке подключения все необходимые параметры. Про подключение к внешним базам данных можно посмотреть на ресурсе <a href="http://www.connectionstrings.com"><span style=" text-decoration: underline; color:#0000ff;">ConnectionStrings</span></a> . Теперь возвращаемся к нашему VBA для Excel. В редакторе VBA подключаем последнюю версию библиотеки: </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> Microsoft ActiveX Data Objects Library</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример кода: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Sub</span><span style=" font-family:'Courier New';"> TestConnection()</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> cn </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> ADODB.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> cn = </span><span style=" font-family:'Courier New'; color:#0000ff;">New</span><span style=" font-family:'Courier New';"> ADODB.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.ConnectionString = &quot;&quot; </span><span style=" font-family:'Courier New'; color:#008000;">'Параметры строки подключения</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.Open   </span><span style=" font-family:'Courier New'; color:#008000;">'Открываем подключение</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.Close   </span><span style=" font-family:'Courier New'; color:#008000;">'Закрываем подключение</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> cn = </span><span style=" font-family:'Courier New'; color:#0000ff;">Nothing   </span><span style=" font-family:'Courier New'; color:#008000;">'Стираем объект из памяти</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">End Sub</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Задача вторая. Загружаем данные из внешней базы данных на SQL сервере в Excel.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После того, как мы установили подключение к внешней базе данных можно приступать к чтению данных и выводу в Excel. Здесь потребуется знание языка запросов SQL. В результате выполнения SQL запроса к нам возвращается некая таблица с данными в объект RecordSet. Далее из объекта RecordSet можно выгружать данные непосредственно на лист или в сводную таблицу. Пример кода простой процедуры: </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Sub</span><span style=" font-family:'Courier New';"> LoadData()</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> cn </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> ADODB.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> rst </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> ADODB.Recordset</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> cn = </span><span style=" font-family:'Courier New'; color:#0000ff;">New</span><span style=" font-family:'Courier New';"> ADODB.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> rst = </span><span style=" font-family:'Courier New'; color:#0000ff;">New</span><span style=" font-family:'Courier New';"> ADODB.Recordset</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.ConnectionString = &quot;&quot; </span><span style=" font-family:'Courier New'; color:#008000;">'Параметры строки подключения</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.Open</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">rst.Open &quot;SELECT TOP 10 * FROM &lt;таблица&gt;&quot;, cn </span><span style=" font-family:'Courier New'; color:#008000;">'SQL-запрос, подключение</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#008000;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">ActiveSheet.Range(&quot;A1&quot;).CopyFromRecordset rst </span><span style=" font-family:'Courier New'; color:#008000;">'Извлекаем данные на лист</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#008000;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">rst.Close</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.Close</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> rst = </span><span style=" font-family:'Courier New'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> cn = </span><span style=" font-family:'Courier New'; color:#0000ff;">Nothing</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#0000ff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">End Sub</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для удобства работы. Предлагаю создать собственный класс &quot;tSQL&quot; для работы с базой данных.  У класса будет одно свойство: </p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Public</span><span style=" font-family:'Courier New';"> ConnectionSring </span><span style=" font-family:'Courier New'; color:#0000ff;">As String</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для чтения данных напишем метод SelectFrom с параметрами TableName и ws. TableName - это имя таблицы, откуда будем считывать данные и ws - лист Excel, куда будем записывать данные. </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Public Sub</span><span style=" font-family:'Courier New';"> SelectFrom(TableName </span><span style=" font-family:'Courier New'; color:#0000ff;">As String</span><span style=" font-family:'Courier New';">, ws </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> Worksheet)</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> cn </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> ADODB.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> rst </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> ADODB.Recordset</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> SQLstring </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">String</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> i </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> Long</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> cn = </span><span style=" font-family:'Courier New'; color:#0000ff;">New</span><span style=" font-family:'Courier New';"> ADODB.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> rst = </span><span style=" font-family:'Courier New'; color:#0000ff;">New</span><span style=" font-family:'Courier New';"> ADODB.Recordset</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">SQLstring = &quot;SELECT * FROM &quot; &amp; TableName</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">ws.Cells.Clear</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.ConnectionString = ConnectionSring</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.Open</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">rst.Open SQLstring, cn</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">For</span><span style=" font-family:'Courier New';"> i = 1 </span><span style=" font-family:'Courier New'; color:#0000ff;">To</span><span style=" font-family:'Courier New';"> rst.Fields.Count</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> ws.Cells(1, i) = rst.Fields(i - 1).Name</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Next</span><span style=" font-family:'Courier New';"> i</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">ws.Range(&quot;A2&quot;).CopyFromRecordset rst</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">rst.Close</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.Close</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> rst = </span><span style=" font-family:'Courier New'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> cn = </span><span style=" font-family:'Courier New'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">SQLstring = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">i = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#0000ff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">End Sub</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример использования класса tSQL в процедуре </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Sub</span><span style=" font-family:'Courier New';"> mySQL()</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> ts </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> tSQL</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> ts = </span><span style=" font-family:'Courier New'; color:#0000ff;">New</span><span style=" font-family:'Courier New';"> tSQL</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">ts.ConnectionSring = '&lt;Строка подключения&gt;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">ts.SelectFrom &quot;Название таблицы&quot;, ActiveSheet</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> ts = </span><span style=" font-family:'Courier New'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">End Sub</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Задача третья. Загружаем данные из Excel во внешнюю базу данных.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для записи данных напишем метод InsertInto с параметрами TableName. rHead и rData. TableName - это имя таблицы, куда будем добавлять данные;  rHead - диапазон ячеек, с указанием полей; rData - диапазон ячеек с данными, которые будем добавлять. </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Public Sub</span><span style=" font-family:'Courier New';"> InsertInto(TableName </span><span style=" font-family:'Courier New'; color:#0000ff;">As String</span><span style=" font-family:'Courier New';">, rHead </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> Range, rData </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> Range)</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> cn </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> ADODB.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> SQLstring </span><span style=" font-family:'Courier New'; color:#0000ff;">As String</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> SQLstringH </span><span style=" font-family:'Courier New'; color:#0000ff;">As String</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> SQLstringV </span><span style=" font-family:'Courier New'; color:#0000ff;">As String</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> i </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> Long</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> j </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> Long</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> arrHead()</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> arrData()</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">arrHead = rHead.Value</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">arrData = rData.Value</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> cn = </span><span style=" font-family:'Courier New'; color:#0000ff;">New</span><span style=" font-family:'Courier New';"> ADODB.Connection</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.ConnectionString = ConnectionSring</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.Open</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">SQLstringH = &quot;INSERT INTO &quot; &amp; TableName &amp; &quot;(&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">For</span><span style=" font-family:'Courier New';"> j = </span><span style=" font-family:'Courier New'; color:#0000ff;">LBound</span><span style=" font-family:'Courier New';">(arrHead, 2) </span><span style=" font-family:'Courier New'; color:#0000ff;">To</span><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">UBound</span><span style=" font-family:'Courier New';">(arrHead, 2)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> SQLstringH = SQLstringH &amp; &quot; &quot; &amp; arrHead(1, j)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">If</span><span style=" font-family:'Courier New';"> j &lt; </span><span style=" font-family:'Courier New'; color:#0000ff;">UBound</span><span style=" font-family:'Courier New';">(arrHead, 2) </span><span style=" font-family:'Courier New'; color:#0000ff;">Then</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> SQLstringH = SQLstringH &amp; &quot;,&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> SQLstringH = SQLstringH &amp; &quot;)&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">End If</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Next</span><span style=" font-family:'Courier New';"> j</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">SQLstringH = SQLstringH &amp; &quot; VALUES(&quot;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">For</span><span style=" font-family:'Courier New';"> i = </span><span style=" font-family:'Courier New'; color:#0000ff;">LBound</span><span style=" font-family:'Courier New';">(arrData, 1) </span><span style=" font-family:'Courier New'; color:#0000ff;">To</span><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">UBound</span><span style=" font-family:'Courier New';">(arrData, 1)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">For</span><span style=" font-family:'Courier New';"> j = </span><span style=" font-family:'Courier New'; color:#0000ff;">LBound</span><span style=" font-family:'Courier New';">(arrData, 2) </span><span style=" font-family:'Courier New'; color:#0000ff;">To</span><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">UBound</span><span style=" font-family:'Courier New';">(arrData, 2)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> SQLstringV = SQLstringV &amp; &quot; &quot; &amp; arrData(i, j)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">If</span><span style=" font-family:'Courier New';"> j &lt; </span><span style=" font-family:'Courier New'; color:#0000ff;">UBound</span><span style=" font-family:'Courier New';">(arrHead, 2) </span><span style=" font-family:'Courier New'; color:#0000ff;">Then</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> SQLstringV = SQLstringV &amp; &quot;,&quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">Else</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> SQLstringV = SQLstringV &amp; &quot;) &quot;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">End If</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> </span><span style=" font-family:'Courier New'; color:#0000ff;">Next</span><span style=" font-family:'Courier New';"> j</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> SQLstring = SQLstringH &amp; SQLstringV</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> SQLstringV = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';"> cn.Execute SQLstring</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Next</span><span style=" font-family:'Courier New';"> i</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">cn.Close</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> cn = </span><span style=" font-family:'Courier New'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">SQLstring = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">i = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">j = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">SQLstring = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">SQLstringH = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">SQLstringV = </span><span style=" font-family:'Courier New'; color:#0000ff;">Empty</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Erase</span><span style=" font-family:'Courier New';"> arrHead</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Erase</span><span style=" font-family:'Courier New';"> arrData</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">End Sub</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример использования класса tSQL в процедуре </p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Sub</span><span style=" font-family:'Courier New';"> mySQL()</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Dim</span><span style=" font-family:'Courier New';"> ts </span><span style=" font-family:'Courier New'; color:#0000ff;">As</span><span style=" font-family:'Courier New';"> tSQL</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> ts = </span><span style=" font-family:'Courier New'; color:#0000ff;">New</span><span style=" font-family:'Courier New';"> tSQL</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">ts.ConnectionSring = '&lt;Строка подключения&gt;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">ts.InsertInto &quot;Название таблицы&quot;, Range(&quot;B1:D1&quot;), Range(&quot;B8:D300&quot;)</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#0000ff;">Set</span><span style=" font-family:'Courier New';"> ts = </span><span style=" font-family:'Courier New'; color:#0000ff;">Nothing</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">End Sub</span>   </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Задача четвертая. Управляем внешней базой данных из Excel</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рекомендую использовать запросы в основном для чтения данных из внешней БД. Можно записывать данные в таблицы внешней БД. Но крайне не желательно использовать Excel для управления внешней базой данных, лучше использовать стандартные средства разработки. <br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Полезные ссылки:</span> <a href="https://support.microsoft.com/ru-ru/kb/321686/ru"><span style=" text-decoration: underline; color:#0000ff;">Data from Excel to SQL</span></a><span style=" color:#0000ff;"> </span> <a href="http://www.excel-sql-server.com/excel-sql-server-import-export-using-vba.htm"><span style=" text-decoration: underline; color:#0000ff;"> http://www.excel-sql-server.com/excel-sql-server-import-export-using-vba.htm</span></a></p></body></html>