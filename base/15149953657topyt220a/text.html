<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Видимое значение ячейки в реальное<span style=" font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Часто из всем известной 1С отчеты выгружаются в Excel. Что не удивительно, ведь многие используют 1С как базу ведения всевозможных данных, а анализ предпочитают производить в Excel. И это удобно, это работает. Но часто при получении файла из 1С форматы ячеек изменены так, что отображается в ячейках одно значение, а на деле там значение совершенно иное:<br /></span><img src="image18528.png" /><span style=" font-size:8.25pt;"><br /></span><img src="image4572.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Чтобы не возникло недопонимания, </span><span style=" font-size:8.25pt; font-weight:600;">что это такое на картинках выше</span><span style=" font-size:8.25pt;">. Например, если в ячейку записать число 1077, то оно и отобразится так же. Однако его визуальное отображение в ячейках можно изменить: выделяем ячейку -правая кнопка мыши -</span><span style=" font-size:8.25pt; font-weight:600;">Формат ячеек(Format Cells)</span><span style=" font-size:8.25pt;"> -вкладка </span><span style=" font-size:8.25pt; font-weight:600;">Число(Number)</span><span style=" font-size:8.25pt;">. Далее в списке слева выбрать </span><span style=" font-size:8.25pt; font-weight:600;">Дополнительный(Special)</span><span style=" font-size:8.25pt;"> и установить </span><span style=" font-size:8.25pt; font-weight:600;">Почтовый индекс</span><span style=" font-size:8.25pt;">. Тогда в ячейке визуально будет отображаться 001077, в то время как реально в ячейке будет оставаться все то же число 1077. Тоже и с датами. Реально в ячейке число, а визуально дата в одном из форматов из категории Дата. Подробнее про то, почему так происходит можно прочесть в статье: </span><a href="http://www.excel-vba.ru/chto-umeet-excel/kak-excel-vosprinimaet-dannye/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Как Excel воспринимает данные?</span></a><span style=" font-size:8.25pt;"><br />И как это всегда бывает - порой просто необходимо работать не с тем значением, которое реально в ячейке, а именно с теми, которые отображаются в ячейках. Яркий пример такой необходимости - это сцепление данных двух ячеек, в одной из которых записана дата. Например, в A1 записана дата &quot;06.02.2016&quot;, а в B1 текст вроде &quot;Отчет по магазину за &quot; и необходимо сцепить текст из B1 с датой из A1. Если применить просто функцию </span><span style=" font-size:8.25pt; font-weight:600;">СЦЕПИТЬ(CONCATENATE)</span><span style=" font-size:8.25pt;"> или по простому =B1&amp;A1, то результатом будет такой текст: Отчет по магазину за 42406.<br />Если формат лишь один - можно стандартно попробовать побороть при помощи функции ТЕКСТ(TEXT). Например, в ячейках столбца А записаны даты в формате 31 января 2016г. Тогда формулу можно записать так:<br />=ТЕКСТ(A2;&quot;[$-F800]ДДДД, ММММ ДД, ГГГГ&quot;)<br />=TEXT(A2,&quot;[$-F800]dddd, MMMM yy, yyyy&quot;)<br />На примере той же </span><span style=" font-size:8.25pt; font-weight:600;">СЦЕПИТЬ(CONCATENATE)</span><span style=" font-size:8.25pt;">:<br />=СЦЕПИТЬ(B1;ТЕКСТ(A1;&quot;[$-F800]ДДДД, ММММ ДД, ГГГГ&quot;))<br />=CONCATENATE(B1,TEXT(A2,&quot;[$-F800]dddd, MMMM yy, yyyy&quot;))</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Но если форматы в ячейках различаются и записаны в разнобой...Стандартно этого никак не сделать, кроме как каждую ячейку руками перебивать. Но если прибегнуть к помощи Visual Basic for Applications(VBA), то можно написать простую функцию пользователя(</span><a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-funkciya-polzovatelyaudf/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Что такое функция пользователя(UDF)</span></a><span style=" font-size:8.25pt;">) и применить её: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce7b89169a722303542"></a><span style=" font-size:8.25pt;">F</span><span style=" font-size:8.25pt;">unction VisualVal_Text(rc As Range) VisualVal_Text = rc.Text End Function </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:8.25pt;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">3 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce7b89169a722303542-1"></a><span style=" font-size:8.25pt;">F</span><span style=" font-size:8.25pt;">unction VisualVal_Text(rc As Range)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7b89169a722303542-2"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   VisualVal_Text = rc.Text</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7b89169a722303542-3"></a><span style=" font-size:8.25pt;">E</span><span style=" font-size:8.25pt;">nd Function</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Для применения надо внимательно прочитать про </span><a href="http://www.excel-vba.ru/chto-umeet-excel/chto-takoe-funkciya-polzovatelyaudf/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">создание функций пользователя</span></a><span style=" font-size:8.25pt;">. После этого в ячейку останется записать:<br />=VisualVal_Text(A1)<br />и раскопировать ячейку на весь столбец. После этого можно заменить результат функции значениями(</span><a href="http://www.excel-vba.ru/chto-umeet-excel/kak-udalit-v-yachejke-formulu-ostaviv-znacheniya/"><span style=" font-size:8.25pt; text-decoration: underline; color:#0000ff;">Как удалить в ячейке формулу, оставив значения</span></a><span style=" font-size:8.25pt;">) и все готово. Но и в этой функции есть недостаток. Если в ячейке отображается значение, которое не помещается в границы ячейки, то оно может быть обрезано или вместо значения будут решетки. Например, если дата в указанном формате не помещается в ячейку - вместо значений будут решетки #######:<br /></span><img src="image12862.png" /><span style=" font-size:8.25pt;"><br />и функция VisualVal_Text вернет так же решетки. Это тоже решаемо. Можно либо перед применением расширить столбцы с исходными данными так, чтобы значение отображалось правильно и полностью, либо применить чуть другую функцию пользователя: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce7b8916a6821750697"></a><span style=" font-size:8.25pt;">F</span><span style=" font-size:8.25pt;">unction VisualVal(rc As Range) VisualVal = Application.Text(rc.Value, rc.NumberFormat) End Function </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-size:8.25pt;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><span style=" font-size:8.25pt;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">3 </span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:15px;"><a name="crayon-5a4ce7b8916a6821750697-1"></a><span style=" font-size:8.25pt;">F</span><span style=" font-size:8.25pt;">unction VisualVal(rc As Range)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7b8916a6821750697-2"></a><span style=" font-size:8.25pt;"> </span><span style=" font-size:8.25pt;">   VisualVal = Application.Text(rc.Value, rc.NumberFormat)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="crayon-5a4ce7b8916a6821750697-3"></a><span style=" font-size:8.25pt;">E</span><span style=" font-size:8.25pt;">nd Function</span></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Используется и записывается в ячейку так же, как и предыдущая:<br />=VisualVal(A1)<br />Эта функция без всяких танцев с бубном вернет отображаемое форматом ячейки значение.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">И вариант применения функции вместе с функцией СЦЕПИТЬ:<br />=СЦЕПИТЬ(B1;VisualVal_Text(A1))<br />=CONCATENATE(B1,VisualVal_Text(A1))<br />=СЦЕПИТЬ(B1;VisualVal(A1))<br />=CONCATENATE(B1,VisualVal(A1))<br />Как видно не надо задумываться о том какой применить формат - будет записано так же, как оно отображается в ячейке.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:8.25pt;">Все варианты решений можно посмотреть в примере: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image7619.png" /><span style=" font-size:8.25pt;">  </span><a href="http://www.excel-vba.ru/download/155/"><span style=" font-size:8.25pt; font-weight:600; text-decoration: underline; color:#0000ff;">Tips_Macro_CellValToVisual.xls</span></a><span style=" font-size:8.25pt;"> (48,5 KiB, 316 скачиваний)</span></p></body></html>